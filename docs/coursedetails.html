<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course Details - SkillUp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
:root {
  --primary: #ffffff;
  --primary-dark: #f8f9fa;
  --primary-light: #e9ecef;
  --secondary: #dee2e6;
  --accent: #08d9d6;
  --light: #4361ee;
  --dark: #ffffff;
  --gray: #adb5bd;
  --gray-light: #343a40;
  --success: #00f5ff;
  --card-bg: linear-gradient(135deg, #ffffff, #f8f9fa);
  --sidebar-bg: linear-gradient(180deg, #4361ee, #3a0ca3);
  --bg-main: #1a1d29;
  --bg-secondary: #252937;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
  background: var(--bg-main);
  color: var(--primary);
  overflow-x: hidden;
  transition: all 0.3s ease;
}

/* Loading Animation */
.loading-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--bg-main);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  transition: opacity 0.5s ease;
}

.loading-container.hidden {
  opacity: 0;
  pointer-events: none;
}

.loading-spinner {
  width: 80px;
  height: 80px;
  border: 5px solid rgba(67, 97, 238, 0.3);
  border-radius: 50%;
  border-top-color: var(--success);
  animation: spin 1s ease-in-out infinite;
  margin-bottom: 20px;
}

.loading-text {
  color: var(--primary);
  font-size: 18px;
  font-weight: 500;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Futuristic Grid Animation */
body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: 
    linear-gradient(rgba(67, 97, 238, 0.1) 1px, transparent 1px),
    linear-gradient(90deg, rgba(67, 97, 238, 0.1) 1px, transparent 1px);
  background-size: 50px 50px;
  animation: gridMove 20s linear infinite;
  pointer-events: none;
  z-index: -1;
}

@keyframes gridMove {
  0% { transform: translate(0, 0); }
  100% { transform: translate(50px, 50px); }
}

.dashboard-container {
  display: flex;
  min-height: 100vh;
  position: relative;
}

/* Sidebar */
.sidebar {
  width: 280px;
  background: var(--sidebar-bg);
  color: white;
  height: 100vh;
  position: fixed;
  left: 0;
  top: 0;
  z-index: 1000;
  transform: translateX(-100%);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 5px 0 30px rgba(67, 97, 238, 0.3);
  backdrop-filter: blur(20px);
  border-right: 1px solid rgba(255, 255, 255, 0.1);
}

.sidebar.active {
  transform: translateX(0);
}

.sidebar::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(45deg, rgba(67, 97, 238, 0.1), rgba(58, 12, 163, 0.1));
  animation: sidebarGlow 3s ease-in-out infinite alternate;
}

@keyframes sidebarGlow {
  0% { opacity: 0.5; }
  100% { opacity: 1; }
}

.sidebar-header {
  padding: 25px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  position: relative;
  z-index: 2;
}

.sidebar-header h2 {
  font-size: 24px;
  font-weight: 700;
  background: linear-gradient(45deg, #fff, #00f5ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: textGlow 2s ease-in-out infinite alternate;
}

@keyframes textGlow {
  0% { filter: drop-shadow(0 0 5px rgba(0, 245, 255, 0.5)); }
  100% { filter: drop-shadow(0 0 20px rgba(0, 245, 255, 0.8)); }
}

.close-sidebar {
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.close-sidebar::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: radial-gradient(circle, rgba(0, 245, 255, 0.3), transparent);
  transition: all 0.3s ease;
  border-radius: 50%;
  transform: translate(-50%, -50%);
}

.close-sidebar:hover::before {
  width: 100px;
  height: 100px;
}

.close-sidebar:hover {
  background: rgba(0, 245, 255, 0.2);
  transform: rotate(180deg) scale(1.1);
  box-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
}

.sidebar-menu {
  list-style: none;
  padding: 20px 0;
  flex: 1;
  position: relative;
  z-index: 2;
}

.sidebar-menu li {
  margin-bottom: 5px;
  position: relative;
}

.sidebar-menu a {
  display: flex;
  align-items: center;
  padding: 15px 25px;
  color: rgba(255, 255, 255, 0.85);
  text-decoration: none;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.sidebar-menu a::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  width: 0;
  background: linear-gradient(90deg, rgba(0, 245, 255, 0.3), transparent);
  transition: all 0.3s ease;
}

.sidebar-menu a:hover::before, .sidebar-menu a.active::before {
  width: 100%;
}

.sidebar-menu a:hover, .sidebar-menu a.active {
  color: #00f5ff;
  padding-left: 35px;
  text-shadow: 0 0 10px rgba(0, 245, 255, 0.5);
}

.sidebar-menu i {
  margin-right: 15px;
  font-size: 18px;
  width: 24px;
  text-align: center;
  transition: all 0.3s ease;
}

.sidebar-menu a:hover i {
  transform: scale(1.2);
  filter: drop-shadow(0 0 5px rgba(0, 245, 255, 0.7));
}

/* Logout at bottom */
.sidebar-footer {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 20px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  z-index: 2;
}

.logout-btn {
  width: 100%;
  background: linear-gradient(45deg, #ff4757, #ff3742);
  border: none;
  color: white;
  padding: 12px;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  position: relative;
  overflow: hidden;
}

.logout-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: all 0.5s ease;
}

.logout-btn:hover::before {
  left: 100%;
}

.logout-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(255, 71, 87, 0.4);
}

/* Main Content */
.main-content {
  flex: 1;
  margin-left: 0;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}

.main-content.sidebar-open {
  margin-left: 280px;
}

/* Topbar */
.topbar {
  background: var(--bg-secondary);
  backdrop-filter: blur(20px);
  padding: 0 30px;
  height: 80px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  border-bottom: 1px solid rgba(67, 97, 238, 0.2);
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

.topbar-left {
  display: flex;
  align-items: center;
}

.sidebar-toggle {
  background: linear-gradient(45deg, var(--light), var(--primary-light));
  border: none;
  font-size: 18px;
  color: white;
  cursor: pointer;
  margin-right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 15px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.sidebar-toggle::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: radial-gradient(circle, rgba(255, 255, 255, 0.3), transparent);
  transition: all 0.3s ease;
  border-radius: 50%;
  transform: translate(-50%, -50%);
}

.sidebar-toggle:hover::before {
  width: 100px;
  height: 100px;
}

.sidebar-toggle:hover {
  transform: scale(1.1) rotate(180deg);
  box-shadow: 0 10px 25px rgba(67, 97, 238, 0.4);
}

.topbar-title {
  font-size: 28px;
  font-weight: 700;
  color: var(--primary);
  background: linear-gradient(45deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 15px;
}

.notification-container {
  position: relative;
}

.notification-icon {
  position: relative;
  background: linear-gradient(45deg, var(--light), var(--primary-light));
  border: none;
  color: white;
  width: 45px;
  height: 45px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.notification-icon:hover {
  transform: scale(1.1);
  box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
}

.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  background: #ff4757;
  color: white;
  font-size: 12px;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.avatar {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: linear-gradient(45deg, var(--light), var(--success));
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 18px;
  box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.avatar::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: conic-gradient(transparent, rgba(0, 245, 255, 0.3), transparent);
  animation: rotate 3s linear infinite;
}

@keyframes rotate {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.avatar span {
  position: relative;
  z-index: 2;
}

/* Notification Dropdown */
.notification-dropdown {
  display: none;
  position: absolute;
  top: 70px;
  right: 0;
  background: var(--bg-secondary);
  border-radius: 15px;
  width: 350px;
  max-height: 400px;
  overflow-y: auto;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(67, 97, 238, 0.3);
  z-index: 1000;
}

.notification-dropdown.active {
  display: block;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.notification-header {
  padding: 20px;
  border-bottom: 1px solid rgba(67, 97, 238, 0.3);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notification-header h3 {
  color: var(--primary);
  margin: 0;
}

.notification-clear {
  background: transparent;
  border: none;
  color: var(--success);
  cursor: pointer;
  font-size: 14px;
}

.notification-list {
  padding: 10px 0;
}

.notification-item {
  padding: 15px 20px;
  border-bottom: 1px solid rgba(67, 97, 238, 0.1);
  transition: all 0.3s ease;
  cursor: pointer;
}

.notification-item:hover {
  background: rgba(67, 97, 238, 0.1);
}

.notification-item.unread {
  background: rgba(67, 97, 238, 0.05);
}

.notification-title {
  color: var(--primary);
  font-weight: 600;
  margin-bottom: 5px;
}

.notification-message {
  color: var(--gray);
  font-size: 14px;
  margin-bottom: 5px;
}

.notification-time {
  color: var(--gray-light);
  font-size: 12px;
}

.notification-empty {
  padding: 40px 20px;
  text-align: center;
  color: var(--gray);
}

/* Course Content */
.course-content-area {
  max-width: 1200px;
  margin: 0 auto;
  padding: 30px;
}

/* Course Header */
.course-header {
  background: var(--bg-secondary);
  border-radius: 20px;
  padding: 40px;
  margin-bottom: 30px;
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(67, 97, 238, 0.3);
}

.course-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(45deg, rgba(67, 97, 238, 0.05), rgba(0, 245, 255, 0.05));
  animation: headerGlow 4s ease-in-out infinite alternate;
}

@keyframes headerGlow {
  0% { opacity: 0.3; }
  100% { opacity: 0.7; }
}

.course-name {
  font-size: 36px;
  font-weight: bold;
  color: var(--primary);
  margin-bottom: 20px;
  background: linear-gradient(45deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  position: relative;
  z-index: 2;
}

.course-meta {
  display: flex;
  gap: 30px;
  margin-bottom: 25px;
  flex-wrap: wrap;
  position: relative;
  z-index: 2;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 10px;
  color: var(--gray);
  background: rgba(67, 97, 238, 0.1);
  padding: 10px 15px;
  border-radius: 25px;
  font-size: 14px;
  transition: all 0.3s ease;
}

.meta-item:hover {
  background: rgba(67, 97, 238, 0.2);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(67, 97, 238, 0.2);
}

.meta-item i {
  font-size: 16px;
}

    /* NEW: Lecture completion animation */
    .lecture-completion-animation {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 245, 255, 0.9);
      color: white;
      padding: 20px 30px;
      border-radius: 15px;
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 15px;
      box-shadow: 0 10px 30px rgba(0, 245, 255, 0.5);
      animation: slideInUp 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
    }
    
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translate(-50%, 100%);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }
    
    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
        visibility: hidden;
      }
    }
    
    .completion-icon {
      font-size: 24px;
      animation: pulse 1s infinite;
    }
    
    .completion-text {
      font-weight: 600;
      font-size: 18px;
    }

/* Course Provider and Instructor Section */
.course-providers {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 25px;
  position: relative;
  z-index: 2;
}

.provider-card, .instructor-card-mini {
  background: rgba(67, 97, 238, 0.1);
  border-radius: 15px;
  padding: 20px;
  border: 1px solid rgba(67, 97, 238, 0.2);
  transition: all 0.3s ease;
}

.provider-card:hover,
.instructor-card-mini:hover {
  background: rgba(67, 97, 238, 0.15);
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(67, 97, 238, 0.2);
}

.provider-title, .instructor-title {
  font-size: 14px;
  color: var(--success);
  font-weight: 600;
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.provider-name, .instructor-name-text {
  font-size: 18px;
  color: var(--primary);
  font-weight: 600;
}

.provider-description, .instructor-bio {
  font-size: 14px;
  color: var(--gray);
  margin-top: 8px;
  line-height: 1.4;
}

/* Progress Section */
.progress-section {
  background: rgba(0, 245, 255, 0.1);
  border-radius: 15px;
  padding: 20px;
  position: relative;
  z-index: 2;
  border: 1px solid rgba(0, 245, 255, 0.2);
}

.progress-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-weight: 600;
  color: var(--primary);
}

.progress-bar {
  width: 100%;
  height: 12px;
  background: rgba(67, 97, 238, 0.2);
  border-radius: 10px;
  overflow: hidden;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(45deg, var(--light), var(--success));
  border-radius: 10px;
  transition: width 1s ease;
  position: relative;
  overflow: hidden;
}

.progress-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
  animation: progressShimmer 2s infinite;
}

@keyframes progressShimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

/* NEW: Assignment progress section styling */
.assignments-progress {
  display: flex;
  justify-content: space-between;
  margin: 20px 0;
  padding: 15px;
  background: rgba(67, 97, 238, 0.1);
  border-radius: 10px;
  border: 1px solid rgba(67, 97, 238, 0.3);
}

.progress-item {
  text-align: center;
  flex: 1;
  padding: 10px;
}

.progress-number {
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 5px;
}

.progress-item.completed .progress-number {
  color: var(--success);
}

.progress-item.pending .progress-number {
  color: var(--gray);
}

.progress-label {
  font-size: 14px;
  color: var(--gray);
}

/* Instructor Card */
.instructor-card {
  background: var(--bg-secondary);
  border-radius: 20px;
  padding: 30px;
  margin-bottom: 30px;
  display: flex;
  align-items: center;
  gap: 20px;
  border: 1px solid rgba(67, 97, 238, 0.3);
  position: relative;
  overflow: hidden;
}

.instructor-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(45deg, rgba(67, 97, 238, 0.05), rgba(0, 245, 255, 0.05));
  animation: cardGlow 3s ease-in-out infinite alternate;
}

@keyframes cardGlow {
  0% { opacity: 0.3; }
  100% { opacity: 0.7; }
}

.instructor-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: linear-gradient(45deg, var(--light), var(--success));
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 28px;
  font-weight: bold;
  position: relative;
  z-index: 2;
}

.instructor-name {
  position: relative;
  z-index: 2;
}

.instructor-name h3 {
  color: var(--primary);
  font-size: 24px;
  margin-bottom: 8px;
}

/* Tabs */
.tabs-container {
  background: var(--bg-secondary);
  border-radius: 20px;
  border: 1px solid rgba(67, 97, 238, 0.3);
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
}

.tabs-header {
  display: flex;
  background: rgba(67, 97, 238, 0.1);
  border-bottom: 1px solid rgba(67, 97, 238, 0.2);
}

.tab-button {
  flex: 1;
  padding: 20px;
  border: none;
  background: none;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  position: relative;
  color: var(--gray);
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.tab-button:hover {
  background: rgba(67, 97, 238, 0.1);
  color: var(--primary);
}

.tab-button.active {
  color: var(--success);
  background: var(--bg-secondary);
}

.tab-button.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--light), var(--success));
  border-radius: 3px 3px 0 0;
}

/* Tab Content */
.tab-content {
  display: none;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.3s ease;
  padding: 30px;
  line-height: 1.6;
  min-height: 400px;
}

.tab-content.active {
  display: block;
  opacity: 1;
  transform: translateY(0);
  animation: fadeInUp 0.4s ease;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.tab-content h3 {
  color: var(--primary);
  font-size: 24px;
  margin-bottom: 20px;
  background: linear-gradient(45deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* Curriculum Styles */
.curriculum-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.lecture-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.lecture-item {
  background: rgba(67, 97, 238, 0.1);
  border-radius: 15px;
  overflow: hidden;
  transition: all 0.3s ease;
  border: 1px solid rgba(67, 97, 238, 0.2);
}

.lecture-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(67, 97, 238, 0.2);
}

.lecture-item.completed {
  border-left: 4px solid var(--success);
  background: rgba(0, 245, 255, 0.1);
}

.lesson-header {
  padding: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 15px;
  transition: all 0.3s ease;
}

.lesson-header:hover {
  background: rgba(67, 97, 238, 0.1);
}

.lesson-status {
  font-size: 24px;
  font-weight: bold;
  width: 30px;
  text-align: center;
}

.lecture-item.completed .lesson-status {
  color: var(--success);
}

.lecture-item:not(.completed) .lesson-status {
  color: var(--gray);
}

.lesson-info {
  flex: 1;
}

.lesson-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--primary);
  margin-bottom: 5px;
}

.lesson-duration {
  font-size: 14px;
  color: var(--gray);
}

.expand-icon {
  transition: transform 0.3s ease;
  color: var(--gray);
  font-size: 16px;
}

.lecture-item.expanded .expand-icon {
  transform: rotate(180deg);
}

.lesson-content {
  max-height: 0;
  overflow: hidden;
  transition: all 0.3s ease;
}

.lecture-item.expanded .lesson-content {
  max-height: 500px;
  padding: 0 20px 20px 20px;
}

.lesson-description {
  color: var(--gray);
  line-height: 1.6;
  margin-bottom: 20px;
}

.lesson-actions {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}

.btn-play, .btn-start, .btn-take-test {
  padding: 12px 20px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.btn-play {
  background: linear-gradient(45deg, var(--light), var(--success));
  color: white;
}

.btn-start {
  background: linear-gradient(45deg, var(--light), var(--success));
  color: white;
}

.btn-take-test {
  background: linear-gradient(45deg, var(--light), var(--success));
  color: white;
}

.btn-play:hover, .btn-start:hover, .btn-take-test:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(67, 97, 238, 0.3);
}

/* Assignment-specific styles */
.assignment-item {
  background: rgba(255, 193, 7, 0.1);
  border-radius: 15px;
  overflow: hidden;
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 193, 7, 0.3);
  margin-top: 15px;
}

.assignment-item.locked {
  background: rgba(108, 117, 125, 0.1);
  border: 1px solid rgba(108, 117, 125, 0.3);
  opacity: 0.7;
}

.assignment-item.pending {
  background: rgba(255, 193, 7, 0.1);
  border-left: 4px solid #ffc107;
}

.assignment-item.completed {
  background: rgba(0, 245, 255, 0.1);
  border-left: 4px solid var(--success);
}

.assignment-item.evaluated {
  background: rgba(40, 167, 69, 0.1);
  border-left: 4px solid #28a745;
}

.assignment-header {
  padding: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 15px;
  transition: all 0.3s ease;
}

.assignment-header:hover {
  background: rgba(255, 193, 7, 0.1);
}

.assignment-status {
  font-size: 24px;
  font-weight: bold;
  width: 30px;
  text-align: center;
}

.assignment-item.locked .assignment-status {
  color: var(--gray);
}

.assignment-item.pending .assignment-status {
  color: #ffc107;
}

.assignment-item.completed .assignment-status {
  color: var(--success);
}

.assignment-item.evaluated .assignment-status {
  color: #28a745;
}

.assignment-info {
  flex: 1;
}

.assignment-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--primary);
  margin-bottom: 5px;
}

.assignment-details {
  font-size: 14px;
  color: var(--gray);
}

.assignment-content {
  max-height: 0;
  overflow: hidden;
  transition: all 0.3s ease;
}

.assignment-item.expanded .assignment-content {
  max-height: 1000px;
  padding: 0 20px 20px 20px;
}

.assignment-description {
  color: var(--gray);
  line-height: 1.6;
  margin-bottom: 20px;
}

.assignment-actions {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}

.btn-submit, .btn-view-assignment {
  padding: 12px 20px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.btn-submit {
  background: linear-gradient(45deg, #ffc107, #ffb300);
  color: white;
}

.btn-view-assignment {
  background: linear-gradient(45deg, #4bb71b, #28a745);
  color: white;
}

.btn-submit:hover, .btn-view-assignment:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(67, 97, 238, 0.3);
}

.assignment-requirements {
  background: rgba(255, 193, 7, 0.1);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
}

.assignment-requirements h4 {
  color: #ffc107;
  margin-bottom: 10px;
}

.assignment-requirements ul {
  padding-left: 20px;
  color: var(--gray);
}

.assignment-requirements li {
  margin-bottom: 8px;
}

.assignment-submission {
  background: rgba(67, 97, 238, 0.1);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
}

.assignment-submission h4 {
  color: var(--success);
  margin-bottom: 10px;
}

.submission-form {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.form-group label {
  color: var(--primary);
  font-weight: 500;
}

.form-group input, .form-group textarea, .form-group select {
  background: var(--bg-main);
  border: 1px solid rgba(67, 97, 238, 0.3);
  border-radius: 8px;
  padding: 12px;
  color: var(--primary);
  font-size: 14px;
}

.form-group textarea {
  min-height: 120px;
  resize: vertical;
}

.file-upload {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.file-input {
  display: none;
}

.file-label {
  background: rgba(67, 97, 238, 0.1);
  border: 2px dashed rgba(67, 97, 238, 0.3);
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
}

.file-label:hover {
  background: rgba(67, 97, 238, 0.2);
  border-color: rgba(67, 97, 238, 0.5);
}

.file-name {
  margin-top: 10px;
  color: var(--gray);
  font-size: 14px;
}

.evaluation-status {
  background: rgba(40, 167, 69, 0.1);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
}

.evaluation-status h4 {
  color: #28a745;
  margin-bottom: 10px;
}

.evaluation-details {
  color: var(--gray);
  line-height: 1.6;
}

.grade {
  font-size: 24px;
  font-weight: bold;
  color: #28a745;
  margin: 10px 0;
}

.feedback {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  padding: 15px;
  margin-top: 10px;
}

/* NEW: Video Player Popup Modal */
.video-player-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.video-player-modal.active {
  display: flex;
  animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.video-player-modal-content {
  background: var(--bg-secondary);
  border-radius: 15px;
  width: 90%;
  max-width: 1000px;
  max-height: 100vh;
  overflow: hidden;
  position: relative;
  border: 1px solid rgba(67, 97, 238, 0.3);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  animation: contentSlideIn 0.3s ease-out;
}

@keyframes contentSlideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.video-player-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  background: rgba(0, 0, 0, 0.5);
  border-bottom: 1px solid rgba(67, 97, 238, 0.3);
}

.video-player-modal-title {
  font-size: 20px;
  color: var(--primary);
  font-weight: 600;
}

.close-video-modal {
  background: none;
  border: none;
  color: var(--gray);
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s ease;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-video-modal:hover {
  color: var(--success);
  background: rgba(255, 255, 255, 0.1);
  transform: rotate(90deg);
}

.video-player-container {
  width: 100%;
  background: #000;
  position: relative;
  padding-bottom: 56.25%; /* 16:9 aspect ratio */
  height: 0;
}

.video-player-container video {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  display: block;
  object-fit: contain;
}

.video-player-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: rgba(0, 0, 0, 0.7);
  border-top: 1px solid rgba(67, 97, 238, 0.3);
}

.video-player-controls button {
  background: linear-gradient(45deg, var(--light), var(--success));
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.video-player-controls button:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
}

.video-player-status {
  color: var(--gray);
  font-size: 14px;
  flex: 1;
  text-align: center;
}

/* Final Test Section Styles */
    .final-test-section {
      background: rgba(220, 53, 69, 0.1);
      border-radius: 15px;
      padding: 25px;
      margin-top: 30px;
      border: 1px solid rgba(220, 53, 69, 0.3);
      text-align: center;
      transition: all 0.3s ease;
    }

    .final-test-section.locked {
      opacity: 0.7;
      pointer-events: none;
    }

    .final-test-section.unlocked {
      background: rgba(0, 245, 255, 0.1);
      border: 1px solid rgba(0, 245, 255, 0.3);
    }

    .final-test-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .final-test-section.locked .final-test-icon {
      color: #dc3545;
    }

    .final-test-section.unlocked .final-test-icon {
      color: var(--success);
    }

    .final-test-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .final-test-description {
      color: var(--gray);
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .btn-take-test {
      background: linear-gradient(45deg, #dc3545, #c82333);
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .final-test-section.unlocked .btn-take-test {
      background: linear-gradient(45deg, var(--light), var(--success));
    }

    .btn-take-test:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(67, 97, 238, 0.3);
    }

    .btn-take-test:disabled {
      background: var(--gray);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }


/* Resources Grid */
.resources-grid {
  display: flex;
  flex-direction: column;
  gap: 25px;
}

.resource-section {
  background: rgba(67, 97, 238, 0.05);
  border-radius: 15px;
  padding: 25px;
  border: 1px solid rgba(67, 97, 238, 0.2);
}

.section-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid rgba(67, 97, 238, 0.2);
}

.section-header h3 {
  font-size: 20px;
  color: var(--primary);
  margin: 0;
}

.lock-icon {
  color: #ff4757;
  font-size: 18px;
}

.resource-item {
  background: var(--bg-secondary);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: all 0.3s ease;
  border: 1px solid rgba(67, 97, 238, 0.2);
}

.resource-item:hover {
  transform: translateX(5px);
  box-shadow: 0 5px 15px rgba(67, 97, 238, 0.2);
}

.resource-icon {
  font-size: 24px;
  margin-right: 15px;
  color: var(--success);
}

.resource-info {
  flex: 1;
}

.resource-info h4 {
  color: var(--primary);
  margin-bottom: 8px;
  font-size: 16px;
}

.resource-info p {
  color: var(--gray);
  font-size: 14px;
  margin-bottom: 5px;
}

.resource-info small {
  color: var(--gray-light);
  font-size: 12px;
}

.btn-view, .btn-download {
  background: linear-gradient(45deg, var(--light), var(--success));
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-block;
}

.btn-view:hover, .btn-download:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
}

/* Footer */
.footer {
  background: var(--bg-secondary);
  border-top: 1px solid rgba(67, 97, 238, 0.2);
  margin-top: 50px;
  padding: 30px 0;
  text-align: center;
  color: var(--gray);
}

/* Logout Confirmation Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 2000;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: var(--bg-secondary);
  border-radius: 20px;
  width: 90%;
  max-width: 400px;
  padding: 30px;
  position: relative;
  border: 1px solid rgba(67, 97, 238, 0.3);
  text-align: center;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-title {
  font-size: 24px;
  color: var(--primary);
  background: linear-gradient(45deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.close-modal {
  background: none;
  border: none;
  color: var(--gray);
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.close-modal:hover {
  color: var(--success);
  transform: rotate(90deg);
}

.logout-icon {
  font-size: 60px;
  color: #ff4757;
  margin: 20px 0;
  animation: pulse 2s infinite;
}

.logout-text {
  color: var(--primary);
  font-size: 18px;
  margin-bottom: 30px;
}

.logout-actions {
  display: flex;
  gap: 15px;
  justify-content: center;
}

.btn {
  padding: 12px 20px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  min-width: 120px;
}

.btn-secondary {
  background: transparent;
  color: var(--primary);
  border: 2px solid rgba(67, 97, 238, 0.3);
}

.btn-danger {
  background: linear-gradient(45deg, #ff4757, #ff3742);
  color: white;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
}

/* Test Modal */
.test-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.test-modal.active {
  display: flex;
}

.test-modal-content {
  background: var(--bg-secondary);
  border-radius: 20px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 30px;
  position: relative;
  border: 1px solid rgba(67, 97, 238, 0.3);
}

.test-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid rgba(67, 97, 238, 0.3);
}

.test-modal-title {
  font-size: 24px;
  color: var(--primary);
  background: linear-gradient(45deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.close-test-modal {
  background: none;
  border: none;
  color: var(--gray);
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.close-test-modal:hover {
  color: var(--success);
  transform: rotate(90deg);
}

.question-container {
  margin-bottom: 25px;
  padding: 20px;
  background: rgba(67, 97, 238, 0.05);
  border-radius: 15px;
}

.question-text {
  font-size: 18px;
  color: var(--primary);
  margin-bottom: 15px;
}

.options-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.option-item {
  padding: 12px 15px;
  background: rgba(67, 97, 238, 0.05);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid transparent;
}

.option-item:hover {
  background: rgba(67, 97, 238, 0.1);
}

.option-item.selected {
  background: rgba(0, 245, 255, 0.1);
  border-color: var(--success);
}

.test-submit-btn {
  width: 100%;
  background: linear-gradient(45deg, var(--light), var(--success));
  color: white;
  padding: 15px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  margin-top: 20px;
}

.test-submit-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(67, 97, 238, 0.3);
}

/* Certificate Modal */
.certificate-modal-content {
  background: var(--bg-secondary);
  border-radius: 20px;
  width: 95%;
  max-width: 1200px;
  max-height: 95vh;
  overflow-y: auto;
  padding: 30px;
  position: relative;
  border: 1px solid rgba(67, 97, 238, 0.3);
}

.certificate-container {
  background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%);
  padding: 40px 50px;
  border-radius: 15px;
  color: #1a202c;
  text-align: center;
  box-shadow: 0 25px 80px rgba(0, 0, 0, 0.15);
  border: 15px solid #4361ee;
  position: relative;
  overflow: hidden;
  max-height: 750px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  font-family: 'Georgia', serif;
  margin: 0 auto;
}

/* Certificate Border Decoration */
.certificate-container::before {
  content: '';
  position: absolute;
  top: 20px;
  left: 20px;
  right: 20px;
  bottom: 20px;
  border: 2px solid #4361ee;
  border-radius: 10px;
  pointer-events: none;
}

/* Decorative Corner Elements */
.certificate-container::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: 
    radial-gradient(circle at 20% 80%, rgba(67, 97, 238, 0.03) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(0, 245, 255, 0.03) 0%, transparent 50%);
  pointer-events: none;
}

.certificate-header {
  margin-bottom: 20px;
  position: relative;
  z-index: 2;
}

.certificate-logo {
  font-size: 32px;
  font-weight: 700;
  color: #4361ee;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  letter-spacing: 2px;
}

.certificate-logo i {
  color: #4361ee;
  font-size: 28px;
}

.certificate-title {
  font-size: 42px;
  font-weight: 700;
  color: #1a202c;
  margin: 15px 0;
  text-transform: uppercase;
  letter-spacing: 3px;
  background: linear-gradient(135deg, #4361ee, #3a0ca3);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  position: relative;
  font-family: 'Georgia', serif;
}

.certificate-title::after {
  content: '';
  position: absolute;
  bottom: -10px;
  left: 50%;
  transform: translateX(-50%);
  width: 120px;
  height: 3px;
  background: linear-gradient(90deg, #4361ee, #3a0ca3);
  border-radius: 2px;
}

.certificate-subtitle {
  font-size: 16px;
  color: #4a5568;
  font-weight: 500;
  margin-bottom: 8px;
  letter-spacing: 1.2px;
  text-transform: uppercase;
}

.certificate-body {
  margin: 20px 0;
  position: relative;
  z-index: 2;
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.certificate-student-name {
  font-size: 44px;
  font-weight: 700;
  color: #1a202c;
  margin: 15px 0;
  background: linear-gradient(135deg, #1a202c, #4361ee);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-family: 'Georgia', serif;
  letter-spacing: 1px;
  text-decoration: underline;
  text-decoration-color: #4361ee;
  text-underline-offset: 8px;
}

.certificate-course-name {
  font-size: 26px;
  color: #4361ee;
  font-weight: 600;
  margin: 15px 0;
  line-height: 1.4;
  font-style: italic;
  font-family: 'Georgia', serif;
}

.certificate-text {
  font-size: 15px;
  color: #2d3748;
  margin: 12px 0;
  line-height: 1.6;
  max-width: 850px;
  margin-left: auto;
  margin-right: auto;
}

.certificate-details {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 25px;
  margin: 25px 0;
  padding: 20px;
  background: rgba(67, 97, 238, 0.05);
  border-radius: 12px;
  border: 2px solid rgba(67, 97, 238, 0.15);
}

.detail-item {
  text-align: center;
  padding: 10px;
}

.detail-label {
  font-size: 13px;
  color: #4a5568;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  margin-bottom: 8px;
  font-weight: 700;
}

.detail-value {
  font-size: 17px;
  color: #1a202c;
  font-weight: 700;
  word-break: break-all;
}

.certificate-footer {
  display: flex;
  justify-content: space-around;
  align-items: flex-end;
  margin-top: 25px;
  position: relative;
  z-index: 2;
  padding: 0 40px;
}

.certificate-signature {
  text-align: center;
  flex: 1;
}

.signature-image {
  height: 60px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.signature-image i {
  font-size: 50px;
  color: #4361ee;
  opacity: 0.9;
}

.signature-line {
  width: 180px;
  height: 2px;
  background: #1a202c;
  margin: 0 auto 10px;
  position: relative;
}

.signature-line::before {
  content: '';
  position: absolute;
  top: -2px;
  left: 0;
  right: 0;
  height: 6px;
  background: linear-gradient(90deg, transparent, #4361ee, transparent);
  border-radius: 4px;
}

.signature-name {
  font-weight: 700;
  margin-bottom: 5px;
  color: #1a202c;
  font-size: 17px;
  font-family: 'Georgia', serif;
}

.signature-title {
  font-size: 13px;
  color: #4a5568;
  text-transform: uppercase;
  letter-spacing: 1.2px;
  font-weight: 600;
}

.certificate-actions {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
  gap: 15px;
  justify-content: center;
  margin-top: 20px;
  padding: 20px;
  background: transparent;
}

.certificate-download-btn,
.certificate-print-btn {
  display: inline-flex !important;
  visibility: visible !important;
  opacity: 1 !important;
  background: linear-gradient(45deg, #4361ee, #3a0ca3);
  color: white;
  border: none;
  padding: 12px 25px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  text-decoration: none;
  align-items: center;
  gap: 8px;
  box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
}

.certificate-print-btn {
  background: linear-gradient(135deg, #48bb78, #38a169);
  box-shadow: 0 5px 20px rgba(72, 187, 120, 0.3);
}

.certificate-download-btn:hover,
.certificate-print-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 30px rgba(67, 97, 238, 0.4);
}

.certificate-print-btn:hover {
  box-shadow: 0 8px 30px rgba(72, 187, 120, 0.4);
}

/* Certificate Seal */
.certificate-seal {
  position: absolute;
  top: 40px;
  right: 40px;
  width: 100px;
  height: 100px;
  background: linear-gradient(135deg, #4361ee, #3a0ca3);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  font-weight: 700;
  text-align: center;
  border: 4px solid white;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
  z-index: 3;
}

.certificate-seal::before {
  content: '';
  position: absolute;
  top: 6px;
  left: 6px;
  right: 6px;
  bottom: 6px;
  border: 2px solid rgba(255, 255, 255, 0.4);
  border-radius: 50%;
}

/* Responsive Design for Certificate */
@media (max-width: 768px) {
  .certificate-modal-content {
    padding: 15px;
  }

  .certificate-container {
    padding: 30px 25px;
    border: 10px solid #4361ee;
    max-height: none;
  }

  .certificate-container::before {
    top: 12px;
    left: 12px;
    right: 12px;
    bottom: 12px;
  }

  .certificate-title {
    font-size: 32px;
    letter-spacing: 2px;
  }

  .certificate-student-name {
    font-size: 34px;
  }

  .certificate-course-name {
    font-size: 22px;
  }

  .certificate-text {
    font-size: 14px;
  }

  .certificate-details {
    grid-template-columns: 1fr;
    gap: 15px;
    padding: 15px;
  }

  .certificate-footer {
    flex-direction: column;
    gap: 20px;
    padding: 0 15px;
  }

  .certificate-seal {
    position: relative;
    top: auto;
    right: auto;
    margin: 0 auto 15px;
    width: 90px;
    height: 90px;
    font-size: 11px;
  }

  .certificate-actions {
    flex-direction: column;
    gap: 12px;
  }

  .certificate-download-btn,
  .certificate-print-btn {
    width: 100%;
    justify-content: center;
    padding: 12px 25px;
    font-size: 15px;
  }
}

@media (max-width: 480px) {
  .certificate-container {
    padding: 25px 20px;
  }

  .certificate-logo {
    font-size: 26px;
  }

  .certificate-title {
    font-size: 28px;
  }

  .certificate-student-name {
    font-size: 28px;
  }

  .certificate-course-name {
    font-size: 18px;
  }

  .certificate-text {
    font-size: 13px;
  }

  .detail-label {
    font-size: 11px;
  }

  .detail-value {
    font-size: 14px;
  }
}

/* Print Styles for Certificate - ONLY CERTIFICATE, NO BUTTONS */
@media print {
  body * {
    visibility: hidden;
  }
  
  .certificate-modal,
  .certificate-modal * {
    visibility: visible;
  }
  
  .certificate-modal {
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .certificate-modal-content {
    box-shadow: none;
    border: none;
    max-width: 100%;
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .certificate-container {
    box-shadow: none;
    border: 15px solid #4361ee !important;
    margin: 0;
    padding: 40px 50px;
    page-break-after: avoid;
    page-break-inside: avoid;
    max-height: none;
    width: 100%;
    max-width: 900px;
  }
  
  .certificate-actions,
  .modal-header {
    display: none !important;
    visibility: hidden !important;
  }

  /* Ensure all colors print correctly */
  .certificate-container,
  .certificate-title,
  .certificate-student-name,
  .certificate-course-name,
  .certificate-seal,
  .signature-line,
  .certificate-details {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }

  /* Force background colors to print */
  * {
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
}
/* Success Animation */
.success-animation {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  padding: 40px;
  text-align: center;
}

.checkmark {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: block;
  stroke-width: 2;
  stroke: #4bb71b;
  stroke-miterlimit: 10;
  margin: 20px auto;
  box-shadow: inset 0px 0px 0px #4bb71b;
  animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
}

.checkmark__circle {
  stroke-dasharray: 166;
  stroke-dashoffset: 166;
  stroke-width: 2;
  stroke-miterlimit: 10;
  stroke: #4bb71b;
  fill: none;
  animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
}

.checkmark__check {
  transform-origin: 50% 50%;
  stroke-dasharray: 48;
  stroke-dashoffset: 48;
  animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
}

@keyframes stroke {
  100% {
    stroke-dashoffset: 0;
  }
}

@keyframes scale {
  0%, 100% {
    transform: none;
  }
  50% {
    transform: scale3d(1.1, 1.1, 1);
  }
}

@keyframes fill {
  100% {
    box-shadow: inset 0px 0px 0px 30px #4bb71b;
  }
}

/* Assignment and Test Specific Styles */
.assignment-question {
  margin-bottom: 30px;
  padding: 20px;
  background: rgba(67, 97, 238, 0.05);
  border-radius: 10px;
  border: 1px solid rgba(67, 97, 238, 0.2);
}

.assignment-question-title {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 15px;
  color: var(--primary);
}

.assignment-question-description {
  color: var(--gray);
  margin-bottom: 15px;
}

.assignment-points {
  font-size: 14px;
  color: var(--success);
  margin-bottom: 15px;
}

.question-type {
  margin-bottom: 20px;
}

.question-type-label {
  font-weight: bold;
  margin-bottom: 10px;
  color: var(--success);
}

.single-choice-options, .multiple-choice-options {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.option-item {
  padding: 12px 15px;
  background: rgba(67, 97, 238, 0.05);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid transparent;
  display: flex;
  align-items: center;
}

.option-item:hover {
  background: rgba(67, 97, 238, 0.1);
}

.option-item.selected {
  background: rgba(0, 245, 255, 0.1);
  border-color: var(--success);
}

.option-checkbox, .option-radio {
  margin-right: 10px;
  width: 18px;
  height: 18px;
}

.paragraph-answer {
  width: 100%;
  min-height: 150px;
  padding: 15px;
  background: var(--bg-main);
  border: 1px solid rgba(67, 97, 238, 0.3);
  border-radius: 8px;
  color: var(--primary);
  font-size: 14px;
  resize: vertical;
  font-family: inherit;
}

.code-answer {
  width: 100%;
  min-height: 200px;
  padding: 15px;
  background: var(--bg-main);
  border: 1px solid rgba(67, 97, 238, 0.3);
  border-radius: 8px;
  color: var(--primary);
  font-size: 14px;
  resize: vertical;
  font-family: 'Courier New', monospace;
}

.file-upload-area {
  border: 2px dashed rgba(67, 97, 238, 0.3);
  border-radius: 8px;
  padding: 30px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-bottom: 15px;
}

.file-upload-area:hover {
  border-color: var(--success);
  background: rgba(67, 97, 238, 0.05);
}

.file-upload-area i {
  font-size: 48px;
  color: var(--success);
  margin-bottom: 15px;
}

.file-input {
  display: none;
}

.file-name {
  margin-top: 10px;
  color: var(--gray);
  font-size: 14px;
}

.assignment-navigation {
  display: flex;
  justify-content: space-between;
  margin-top: 30px;
  padding-top: 20px;
  border-top: 1px solid rgba(67, 97, 238, 0.3);
}

.assignment-progress {
  text-align: center;
  margin-bottom: 20px;
  color: var(--gray);
  font-size: 16px;
  font-weight: 600;
}

   /* Test Timer */
    .test-timer {
      position: sticky;
      top: 80px;
      background: rgba(220, 53, 69, 0.2);
      color: #ff6b6b;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 20px;
      z-index: 10;
      border: 1px solid rgba(220, 53, 69, 0.3);
    }

    .test-timer.warning {
      background: rgba(255, 193, 7, 0.2);
      color: #ffd166;
      border-color: rgba(255, 193, 7, 0.3);
    }

    .test-timer.critical {
      background: rgba(220, 53, 69, 0.3);
      color: #ff6b6b;
      animation: pulse 1s infinite;
      border-color: rgba(220, 53, 69, 0.5);
    }

    /* Test Question Styles */
    .test-question {
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(67, 97, 238, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(67, 97, 238, 0.2);
    }

    .test-question-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: var(--primary);
    }

    .test-question-description {
      color: var(--gray);
      margin-bottom: 15px;
    }

    .test-question-points {
      font-size: 14px;
      color: var(--success);
      margin-bottom: 15px;
    }

    .test-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .test-option {
      padding: 12px 15px;
      background: rgba(67, 97, 238, 0.05);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
      display: flex;
      align-items: center;
    }

    .test-option:hover {
      background: rgba(67, 97, 238, 0.1);
    }

    .test-option.selected {
      background: rgba(0, 245, 255, 0.1);
      border-color: var(--success);
    }

    .test-option input[type="radio"],
    .test-option input[type="checkbox"] {
      margin-right: 10px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .test-option label {
      cursor: pointer;
      flex: 1;
    }

    /* Test Navigation */
    .test-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid rgba(67, 97, 238, 0.3);
    }

    .test-progress {
      text-align: center;
      margin-bottom: 20px;
      color: var(--gray);
      font-size: 16px;
      font-weight: 600;
    }

    /* Test Results */
    .test-results {
      text-align: center;
      padding: 30px;
    }

    .test-score {
      font-size: 48px;
      font-weight: bold;
      margin: 20px 0;
      background: linear-gradient(45deg, var(--primary), var(--success));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .test-status {
      font-size: 24px;
      margin-bottom: 20px;
    }

    .test-status.passed {
      color: var(--success);
    }

    .test-status.failed {
      color: #ff4757;
    }

    .test-feedback {
      background: rgba(67, 97, 238, 0.1);
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      text-align: left;
    }

    .test-feedback h4 {
      color: var(--primary);
      margin-bottom: 10px;
    }

    /* Test Restrictions Modal */
    .test-warning-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .test-warning-modal.active {
      display: flex;
    }

    .test-warning-modal-content {
      background: var(--bg-secondary);
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      padding: 30px;
      position: relative;
      border: 1px solid rgba(67, 97, 238, 0.3);
      text-align: center;
    }

    .test-warning-icon {
      font-size: 60px;
      color: #ffc107;
      margin: 20px 0;
      animation: pulse 2s infinite;
    }

    .test-warning-title {
      font-size: 24px;
      color: var(--primary);
      margin-bottom: 15px;
    }

    .test-warning-text {
      color: var(--primary);
      font-size: 18px;
      margin-bottom: 25px;
    }

    .test-warning-attempts {
      color: #ffc107;
      font-weight: bold;
      font-size: 20px;
      margin: 10px 0;
    }

    .test-warning-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }

/* Question Review */
.question-review {
  margin-bottom: 30px;
  padding: 20px;
  background: rgba(67, 97, 238, 0.05);
  border-radius: 10px;
  border: 1px solid rgba(67, 97, 238, 0.2);
}

.question-review.correct {
  border-left: 4px solid var(--success);
}

.question-review.incorrect {
  border-left: 4px solid #ff4757;
}

.review-question {
  font-weight: bold;
  margin-bottom: 10px;
}

.user-answer, .correct-answer {
  margin: 5px 0;
}

.user-answer.correct {
  color: var(--success);
}

.user-answer.incorrect {
  color: #ff4757;
}

.correct-answer {
  color: var(--success);
}

/* Assignment Status */
.assignment-status-badge {
  display: inline-block;
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
  margin-left: 10px;
}

.status-not-started {
  background: rgba(108, 117, 125, 0.2);
  color: var(--gray);
}

.status-in-progress {
  background: rgba(255, 193, 7, 0.2);
  color: #ffc107;
}

.status-submitted {
  background: rgba(0, 245, 255, 0.2);
  color: var(--success);
}

.status-evaluated {
  background: rgba(40, 167, 69, 0.2);
  color: #28a745;
}

/* Assignment Instructions */
.assignment-instructions {
  background: rgba(67, 97, 238, 0.1);
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
}

.assignment-instructions h4 {
  color: var(--primary);
  margin-bottom: 10px;
}

.assignment-instructions ul {
  padding-left: 20px;
  color: var(--gray);
}

.assignment-instructions li {
  margin-bottom: 8px;
}

/* Enrollment info and count */
.enrollment-info, .enrollment-count {
  display: inline-block;
  background: rgba(0, 245, 255, 0.1);
  color: var(--success);
  padding: 8px 15px;
  border-radius: 20px;
  font-size: 14px;
  margin: 10px 10px 0 0;
  border: 1px solid rgba(0, 245, 255, 0.2);
}

/* Notification styles */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(45deg, var(--light), var(--success));
  color: white;
  padding: 15px 25px;
  border-radius: 10px;
  z-index: 1001;
  font-weight: 500;
  box-shadow: 0 10px 25px rgba(67, 97, 238, 0.3);
  animation: slideInRight 0.3s ease;
}

.notification.error {
  background: linear-gradient(45deg, #ff4757, #ff3742);
}

@keyframes slideInRight {
  from {
    opacity: 0;
    transform: translateX(100%);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* Additional CSS for ripple effect */
.ripple {
  position: absolute;
  background: rgba(255, 255, 255, 0.6);
  border-radius: 50%;
  pointer-events: none;
  transform: scale(0);
  animation: ripple-animation 0.6s linear;
  z-index: 1;
}

@keyframes ripple-animation {
  to {
    transform: scale(4);
    opacity: 0;
  }
}

/* Button positioning for ripple */
.btn-play, .btn-start, .btn-send, .btn-view, .btn-download, .btn-submit, .btn-view-assignment {
  position: relative;
  overflow: hidden;
}

/* Custom scrollbar for discussion */
.comments-list::-webkit-scrollbar {
  width: 8px;
}

.comments-list::-webkit-scrollbar-track {
  background: rgba(67, 97, 238, 0.1);
  border-radius: 10px;
}

.comments-list::-webkit-scrollbar-thumb {
  background: linear-gradient(45deg, var(--light), var(--success));
  border-radius: 10px;
}

.comments-list::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(45deg, var(--success), var(--light));
}

/* Loading animation */
@keyframes shimmer {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
}

.loading {
  background: linear-gradient(90deg, rgba(67, 97, 238, 0.1) 25%, rgba(0, 245, 255, 0.1) 50%, rgba(67, 97, 238, 0.1) 75%);
  background-size: 200% 100%;
  animation: shimmer 2s infinite linear;
}

/* Glowing border animation */
@keyframes glow {
  0% {
    box-shadow: 0 0 5px rgba(67, 97, 238, 0.3);
  }
  50% {
    box-shadow: 0 0 20px rgba(0, 245, 255, 0.5);
  }
  100% {
    box-shadow: 0 0 5px rgba(67, 97, 238, 0.3);
  }
}

.course-header:hover {
  animation: glow 2s ease-in-out infinite;
}

/* Focus states for accessibility */
.tab-button:focus,
.btn-play:focus,
.btn-start:focus,
.btn-send:focus,
.btn-view:focus,
.btn-download:focus {
  outline: 2px solid var(--success);
  outline-offset: 2px;
}

/* NEW: Enhanced answer section styles */
.answer-section {
  margin-top: 20px;
  padding: 20px;
  background: rgba(67, 97, 238, 0.05);
  border-radius: 10px;
  border: 1px solid rgba(67, 97, 238, 0.2);
}

.answer-section h4 {
  color: var(--success);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.answer-section h4 i {
  color: var(--success);
}

.answer-input {
  width: 100%;
  min-height: 120px;
  padding: 15px;
  background: var(--bg-main);
  border: 1px solid rgba(67, 97, 238, 0.3);
  border-radius: 8px;
  color: var(--primary);
  font-size: 14px;
  resize: vertical;
  font-family: inherit;
  transition: all 0.3s ease;
}

.answer-input:focus {
  outline: none;
  border-color: var(--success);
  box-shadow: 0 0 0 2px rgba(0, 245, 255, 0.2);
}

.answer-input.code-answer {
  font-family: 'Courier New', monospace;
  min-height: 200px;
}

.answer-stats {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
  font-size: 12px;
  color: var(--gray);
}

.answer-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.btn-save-answer {
  background: linear-gradient(45deg, var(--light), var(--success));
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn-save-answer:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
}

.btn-save-answer.saved {
  background: linear-gradient(45deg, #48bb78, #38a169);
}

.answer-status {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: var(--success);
  margin-top: 10px;
}

.answer-status i {
  font-size: 16px;
}

/* Single and Multiple Choice Styles */
.choice-options {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 10px;
}

.choice-option {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 15px;
  background: rgba(67, 97, 238, 0.05);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 1px solid transparent;
}

.choice-option:hover {
  background: rgba(67, 97, 238, 0.1);
}

.choice-option.selected {
  background: rgba(0, 245, 255, 0.1);
  border-color: var(--success);
}

.choice-option input[type="radio"],
.choice-option input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.choice-option label {
  cursor: pointer;
  flex: 1;
}

/* File Upload Styles */
.file-upload-area {
  border: 2px dashed rgba(67, 97, 238, 0.3);
  border-radius: 8px;
  padding: 30px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  margin-top: 10px;
}

.file-upload-area:hover {
  border-color: var(--success);
  background: rgba(67, 97, 238, 0.05);
}

.file-upload-area i {
  font-size: 48px;
  color: var(--success);
  margin-bottom: 15px;
}

.file-input {
  display: none;
}

.file-name {
  margin-top: 10px;
  color: var(--gray);
  font-size: 14px;
}

/* Question-specific styles */
.question-with-answer {
  margin-bottom: 25px;
  padding: 20px;
  background: rgba(67, 97, 238, 0.05);
  border-radius: 10px;
  border: 1px solid rgba(67, 97, 238, 0.2);
}

.question-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
}

.question-text {
  font-size: 18px;
  color: var(--primary);
  margin-bottom: 10px;
  flex: 1;
}

.question-points {
  background: rgba(0, 245, 255, 0.1);
  color: var(--success);
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  white-space: nowrap;
  margin-left: 15px;
}

.question-description {
  color: var(--gray);
  margin-bottom: 15px;
  font-size: 14px;
  line-height: 1.5;
}

/* Assignment questions container */
.assignment-questions-container {
  margin-top: 20px;
}

.assignment-questions-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid rgba(67, 97, 238, 0.2);
}

.assignment-questions-header h4 {
  color: var(--primary);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.questions-count {
  background: rgba(0, 245, 255, 0.1);
  color: var(--success);
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
}

/* Auto-save indicator */
.auto-save-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--gray);
  margin-top: 10px;
  transition: all 0.3s ease;
}

.auto-save-indicator.saving {
  color: #ffc107;
}

.auto-save-indicator.saved {
  color: var(--success);
}

/* Question type labels */
.question-type-label {
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--success);
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Code formatting button */
.btn-format-code {
  background: rgba(67, 97, 238, 0.1);
  color: var(--primary);
  border: 1px solid rgba(67, 97, 238, 0.3);
  padding: 8px 15px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 5px;
}

.btn-format-code:hover {
  background: rgba(67, 97, 238, 0.2);
  transform: translateY(-1px);
}

/* Test Restrictions Modal */
.test-warning-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 3000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.test-warning-modal.active {
  display: flex;
}

.test-warning-modal-content {
  background: var(--bg-secondary);
  border-radius: 20px;
  width: 90%;
  max-width: 500px;
  padding: 30px;
  position: relative;
  border: 1px solid rgba(67, 97, 238, 0.3);
  text-align: center;
}

.test-warning-icon {
  font-size: 60px;
  color: #ffc107;
  margin: 20px 0;
  animation: pulse 2s infinite;
}

.test-warning-title {
  font-size: 24px;
  color: var(--primary);
  margin-bottom: 15px;
}

.test-warning-text {
  color: var(--primary);
  font-size: 18px;
  margin-bottom: 25px;
}

.test-warning-attempts {
  color: #ffc107;
  font-weight: bold;
  font-size: 20px;
  margin: 10px 0;
}

.test-warning-actions {
  display: flex;
  gap: 15px;
  justify-content: center;
  margin-top: 20px;
}

/* Responsive Design */
@media (max-width: 768px) {
  .main-content.sidebar-open {
    margin-left: 0;
  }
  
  .sidebar {
    width: 100%;
  }
  
  .course-content-area {
    padding: 20px;
  }

  .course-header {
    padding: 25px 20px;
  }

  .course-name {
    font-size: 28px;
  }

  .course-providers {
    grid-template-columns: 1fr;
  }

  .instructor-card {
    flex-direction: column;
    text-align: center;
    padding: 25px;
  }

  .course-meta {
    flex-direction: column;
    gap: 15px;
  }

  .tabs-header {
    flex-direction: column;
  }

  .tab-content {
    padding: 20px;
  }

  .lesson-actions {
    flex-direction: column;
  }

  .resource-item {
    flex-direction: column;
    gap: 15px;
    text-align: center;
  }
  
  .topbar {
    padding: 0 20px;
  }

  .logout-actions {
    flex-direction: column;
  }

  .logout-actions .btn {
    width: 100%;
  }


  .assignment-navigation {
    flex-direction: column;
    gap: 15px;
  }
  
  .assignment-navigation .btn {
    width: 100%;
  }
  
  .option-item {
    padding: 10px;
  }

  .test-timer {
    position: relative;
    top: 0;
  }

  /* Responsive answer sections */
  .question-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .question-points {
    margin-left: 0;
  }

  .choice-option {
    padding: 10px;
  }

  .answer-actions {
    flex-direction: column;
  }

  .assignment-questions-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .test-warning-actions {
    flex-direction: column;
  }
}

@media (max-width: 480px) {
  .course-content-area {
    padding: 15px;
  }

  .course-header {
    padding: 20px 15px;
  }

  .course-name {
    font-size: 24px;
  }

  .tab-content {
    padding: 15px;
  }

  .assignment-questions-header h4 {
    font-size: 16px;
  }

  .question-text {
    font-size: 16px;
  }

  .answer-input {
    min-height: 100px;
    padding: 12px;
  }

  .file-upload-area {
    padding: 20px;
  }

  .file-upload-area i {
    font-size: 36px;
  }
}

/* NEW: Assignment Submission Details Modal */
.assignment-submission-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.assignment-submission-modal.active {
  display: flex;
}

.assignment-submission-modal-content {
  background: var(--bg-secondary);
  border-radius: 20px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 30px;
  position: relative;
  border: 1px solid rgba(67, 97, 238, 0.3);
}

.assignment-submission-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid rgba(67, 97, 238, 0.3);
}

.assignment-submission-modal-title {
  font-size: 24px;
  color: var(--primary);
  background: linear-gradient(45deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.close-assignment-submission-modal {
  background: none;
  border: none;
  color: var(--gray);
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.close-assignment-submission-modal:hover {
  color: var(--success);
  transform: rotate(90deg);
}

.submission-details {
  margin-bottom: 25px;
  padding: 20px;
  background: rgba(67, 97, 238, 0.1);
  border-radius: 15px;
}

.submission-details h4 {
  color: var(--success);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.submission-details-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}

.submission-detail-item {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.submission-detail-label {
  font-size: 14px;
  color: var(--gray);
  font-weight: 500;
}

.submission-detail-value {
  font-size: 16px;
  color: var(--primary);
  font-weight: 600;
}

.submission-grade {
  text-align: center;
  margin: 20px 0;
  padding: 20px;
  background: rgba(0, 245, 255, 0.1);
  border-radius: 15px;
}

.grade-display {
  font-size: 48px;
  font-weight: bold;
  margin: 10px 0;
  background: linear-gradient(45deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.grade-status {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 10px;
}

.grade-status.passed {
  color: var(--success);
}

.grade-status.failed {
  color: #ff4757;
}

.submission-feedback {
  margin: 20px 0;
  padding: 20px;
  background: rgba(67, 97, 238, 0.1);
  border-radius: 15px;
}

.submission-feedback h4 {
  color: var(--primary);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.feedback-content {
  color: var(--gray);
  line-height: 1.6;
  padding: 15px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 10px;
}

.question-feedback-list {
  margin-top: 25px;
}

.question-feedback-item {
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(67, 97, 238, 0.05);
  border-radius: 10px;
  border: 1px solid rgba(67, 97, 238, 0.2);
}

.question-feedback-item.correct {
  border-left: 4px solid var(--success);
}

.question-feedback-item.incorrect {
  border-left: 4px solid #ff4757;
}

.question-feedback-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
}

.question-feedback-text {
  font-weight: 600;
  color: var(--primary);
  flex: 1;
}

.question-feedback-points {
  background: rgba(0, 245, 255, 0.1);
  color: var(--success);
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
}

.question-feedback-answer {
  margin: 10px 0;
  padding: 10px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 8px;
}

.answer-label {
  font-size: 14px;
  color: var(--gray);
  margin-bottom: 5px;
}

.answer-value {
  color: var(--primary);
}

.question-feedback-comment {
  margin-top: 10px;
  padding: 10px;
  background: rgba(255, 193, 7, 0.1);
  border-radius: 8px;
  border-left: 3px solid #ffc107;
}

.feedback-comment-label {
  font-size: 14px;
  color: #ffc107;
  margin-bottom: 5px;
  font-weight: 600;
}

.feedback-comment-text {
  color: var(--gray);
}

/* Test Results Modal */
.test-results-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.test-results-modal.active {
  display: flex;
}

.test-results-modal-content {
  background: var(--bg-secondary);
  border-radius: 20px;
  width: 90%;
  max-width: 900px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 30px;
  position: relative;
  border: 1px solid rgba(67, 97, 238, 0.3);
}

.test-results-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid rgba(67, 97, 238, 0.3);
}

.test-results-modal-title {
  font-size: 24px;
  color: var(--primary);
  background: linear-gradient(45deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.close-test-results-modal {
  background: none;
  border: none;
  color: var(--gray);
  font-size: 24px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.close-test-results-modal:hover {
  color: var(--success);
  transform: rotate(90deg);
}

.test-results-summary {
  text-align: center;
  margin-bottom: 30px;
  padding: 25px;
  background: rgba(67, 97, 238, 0.1);
  border-radius: 15px;
}

.test-results-score {
  font-size: 48px;
  font-weight: bold;
  margin: 15px 0;
  background: linear-gradient(45deg, var(--primary), var(--success));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.test-results-status {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 15px;
}

.test-results-status.passed {
  color: var(--success);
}

.test-results-status.failed {
  color: #ff4757;
}

.test-results-details {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin: 20px 0;
}

.test-detail-item {
  text-align: center;
  padding: 15px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 10px;
}

.test-detail-label {
  font-size: 14px;
  color: var(--gray);
  margin-bottom: 5px;
}

.test-detail-value {
  font-size: 18px;
  color: var(--primary);
  font-weight: 600;
}

.test-results-feedback {
  margin: 25px 0;
  padding: 20px;
  background: rgba(67, 97, 238, 0.1);
  border-radius: 15px;
}

.test-results-feedback h4 {
  color: var(--primary);
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.test-feedback-content {
  color: var(--gray);
  line-height: 1.6;
  padding: 15px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 10px;
}

.test-question-results {
  margin-top: 25px;
}

.test-question-result-item {
  margin-bottom: 20px;
  padding: 20px;
  background: rgba(67, 97, 238, 0.05);
  border-radius: 10px;
  border: 1px solid rgba(67, 97, 238, 0.2);
}

.test-question-result-item.correct {
  border-left: 4px solid var(--success);
}

.test-question-result-item.incorrect {
  border-left: 4px solid #ff4757;
}

.test-question-result-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
}

.test-question-result-text {
  font-weight: 600;
  color: var(--primary);
  flex: 1;
  font-size: 16px;
}

.test-question-result-points {
  background: rgba(0, 245, 255, 0.1);
  color: var(--success);
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
}

.test-question-result-answer {
  margin: 10px 0;
  padding: 12px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 8px;
}

.test-answer-label {
  font-size: 14px;
  color: var(--gray);
  margin-bottom: 5px;
  font-weight: 500;
}

.test-answer-value {
  color: var(--primary);
  margin-bottom: 8px;
}

.test-correct-answer {
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px solid rgba(67, 97, 238, 0.3);
}

.test-correct-answer-label {
  font-size: 14px;
  color: var(--success);
  margin-bottom: 5px;
  font-weight: 500;
}

.test-correct-answer-value {
  color: var(--success);
  font-weight: 500;
}

.test-question-result-comment {
  margin-top: 15px;
  padding: 12px;
  background: rgba(255, 193, 7, 0.1);
  border-radius: 8px;
  border-left: 3px solid #ffc107;
}

.test-comment-label {
  font-size: 14px;
  color: #ffc107;
  margin-bottom: 5px;
  font-weight: 600;
}

.test-comment-text {
  color: var(--gray);
  line-height: 1.5;
}
  </style>
</head>
<body>
  <!-- Loading Animation -->
  <div class="loading-container" id="loadingContainer">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading course details...</div>
  </div>

  <div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2>SkillUp</h2>
        <button class="close-sidebar" id="closeSidebar">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <ul class="sidebar-menu">
        <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li><a href="courses.html" class="active"><i class="fas fa-book"></i> My Courses</a></li>
        <li><a href="mylearning.html"><i class="fas fa-chart-line"></i> Progress</a></li>
        <li><a href="studentmessages.html"><i class="fas fa-comments"></i> Messages</a></li>
        <li><a href="profile.html"><i class="fas fa-user"></i> Profile</a></li>
      </ul>

      <div class="sidebar-footer">
        <button class="logout-btn" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
      <!-- Topbar -->
      <div class="topbar">
        <div class="topbar-left">
          <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
          </button>
          <div class="topbar-title">Course Details</div>
        </div>
        
        <div class="user-info">
          <div class="notification-container">
            <button class="notification-icon" id="notificationIcon">
              <i class="fas fa-bell"></i>
              <span class="notification-badge" id="notificationBadge">0</span>
            </button>
            <div class="notification-dropdown" id="notificationDropdown">
              <div class="notification-header">
                <h3>Notifications</h3>
                <button class="notification-clear" id="clearNotifications">Clear All</button>
              </div>
              <div class="notification-list" id="notificationList">
                <!-- Notifications will be populated here -->
              </div>
            </div>
          </div>
          <span id="userDisplayName">Loading...</span>
          <div class="avatar">
            <span id="userInitials">U</span>
          </div>
        </div>
      </div>

      <!-- Course Content Area -->
      <div class="course-content-area">
        <!-- Course Header -->
        <section class="course-header">
          <h1 class="course-name" id="courseName">Loading course...</h1>
          
          
          <!-- Course Provider and Instructor -->
          <div class="course-providers">
            <div class="provider-card">
              <div class="provider-title">Course Provider</div>
              <div class="provider-name">SkillUp Academy</div>
              <div class="provider-description">Leading online education platform with certified courses</div>
            </div>
            <div class="instructor-card-mini">
              <div class="instructor-title">Course Instructor</div>
              <div class="instructor-name-text" id="instructorNameMini">Loading...</div>
              <div class="instructor-bio" id="instructorBioMini">Loading instructor information...</div>
            </div>
          </div>

          <div class="course-meta">
            <div class="meta-item"><i class="fas fa-layer-group"></i><span id="courseLevel">Loading...</span></div>
            <div class="meta-item"><i class="fas fa-clock"></i><span id="courseDuration">Loading...</span></div>
            <div class="meta-item"><i class="fas fa-tag"></i><span id="courseCategory">Loading...</span></div>
          </div>
          
          <!-- Progress Section -->
          <div class="progress-section">
            <div class="progress-label">
              <span>Course Progress</span>
              <span id="overallProgress">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="overallProgressFill" style="width: 0%"></div>
            </div>
          </div>

          <!-- NEW: Assignments Progress Section -->
          <div class="assignments-progress" id="assignmentsProgress">
            <div class="progress-item pending">
              <div class="progress-number">0/0</div>
              <div class="progress-label">Submitted</div>
            </div>
            <div class="progress-item pending">
              <div class="progress-number">0/0</div>
              <div class="progress-label">Evaluated</div>
            </div>
            <div class="progress-item pending">
              <div class="progress-number"></div>
              <div class="progress-label">Ready for Final Test</div>
            </div>
          </div>
        </section>

        <!-- Instructor -->
        <section class="instructor-card">
          <div class="instructor-avatar" id="instructorAvatar">L</div>
          <div class="instructor-name">
            <h3 id="instructorName">Loading instructor...</h3>
            <p class="instructor-bio" id="instructorBio">Loading instructor information...</p>
          </div>
        </section>

        <!-- Tabs -->
        <section class="tabs-container">
          <div class="tabs-header">
            <button class="tab-button active" data-tab="overview">
              <i class="fas fa-info-circle"></i> Overview
            </button>
            <button class="tab-button" data-tab="curriculum">
              <i class="fas fa-list"></i> Curriculum
            </button>
            <button class="tab-button" data-tab="assignments">
              <i class="fas fa-tasks"></i> Assignments
            </button>
            <button class="tab-button" data-tab="resources">
              <i class="fas fa-download"></i> Resources
            </button>
          </div>

          <!-- Overview -->
          <div class="tab-content active" id="overview">
            <h3>Course Description</h3>
            <p class="course-description" id="courseDescription">Loading course description...</p>
          </div>

          <!-- Curriculum -->
          <div class="tab-content" id="curriculum">
            <h3>Course Curriculum</h3>
            <div class="curriculum-list" id="course-list">
              <div class="loading-text">Loading lectures...</div>
            </div>

            <!-- Final Test Section -->
            <div class="final-test-section locked" id="finalTestSection">
              <div class="final-test-icon">
                <i class="fas fa-lock"></i>
              </div>
              <h3 class="final-test-title">Final Test Locked</h3>
              <p class="final-test-description">
                Complete all lectures and assignments to unlock the final test.
              </p>
              <button class="btn-take-test" id="takeTestButton" disabled>Take Final Test</button>
            </div>
          </div>
          
          <!-- Assignments Tab - SIMPLIFIED -->
          <div class="tab-content" id="assignments">
            <h3>Course Assignments</h3>
            <div class="assignments-container" id="assignmentsContainer">
              <div class="loading-text">Loading assignments...</div>
            </div>
          </div>

          <!-- Resources -->
          <div class="tab-content" id="resources">
            <h3>Course Resources</h3>
            <div class="resources-grid" id="resourcesGrid">
              <div class="loading-text">Loading resources...</div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Logout Confirmation Modal -->
  <div class="modal" id="logoutModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Confirm Logout</h2>
        <button class="close-modal" id="closeLogoutModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="logout-icon">
        <i class="fas fa-sign-out-alt"></i>
      </div>
      <p class="logout-text">Are you sure you want to logout?</p>
      <div class="logout-actions">
        <button class="btn btn-secondary" id="cancelLogout">Cancel</button>
        <button class="btn btn-danger" id="confirmLogout">Logout</button>
      </div>
    </div>
  </div>

  <!-- NEW: Video Player Popup Modal -->
  <div class="video-player-modal" id="videoPlayerModal">
    <div class="video-player-modal-content">
      <div class="video-player-modal-header">
        <h2 class="video-player-modal-title" id="videoPlayerTitle">Loading video...</h2>
        <button class="close-video-modal" id="closeVideoModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="video-player-container">
        <video id="videoPlayer" controls>
          Your browser does not support the video tag.
        </video>
      </div>
      <div class="video-player-controls">
        <div class="video-player-status" id="videoPlayerStatus">Ready to play</div>
      </div>
    </div>
  </div>

  <!-- Assignment Submission Details Modal -->
  <div class="assignment-submission-modal" id="assignmentSubmissionModal">
    <div class="assignment-submission-modal-content">
      <div class="assignment-submission-modal-header">
        <h2 class="assignment-submission-modal-title">Assignment Submission Details</h2>
        <button class="close-assignment-submission-modal" id="closeAssignmentSubmissionModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="assignmentSubmissionContent">
        <!-- Content will be populated dynamically -->
      </div>
    </div>
  </div>

  <!-- Test Results Modal -->
  <div class="test-results-modal" id="testResultsModal">
    <div class="test-results-modal-content">
      <div class="test-results-modal-header">
        <h2 class="test-results-modal-title">Test Results</h2>
        <button class="close-test-results-modal" id="closeTestResultsModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="testResultsContent">
        <!-- Content will be populated dynamically -->
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>&copy; 2025 SkillUp Platform. All rights reserved.</p>
  </footer>

<script type="module">
// Firebase Import - Using stable version
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { 
  getFirestore, collection, query, limit, getDocs, doc, getDoc, updateDoc, arrayUnion, setDoc,
  where, orderBy, addDoc, onSnapshot, serverTimestamp, increment, Timestamp
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
import { getStorage, ref, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBffElX8sXMQdYXOXLjepqd7KYic20D4K8",
  authDomain: "growup-93f5d.firebaseapp.com",
  projectId: "growup-93f5d",
  storageBucket: "growup-93f5d.firebasestorage.app",
  messagingSenderId: "775742235468",
  appId: "1:775742235468:web:bd46cb802185c89f2aa5e9",
  measurementId: "G-FWBKTSQDS9"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

console.log('Firebase initialized successfully');

// Get courseId from URL
const urlParams = new URLSearchParams(window.location.search);
const courseId = urlParams.get("id") || urlParams.get("courseId") || urlParams.get("courseID");

console.log("=== COURSE INITIALIZATION ===");
console.log("Course ID from URL:", courseId);
console.log("Full URL:", window.location.href);

if (!courseId) {
  console.error("No course ID found in URL parameters");
  alert("No course ID provided. Redirecting to courses page...");
  window.location.href = "courses.html";
}

// Global variables
let currentUser = null;
let courseData = null;
let userEnrollmentData = null;
let allLectures = [];
let courseNotes = [];
let courseAssignments = [];
let courseCertificates = [];

// Test attempt variables
let currentTestAttempt = 0;
let maxTestAttempts = 3;
let testEvaluationData = null;

// Track shown notifications to prevent duplicates
let shownNotifications = new Set();

// Track if we've already processed evaluations for this session
let processedEvaluations = new Set();

// Track test evaluation state to prevent multiple triggers
let testEvaluationProcessed = false;

// Track current video being played
let currentVideoLectureId = null;

// DOM elements
const loadingContainer = document.getElementById('loadingContainer');
const sidebar = document.getElementById('sidebar');
const mainContent = document.getElementById('mainContent');
const sidebarToggle = document.getElementById('sidebarToggle');
const closeSidebar = document.getElementById('closeSidebar');
const logoutBtn = document.getElementById('logoutBtn');
const logoutModal = document.getElementById('logoutModal');
const closeLogoutModal = document.getElementById('closeLogoutModal');
const cancelLogout = document.getElementById('cancelLogout');
const confirmLogout = document.getElementById('confirmLogout');
const notificationIcon = document.getElementById('notificationIcon');
const notificationDropdown = document.getElementById('notificationDropdown');
const notificationList = document.getElementById('notificationList');
const clearNotifications = document.getElementById('clearNotifications');
const userDisplayName = document.getElementById('userDisplayName');
const userInitials = document.getElementById('userInitials');
const finalTestSection = document.getElementById('finalTestSection');
const assignmentsProgress = document.getElementById('assignmentsProgress');
const takeTestButton = document.getElementById('takeTestButton');
const overallProgress = document.getElementById('overallProgress');
const overallProgressFill = document.getElementById('overallProgressFill');
const assignmentsContainer = document.getElementById('assignmentsContainer');

// NEW: Video Player Modal elements
const videoPlayerModal = document.getElementById('videoPlayerModal');
const closeVideoModal = document.getElementById('closeVideoModal');
const videoPlayer = document.getElementById('videoPlayer');
const videoPlayerTitle = document.getElementById('videoPlayerTitle');
const videoPlayerStatus = document.getElementById('videoPlayerStatus');
const fullscreenBtn = document.getElementById('fullscreenBtn');

// NEW: Modal elements
const assignmentSubmissionModal = document.getElementById('assignmentSubmissionModal');
const closeAssignmentSubmissionModal = document.getElementById('closeAssignmentSubmissionModal');
const assignmentSubmissionContent = document.getElementById('assignmentSubmissionContent');
const testResultsModal = document.getElementById('testResultsModal');
const closeTestResultsModal = document.getElementById('closeTestResultsModal');
const testResultsContent = document.getElementById('testResultsContent');

console.log("DOM elements loaded");

// Initialize the page
function initCoursePage() {
  console.log("=== INITIALIZING COURSE PAGE ===");
  
  // Clean up any existing listeners first
  cleanupAllListeners();
  
  // Reset tracking variables
  shownNotifications.clear();
  processedEvaluations.clear();
  testEvaluationProcessed = false;

  // Sidebar functionality
  sidebarToggle?.addEventListener('click', () => {
    sidebar.classList.add('active');
    mainContent.classList.add('sidebar-open');
  });

  closeSidebar?.addEventListener('click', () => {
    sidebar.classList.remove('active');
    mainContent.classList.remove('sidebar-open');
  });

  // Close sidebar on outside click
  document.addEventListener('click', (e) => {
    if (sidebar.classList.contains('active')) {
      if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
        sidebar.classList.remove('active');
        mainContent.classList.remove('sidebar-open');
      }
    }
  });

  // Logout functionality
  logoutBtn?.addEventListener('click', () => {
    logoutModal.classList.add('active');
  });

  closeLogoutModal?.addEventListener('click', () => {
    logoutModal.classList.remove('active');
  });

  cancelLogout?.addEventListener('click', () => {
    logoutModal.classList.remove('active');
  });

  confirmLogout?.addEventListener('click', () => {
    signOut(auth).then(() => {
      window.location.href = "index.html";
    }).catch((error) => {
      console.error("Error signing out:", error);
    });
  });

  // Take test button functionality
  takeTestButton?.addEventListener('click', () => {
    openTestWindow();
  });

  // Notification functionality
  notificationIcon?.addEventListener('click', (e) => {
    e.stopPropagation();
    notificationDropdown.classList.toggle('active');
    if (currentUser) {
      loadNotifications(currentUser.uid);
    }
  });

  clearNotifications?.addEventListener('click', () => {
    clearAllNotifications();
  });

  // Close notification dropdown when clicking outside 
  document.addEventListener('click', (e) => {
    if (notificationDropdown.classList.contains('active')) {
      if (!notificationDropdown.contains(e.target) && !notificationIcon.contains(e.target)) {
        notificationDropdown.classList.remove('active');
      }
    }
  });

  // Tab functionality
  document.querySelectorAll(".tab-button").forEach(button => {
    button.addEventListener("click", () => {
      const tabId = button.getAttribute("data-tab");
      document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));
      button.classList.add("active");
      document.getElementById(tabId).classList.add("active");
      
      // Load assignments when assignments tab is clicked
      if (tabId === 'assignments') {
        loadAssignmentsForTab();
      }
    });
  });

  // NEW: Video Player Modal functionality
  closeVideoModal?.addEventListener('click', () => {
    closeVideoPlayer();
  });

  fullscreenBtn?.addEventListener('click', () => {
    toggleFullscreen(videoPlayer);
  });

  // Close video modal when clicking outside
  document.addEventListener('click', (e) => {
    if (videoPlayerModal.classList.contains('active')) {
      if (!videoPlayerModal.querySelector('.video-player-modal-content').contains(e.target)) {
        closeVideoPlayer();
      }
    }
  });

  // NEW: Modal close functionality
  closeAssignmentSubmissionModal?.addEventListener('click', () => {
    assignmentSubmissionModal.classList.remove('active');
  });

  closeTestResultsModal?.addEventListener('click', () => {
    testResultsModal.classList.remove('active');
  });

  // Close modals when clicking outside
  assignmentSubmissionModal?.addEventListener('click', (e) => {
    if (e.target === assignmentSubmissionModal) {
      assignmentSubmissionModal.classList.remove('active');
    }
  });

  testResultsModal?.addEventListener('click', (e) => {
    if (e.target === testResultsModal) {
      testResultsModal.classList.remove('active');
    }
  });

  // Close modals with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      if (assignmentSubmissionModal?.classList.contains('active')) {
        assignmentSubmissionModal.classList.remove('active');
      }
      if (testResultsModal?.classList.contains('active')) {
        testResultsModal.classList.remove('active');
      }
    }
  });

  console.log("Event listeners attached");

  // Check auth state
  onAuthStateChanged(auth, async (user) => {
    console.log("=== AUTH STATE CHANGED ===");
    console.log("User:", user ? user.email : "Not logged in");
    
    if (user) {
      currentUser = user;
      const displayName = user.displayName || "Learner";
      
      userDisplayName.textContent = displayName;
      const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase();
      userInitials.textContent = initials;
      
      console.log("Loading course data...");
      
      // Load data
      await loadCourse();
      await loadUserEnrollmentData();
      await loadResources();
      await loadNotes();
      await loadAssignments();
      await loadCertificates();
      await loadNotifications(user.uid);
      
      // Set up real-time listener for assignment and test evaluations
      setupEvaluationListener();
      
      // Load test evaluation data
      await loadTestEvaluationData();
      
      // Set up message listener for test window communication
      setupTestWindowListener();
      
      // Hide loading animation after data is loaded
      setTimeout(() => {
        if (loadingContainer) loadingContainer.classList.add('hidden');
      }, 1000);
      
      // Force update test section UI after everything is loaded
      setTimeout(() => {
        updateTestSectionUI();
      }, 1000);
      
      console.log("Course page loaded successfully");
    } else {
      console.log("No user logged in, redirecting to signin...");
      window.location.href = "signin.html";
    }
  });
}

// Updated playVideo function with correct Storage path handling
window.playVideo = async function(courseId, filename, lectureId, lectureTitle) {
  console.log(`=== PLAY VIDEO CALLED ===`);
  console.log(`Course ID: ${courseId}`);
  console.log(`Filename: ${filename}`);
  console.log(`Lecture ID: ${lectureId}`);
  console.log(`Lecture Title: ${lectureTitle}`);
  
  currentVideoLectureId = lectureId;
  
  // Set video title
  videoPlayerTitle.textContent = lectureTitle;
  
  // Clean up filename - remove any path separators or extensions
  let cleanFilename = filename;
  if (cleanFilename && (cleanFilename.includes('/') || cleanFilename.includes('\\'))) {
    cleanFilename = cleanFilename.split(/[/\\]/).pop();
  }
  
  // Ensure filename has .mp4 extension
  if (cleanFilename && !cleanFilename.endsWith('.mp4')) {
    cleanFilename = cleanFilename + '.mp4';
  }
  
  console.log(`Clean filename: ${cleanFilename}`);
  
  let videoUrl;
  
  try {
    console.log('Attempting to get video from Firebase Storage...');
    
    // Define all possible storage paths to try
    const possiblePaths = [
      `videos/course${courseId}/${cleanFilename}`,    // videos/course1/lecture1.mp4
      `videos/${courseId}/${cleanFilename}`,           // videos/1/lecture1.mp4
      `videos/course${courseId}/${lectureId}.mp4`,    // videos/course1/lectureId1.mp4
      `videos/${courseId}/${lectureId}.mp4`,           // videos/1/lectureId1.mp4
      `videos/${cleanFilename}`,                       // videos/lecture1.mp4 (root level)
      `course${courseId}/videos/${cleanFilename}`,    // course1/videos/lecture1.mp4
      `${courseId}/videos/${cleanFilename}`            // 1/videos/lecture1.mp4
    ];
    
    let foundUrl = null;
    let foundPath = null;
    
    // Try each possible path
    for (const path of possiblePaths) {
      try {
        console.log(`Trying path: ${path}`);
        const videoRef = ref(storage, path);
        const url = await getDownloadURL(videoRef);
        foundUrl = url;
        foundPath = path;
        console.log(` Found video at path: ${path}`);
        break;
      } catch (error) {
        console.log(` Video not found at path: ${path}`);
        continue;
      }
    }
    
    if (foundUrl) {
      videoUrl = foundUrl;
      console.log(`Using video URL from path: ${foundPath}`);
    } else {
      throw new Error('Video not found in any storage path');
    }
  } catch (error) {
    console.error('Error getting video from Firebase Storage:', error);
    
    // Show error message to user
    videoPlayerStatus.textContent = 'Error: Video file not found in storage';
    videoPlayerStatus.style.color = '#ff4757';
    
    // Show error notification
    addNotification({
      title: "Video Not Available",
      message: `The video file "${cleanFilename}" could not be found. Please contact support.`,
      type: "video_error",
      courseId: courseId,
      read: false
    });
    
    return; // Exit function if no video found
  }
  
  // Clear previous source and set new one
  videoPlayer.innerHTML = '';
  const source = document.createElement('source');
  source.src = videoUrl;
  source.type = 'video/mp4';
  videoPlayer.appendChild(source);
  
  console.log('Video source set to Firebase Storage URL');
  
  // Show loading status
  videoPlayerStatus.textContent = 'Loading video from storage...';
  videoPlayerStatus.style.color = 'var(--gray)';
  
  // Set up event listeners for the video
  videoPlayer.addEventListener('loadeddata', function onLoadedData() {
    console.log('Video loaded successfully from Firebase Storage');
    videoPlayerStatus.textContent = 'Video loaded - Playing...';
    videoPlayerStatus.style.color = 'var(--success)';
    
    // Try to auto-play the video
    videoPlayer.play().catch(error => {
      console.error('Error auto-playing video:', error);
      videoPlayerStatus.textContent = 'Click play to start video';
      videoPlayerStatus.style.color = 'var(--gray)';
    });
    
    videoPlayer.removeEventListener('loadeddata', onLoadedData);
  });
  
  videoPlayer.addEventListener('error', function onVideoError(e) {
    console.error('Video error:', e);
    console.error('Video error details:', videoPlayer.error);
    
    videoPlayerStatus.textContent = 'Error loading video from storage';
    videoPlayerStatus.style.color = '#ff4757';
    
    addNotification({
      title: "Video Playback Error",
      message: "There was an error loading the video. Please try again.",
      type: "video_error",
      courseId: courseId,
      read: false
    });
    
    videoPlayer.removeEventListener('error', onVideoError);
  });
  
  videoPlayer.addEventListener('waiting', function() {
    videoPlayerStatus.textContent = 'Buffering video...';
    videoPlayerStatus.style.color = 'var(--gray)';
  });
  
  videoPlayer.addEventListener('playing', function() {
    videoPlayerStatus.textContent = 'Playing...';
    videoPlayerStatus.style.color = 'var(--success)';
  });
  
  // Auto-mark as complete when video reaches 90%
  let hasMarkedComplete = false;
  videoPlayer.addEventListener('timeupdate', function onTimeUpdate() {
    const currentTime = videoPlayer.currentTime;
    const duration = videoPlayer.duration;
    
    if (duration && (currentTime / duration) >= 0.9 && !hasMarkedComplete) {
      const isCompleted = userEnrollmentData?.completedLessons?.includes(lectureId) || false;
      if (!isCompleted) {
        hasMarkedComplete = true;
        console.log('Auto-marking lecture as complete at 90%');
        markLectureComplete(lectureId);
        videoPlayerStatus.textContent = 'Lecture completed!';
        videoPlayerStatus.style.color = 'var(--success)';
      }
    }
  });
  
  // Load and show the video
  console.log('Loading video player...');
  videoPlayer.load();
  videoPlayerModal.classList.add('active');
  console.log('Video player modal opened');
  
  // Add escape key listener to close modal
  document.addEventListener('keydown', function escapeHandler(e) {
    if (e.key === 'Escape' && videoPlayerModal.classList.contains('active')) {
      console.log('Escape key pressed, closing video player');
      closeVideoPlayer();
      document.removeEventListener('keydown', escapeHandler);
    }
  });
};

// NEW: Close video player
function closeVideoPlayer() {
  console.log('Closing video player');
  videoPlayerModal.classList.remove('active');
  if (videoPlayer) {
    videoPlayer.pause();
    videoPlayer.currentTime = 0;
  }
  currentVideoLectureId = null;
}

// NEW: Toggle fullscreen for video
function toggleFullscreen(element) {
  if (!document.fullscreenElement) {
    if (element.requestFullscreen) {
      element.requestFullscreen();
    } else if (element.webkitRequestFullscreen) {
      element.webkitRequestFullscreen();
    } else if (element.msRequestFullscreen) {
      element.msRequestFullscreen();
    }
    console.log('Entered fullscreen mode');
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    }
    console.log('Exited fullscreen mode');
  }
}

// Mark lecture as complete
// After line 1063, replace the updateProgressInFirestore call:
async function markLectureComplete(lectureId) {
  console.log(`=== MARKING LECTURE AS COMPLETE ===`);
  console.log(`Lecture ID: ${lectureId}`);
  
  if (!currentUser || !courseId || !lectureId) {
    console.error('Missing required data');
    return;
  }

  try {
    const userRef = doc(db, "users", currentUser.uid);
    
    const isAlreadyCompleted = userEnrollmentData?.completedLessons?.includes(lectureId);
    
    if (!isAlreadyCompleted) {
      console.log(`Updating Firestore...`);
      
      await updateDoc(userRef, {
        [`enrollments.${courseId}.completedLessons`]: arrayUnion(lectureId),
        [`enrollments.${courseId}.lastAccessed`]: new Date()
      });

      if (!userEnrollmentData.completedLessons) {
        userEnrollmentData.completedLessons = [];
      }
      userEnrollmentData.completedLessons.push(lectureId);
      
      // **CRITICAL FIX: Force immediate progress recalculation**
      await calculateAndUpdateProgress();
      
      updateLectureUI(lectureId, true);
      showLectureCompletionAnimation();
      
      console.log(`Lecture ${lectureId} marked as complete successfully`);
    }
  } catch (error) {
    console.error("Error marking lecture as complete:", error);
  }
}
// NEW: Centralized progress calculation
async function calculateAndUpdateProgress() {
  console.log("=== CALCULATING AND UPDATING PROGRESS ===");
  
  if (!currentUser || !courseId || !userEnrollmentData) {
    console.error("Missing required data for progress calculation");
    return;
  }

  try {
    // Reload latest user data first
    const userRef = doc(db, "users", currentUser.uid);
    const userSnap = await getDoc(userRef);
    
    if (userSnap.exists()) {
      const userData = userSnap.data();
      const courseEnrollment = userData.enrollments?.[courseId];
      if (courseEnrollment) {
        userEnrollmentData = { ...userEnrollmentData, ...courseEnrollment };
      }
    }
    
    // Count components
    const totalLectures = allLectures.length || 0;
    const totalAssignments = courseAssignments.length || 0;
    const hasFinalTest = 1;
    const totalComponents = totalLectures + totalAssignments + hasFinalTest;
    
    if (totalComponents === 0) {
      console.log("No components found");
      return;
    }
    
    const valuePerComponent = 100 / totalComponents;
    
    // Calculate lecture progress
    const completedLectures = userEnrollmentData.completedLessons?.length || 0;
    const lectureProgress = completedLectures * valuePerComponent;

    // Calculate assignment progress - only passed assignments
    const passedAssignments = getPassedAssignmentsCount();
    const assignmentProgress = passedAssignments * valuePerComponent;

    // Calculate test progress
    let testProgress = 0;
    if (userEnrollmentData.testEvaluated && userEnrollmentData.testGrade >= 70) {
      testProgress = hasFinalTest * valuePerComponent;
    }
    
    // Overall progress
    const overallProgress = Math.min(Math.round(lectureProgress + assignmentProgress + testProgress), 100);
    
    console.log(`Progress Calculation:`);
    console.log(`- Lectures: ${completedLectures}/${totalLectures} = ${lectureProgress.toFixed(2)}%`);
    console.log(`- Assignments: ${passedAssignments}/${totalAssignments} = ${assignmentProgress.toFixed(2)}%`);
    console.log(`- Test: ${testProgress.toFixed(2)}%`);
    console.log(`- Overall: ${overallProgress}%`);
    
    // **CRITICAL: Update Firestore with new progress**
    await updateDoc(userRef, {
      [`enrollments.${courseId}.progress`]: overallProgress,
      [`enrollments.${courseId}.lectureProgress`]: Math.round(lectureProgress * 10) / 10,
      [`enrollments.${courseId}.assignmentProgress`]: Math.round(assignmentProgress * 10) / 10,
      [`enrollments.${courseId}.testProgress`]: testProgress,
      [`enrollments.${courseId}.lastAccessed`]: Timestamp.now()
    });
    
    // Update local data
    userEnrollmentData.progress = overallProgress;
    userEnrollmentData.lectureProgress = Math.round(lectureProgress * 10) / 10;
    userEnrollmentData.assignmentProgress = Math.round(assignmentProgress * 10) / 10;
    userEnrollmentData.testProgress = testProgress;
    
    // Update UI
    updateProgressDisplay();
    checkAssignmentUnlock();
    
    console.log(` Progress updated to ${overallProgress}%`);
    
  } catch (error) {
    console.error("Error calculating progress:", error);
  }
}

// Update progress calculation to equal distribution
// Update progress calculation to use centralized function
async function updateProgressInFirestore() {
  await calculateAndUpdateProgress();
}

// NEW: Show lecture completion animation
function showLectureCompletionAnimation() {
  // Remove any existing animation
  const existingAnimation = document.querySelector('.lecture-completion-animation');
  if (existingAnimation) {
    existingAnimation.remove();
  }
  
  // Create new animation
  const animation = document.createElement('div');
  animation.className = 'lecture-completion-animation';
  animation.innerHTML = `
    <div class="completion-icon">
      <i class="fas fa-check-circle"></i>
    </div>
    <div class="completion-text">
      Lecture Completed!
    </div>
  `;
  
  document.body.appendChild(animation);
  
  // Remove animation after it fades out
  setTimeout(() => {
    if (animation.parentNode) {
      animation.parentNode.removeChild(animation);
    }
  }, 3000);
}

// Update lecture UI after completion
function updateLectureUI(lectureId, isCompleted) {
  console.log(`Updating lecture UI: ${lectureId}, completed: ${isCompleted}`);
  
  const lectureItem = document.querySelector(`[data-lecture-id="${lectureId}"]`);
  if (!lectureItem) {
    console.error(`Lecture item not found for ID: ${lectureId}`);
    return;
  }
  
  if (isCompleted) {
    lectureItem.classList.add('completed');
    const statusIcon = lectureItem.querySelector('.lesson-status');
    
    if (statusIcon) {
      statusIcon.textContent = '';
      statusIcon.style.color = 'var(--success)';
    }
    
    // Update the play button text
    const playButton = lectureItem.querySelector('.btn-play');
    if (playButton) {
      playButton.innerHTML = '<i class="fas fa-play"></i> Rewatch Video';
    }
  } else {
    lectureItem.classList.remove('completed');
    const statusIcon = lectureItem.querySelector('.lesson-status');
    
    if (statusIcon) {
      statusIcon.textContent = '';
      statusIcon.style.color = 'var(--gray)';
    }
    
    // Update the play button text
    const playButton = lectureItem.querySelector('.btn-play');
    if (playButton) {
      playButton.innerHTML = '<i class="fas fa-play"></i> Play Video';
    }
  }
  
  console.log('Lecture UI updated successfully');
}

// FIXED: Update progress display with equal distribution
function updateProgressDisplay() {
  console.log("=== UPDATING PROGRESS DISPLAY ===");
  
  if (!userEnrollmentData) {
    console.log("Missing enrollment data");
    return;
  }

  // Use the progress value from userEnrollmentData (which is updated from Firestore)
  const overallProgressValue = userEnrollmentData.progress || 0;
  
  console.log(`Displaying progress: ${overallProgressValue}%`);
  
  // Update the DOM
  const overallProgressElement = document.getElementById('overallProgress');
  const overallProgressFillElement = document.getElementById('overallProgressFill');
  
  if (overallProgressElement) {
    overallProgressElement.textContent = `${overallProgressValue}%`;
  }
  if (overallProgressFillElement) {
    overallProgressFillElement.style.width = `${overallProgressValue}%`;
  }

  updateAssignmentsProgress();
  
  // Check for course completion
  if (overallProgressValue === 100 && !userEnrollmentData.certificateAwarded) {
    console.log("Course completed! Awarding certificate...");
    awardCertificate();
  }
  
  checkAssignmentUnlock();
}

// Update assignments progress display
function updateAssignmentsProgress() {
  if (!assignmentsProgress || !courseAssignments.length) return;
  
  const completedAssignments = userEnrollmentData?.completedAssignments?.length || 0;
  const totalAssignments = courseAssignments.length;
  const passedAssignments = getPassedAssignmentsCount();
  
  console.log(`Assignments Progress: ${completedAssignments} submitted, ${passedAssignments} passed out of ${totalAssignments}`);
  
  assignmentsProgress.innerHTML = `
    <div class="progress-item ${completedAssignments > 0 ? 'completed' : 'pending'}">
      <div class="progress-number">${completedAssignments}/${totalAssignments}</div>
      <div class="progress-label">Submitted</div>
    </div>
    <div class="progress-item ${passedAssignments > 0 ? 'completed' : 'pending'}">
      <div class="progress-number">${passedAssignments}/${totalAssignments}</div>
      <div class="progress-label">Passed</div>
    </div>
    <div class="progress-item ${passedAssignments === totalAssignments ? 'completed' : 'pending'}">
      <div class="progress-number">${passedAssignments === totalAssignments ? '' : ''}</div>
      <div class="progress-label">Ready for Final Test</div>
    </div>
  `;
}

// Get count of passed assignments
function getPassedAssignmentsCount() {
  if (!userEnrollmentData?.assignmentGrades || !courseAssignments.length) {
    return 0;
  }
  
  const assignmentGrades = userEnrollmentData.assignmentGrades;
  let passedCount = 0;
  
  courseAssignments.forEach(assignment => {
    const grade = assignmentGrades[assignment.id];
    if (grade !== undefined && grade !== null && grade >= 70) {
      passedCount++;
    }
  });
  
  return passedCount;
}

// Check if all assignments are passed (grade >= 70)
function checkAllAssignmentsPassed() {
  if (!userEnrollmentData?.assignmentGrades || !courseAssignments.length) {
    return false;
  }
  
  const assignmentGrades = userEnrollmentData.assignmentGrades;
  
  // Check if all assignments have grades >= 70
  for (const assignment of courseAssignments) {
    const grade = assignmentGrades[assignment.id];
    
    if (grade === undefined || grade === null || grade < 70) {
      return false;
    }
  }
  
  return true;
}

// Updated buildCurriculum function with better filename handling
async function buildCurriculum() {
  const curriculumList = document.querySelector(".curriculum-list") || document.getElementById("course-list");
  curriculumList.innerHTML = "<div class='loading-text'>Loading lectures...</div>";

  console.log("=== BUILDING CURRICULUM ===");
  console.log("Course ID:", courseId);

  try {
    const lecturesRef = collection(db, "courses", courseId, "lectures");
    console.log("Fetching lectures from Firestore...");
    const lecturesSnap = await getDocs(lecturesRef);
    
    console.log("Lectures snapshot size:", lecturesSnap.size);
    
    if (!lecturesSnap.empty) {
      allLectures = lecturesSnap.docs.map(doc => {
        const data = doc.data();
        console.log(`Lecture ${doc.id} data:`, data);
        
        // Extract filename from various possible fields
        let videoFilename = data.filename || data.videoUrl || data.video || data.url || data.videoFile;
        
        // If it's a full path, extract just the filename
        if (videoFilename && (videoFilename.includes('/') || videoFilename.includes('\\'))) {
          videoFilename = videoFilename.split(/[/\\]/).pop();
        }
        
        // Remove file extension for consistency (we'll add .mp4 in playVideo)
        if (videoFilename && videoFilename.includes('.')) {
          videoFilename = videoFilename.split('.').slice(0, -1).join('.');
        }
        
        // Default filename if none found
        if (!videoFilename) {
          videoFilename = `lecture_${doc.id}`;
        }
        
        console.log(`Processed filename for ${doc.id}: ${videoFilename}`);
        
        return { 
          id: doc.id, 
          title: data.title || "Untitled Lecture",
          duration: data.duration || "N/A",
          description: data.description || "No description available",
          filename: videoFilename,
          ...data
        };
      });
      console.log("Loaded lectures from Firestore:", allLectures);
    } else {
      // Create default lectures if none exist
      console.log("No lectures found in Firestore, using defaults");
      allLectures = [
        { id: "lectureId1", title: "Introduction to HTML", duration: "30 min", filename: "lecture1", description: "Learn the basics of HTML" },
        { id: "lectureId2", title: "HTML Tags and Elements", duration: "45 min", filename: "lecture2", description: "Understanding HTML tags" },
        { id: "lectureId3", title: "Forms and Inputs", duration: "40 min", filename: "lecture3", description: "Working with forms" },
        { id: "lectureId4", title: "HTML5 Semantic Elements", duration: "35 min", filename: "lecture4", description: "Modern HTML5 features" },
        { id: "lectureId5", title: "Final Project", duration: "50 min", filename: "lecture5", description: "Build a complete website" }
      ];
    }
    
    console.log(`Total lectures: ${allLectures.length}`);
    
    curriculumList.innerHTML = "";
    const ul = document.createElement("ul");
    ul.className = "lecture-list";

    // Ensure we have the latest enrollment data
    if (!userEnrollmentData) {
      console.log("Loading user enrollment data...");
      await loadUserEnrollmentData();
    }

    console.log("Completed lessons:", userEnrollmentData?.completedLessons || []);

    // Load assignments
    await loadAssignments();

    // Create assignments progress display
    updateAssignmentsProgress();

    // Add lectures to curriculum
    allLectures.forEach((lecture, index) => {
      const isCompleted = userEnrollmentData?.completedLessons?.includes(lecture.id) || false;

      const lessonItem = document.createElement("li");
      lessonItem.className = `lecture-item ${isCompleted ? 'completed' : ''}`;
      lessonItem.setAttribute('data-lecture-id', lecture.id);

      const videoFile = lecture.filename;
      
      console.log(`Lecture ${lecture.id}: title="${lecture.title}", videoFile="${videoFile}", completed=${isCompleted}`);

      lessonItem.innerHTML = `
        <div class="lesson-header">
          <div class="lesson-status">${isCompleted ? '' : ''}</div>
          <div class="lesson-info">
            <div class="lesson-title">${lecture.title || "Untitled Lecture"}</div>
            <div class="lesson-duration">${lecture.duration || "N/A"}</div>
          </div>
          <span class="expand-icon"></span>
        </div>
        <div class="lesson-content">
          <div class="lesson-description">${lecture.description || "No description available"}</div>
          <div class="lesson-actions">
            <button class="btn-play" data-course-id="${courseId}" data-filename="${videoFile}" data-lecture-id="${lecture.id}" data-lecture-title="${lecture.title || "Untitled Lecture"}">
              <i class="fas fa-play"></i> ${isCompleted ? 'Rewatch Video' : 'Play Video'}
            </button>
          </div>
        </div>
      `;

      // Add click event to expand/collapse
      const lessonHeader = lessonItem.querySelector('.lesson-header');
      lessonHeader.addEventListener('click', (e) => {
        e.stopPropagation();
        lessonItem.classList.toggle('expanded');
        console.log(`Toggled lecture ${lecture.id}`);
      });

      // Add play button event listener
      const playButton = lessonItem.querySelector('.btn-play');
      playButton.addEventListener('click', function(e) {
        e.stopPropagation();
        const courseIdAttr = this.getAttribute('data-course-id');
        const filename = this.getAttribute('data-filename');
        const lectureId = this.getAttribute('data-lecture-id');
        const lectureTitle = this.getAttribute('data-lecture-title');
        
        console.log(`=== PLAY BUTTON CLICKED ===`);
        console.log(`Course ID: ${courseIdAttr}`);
        console.log(`Filename: ${filename}`);
        console.log(`Lecture ID: ${lectureId}`);
        console.log(`Lecture Title: ${lectureTitle}`);
        
        playVideo(courseIdAttr, filename, lectureId, lectureTitle);
      });

      ul.appendChild(lessonItem);
    });

    curriculumList.appendChild(ul);
    
    console.log("Curriculum built successfully");
    
await calculateAndUpdateProgress();

  } catch (err) {
    console.error("Error building curriculum:", err);
    curriculumList.innerHTML = "<p> Failed to load lectures. Please try refreshing the page.</p>";
  }
}

// Load course data
async function loadCourse() {
  console.log("=== LOADING COURSE DATA ===");
  
  if (!courseId) {
    document.querySelector(".course-name").textContent = " No course selected";
    return;
  }

  try {
    const docRef = doc(db, "courses", courseId); 
    const docSnap = await getDoc(docRef);

    if (docSnap.exists()) {
      courseData = { id: docSnap.id, ...docSnap.data() };
      console.log("Course data loaded:", courseData);

      // Update basic course info immediately
      document.querySelector(".course-name").textContent = courseData.name || "Untitled Course";
      document.querySelector(".course-description").textContent = courseData.description || "No description available";
      
      const overviewTab = document.getElementById("overview");
      if (overviewTab) {
        overviewTab.innerHTML = `<h3>Course Description</h3><p>${courseData.description || "No description available"}</p>`;
      }

      const metaItems = document.querySelectorAll(".meta-item span:last-child");
      if (metaItems.length >= 3) {
        metaItems[0].textContent = courseData.level || "All Levels";
        metaItems[1].textContent = courseData.duration || "N/A";
        metaItems[2].textContent = courseData.category || "General";
      }

      // Load enrollment data FIRST (which contains the instructor info)
      await loadUserEnrollmentData();

      // THEN load instructor data (which will use the enrollment data)
      await loadInstructorData();

      // Build curriculum
      await buildCurriculum();

      // Show enrolled count
      if (courseData.enrolledCount !== undefined) {
        const existingCount = document.querySelector(".enrollment-count");
        if (existingCount) existingCount.remove();
        
        const countElement = document.createElement("div");
        countElement.className = "enrollment-count";
        countElement.innerHTML = ` ${courseData.enrolledCount} students enrolled`;
        document.querySelector(".course-header").appendChild(countElement);
      }

    } else {
      console.error("Course not found in Firestore");
      document.querySelector(".course-name").textContent = " Course not found";
    }
  } catch (err) {
    console.error("Error loading course:", err);
    // Set fallback instructor data on error
    setInstructorData({
      name: "SkillUp Instructor",
      bio: "Professional instructor with industry experience"
    });
  }
}

// Load user enrollment data
async function loadUserEnrollmentData() {
  console.log("=== LOADING USER ENROLLMENT DATA ===");
  
  if (!currentUser || !courseId) {
    console.error("Missing current user or course ID");
    return null;
  }

  try {
    const userRef = doc(db, "users", currentUser.uid);
    const userSnap = await getDoc(userRef);

    if (userSnap.exists() && userSnap.data().enrollments) {
      userEnrollmentData = userSnap.data().enrollments[courseId] || null;
      console.log("Enrollment data loaded:", userEnrollmentData);
      
      // **NEW: Log the randomly assigned teacher info**
      if (userEnrollmentData?.teacherId) {
        console.log(" Randomly assigned teacher:", {
          teacherId: userEnrollmentData.teacherId,
          teacherName: userEnrollmentData.teacherName
        });
      } else {
        console.warn(" No teacher assigned in enrollment data");
      }
      
      if (!userEnrollmentData) {
        console.log("User not enrolled, enrolling...");
        // User is not enrolled, enroll them
        await enrollUserInCourse();
      } else {
        // Update current test attempt
        if (userEnrollmentData.lastTestAttempt) {
          currentTestAttempt = userEnrollmentData.lastTestAttempt;
        }
        
        console.log(`Current progress: ${userEnrollmentData.progress}%`);
        console.log(`Completed lessons: ${userEnrollmentData.completedLessons?.length || 0}`);
        
        // Update progress display
        updateProgressDisplay();
        
        // Check certificate eligibility
        checkCertificateEligibility();
      }
    } else {
      console.log("User document doesn't exist or has no enrollments, enrolling...");
      // User document doesn't exist or has no enrollments, enroll them
      await enrollUserInCourse();
    }
    
    return userEnrollmentData;
  } catch (error) {
    console.error("Error loading user enrollment data:", error);
    return null;
  }
}

// Enroll user in course
async function enrollUserInCourse() {
  console.log("=== ENROLLING USER IN COURSE ===");
  
  if (!currentUser || !courseId) {
    console.error("Missing current user or course ID");
    return;
  }

  try {
    const userRef = doc(db, "users", currentUser.uid);
    const userSnap = await getDoc(userRef);
    
    // Check if user is already enrolled and has teacher data
    let existingEnrollmentData = null;
    if (userSnap.exists() && userSnap.data().enrollments) {
      existingEnrollmentData = userSnap.data().enrollments[courseId] || null;
    }
    
    // If user already has enrollment with teacher data, don't overwrite it
    if (existingEnrollmentData && (existingEnrollmentData.assignedTeacher || existingEnrollmentData.teacherName)) {
      userEnrollmentData = existingEnrollmentData;
      console.log("User already enrolled with teacher data");
      return;
    }
    
    // Only set default enrollment data if no existing enrollment
    const enrollmentData = {
      enrolledAt: new Date(),
      progress: 0,
      completedLessons: [],
      completedAssignments: [],
      lastAccessed: new Date()
    };

    console.log("Creating enrollment with data:", enrollmentData);

    // Use setDoc with merge to create or update the user document
    await setDoc(userRef, {
      enrollments: {
        [courseId]: enrollmentData
      }
    }, { merge: true });

    userEnrollmentData = enrollmentData;
    console.log("User enrolled successfully");
    
  } catch (error) {
    console.error("Error enrolling in course:", error);
  }
}

// Load instructor data
async function loadInstructorData() {
  console.log("=== LOADING INSTRUCTOR DATA ===");
  
  // Show loading state
  setInstructorData({
      name: "Loading instructor...",
      bio: "Please wait while we load instructor information"
    });

  let instructorData = null;

  try {
    // METHOD 1: Check enrollment data first (this is where your teacher data is stored from courses.html)
    if (userEnrollmentData) {
      console.log("Checking enrollment data for instructor...");
      // Check for assignedTeacher (from courses.html enrollment)
      if (userEnrollmentData.assignedTeacher) {
        instructorData = {
          name: userEnrollmentData.assignedTeacher.name || "Course Instructor",
          bio: userEnrollmentData.assignedTeacher.specialty || "Your assigned course instructor"
        };
        console.log("Found instructor in enrollment (assignedTeacher):", instructorData);
      }
      // Check for teacher data in enrollment (alternative structure)
      else if (userEnrollmentData.teacherName) {
        instructorData = {
          name: userEnrollmentData.teacherName,
          bio: "Your course instructor"
        };
        console.log("Found instructor in enrollment (teacherName):", instructorData);
      }
      // Check for selectedTeachers (from the selection process)
      else if (userEnrollmentData.selectedTeachers && userEnrollmentData.selectedTeachers.length > 0) {
        // Use the first selected teacher as fallback
        const firstTeacher = userEnrollmentData.selectedTeachers[0];
        instructorData = {
          name: firstTeacher.name || "Course Instructor",
          bio: firstTeacher.specialty || "Your course instructor"
        };
        console.log("Found instructor in enrollment (selectedTeachers):", instructorData);
      }
    }

    // METHOD 2: If no instructor data from enrollment, try course data
    if (!instructorData && courseData) {
      console.log("Checking course data for instructor...");
      // Check if instructor data is embedded in course
      if (courseData.instructor && typeof courseData.instructor === 'object') {
        instructorData = courseData.instructor;
        console.log("Found instructor in course (instructor object):", instructorData);
      } 
      // Check if instructor data is stored as separate fields in course
      else if (courseData.instructorName) {
        instructorData = {
          name: courseData.instructorName,
          bio: courseData.instructorBio || "Experienced instructor in this field"
        };
        console.log("Found instructor in course (instructorName):", instructorData);
      }
      // Try to fetch from "teachers" collection using course data
      else if (courseData.instructorId || courseData.teacherId) {
        const teacherId = courseData.instructorId || courseData.teacherId;
        console.log("Fetching instructor from teachers collection:", teacherId);
        
        try {
          const teacherDoc = await getDoc(doc(db, "teachers", teacherId));
          if (teacherDoc.exists()) {
            instructorData = teacherDoc.data();
            console.log("Found instructor in teachers collection:", instructorData);
          }
        } catch (error) {
          console.error("Error fetching from teachers collection:", error);
          // Continue with fallback
        }
      }
    }

    // METHOD 3: Default fallback if no instructor found
    if (!instructorData) {
      console.log("No instructor found, using default");
      instructorData = {
        name: "SkillUp Instructor",
        bio: "Professional instructor with industry experience"
      };
    }

    // Apply the instructor data
    setInstructorData(instructorData);

  } catch (error) {
    console.error("Error loading instructor data:", error);
    // Final fallback
    setInstructorData({
      name: "Course Instructor",
      bio: "Expert instructor for this course"
    });
  }
}

// Set instructor data in UI
function setInstructorData(instructorData) {
  const instructorName = document.getElementById("instructorName");
  const instructorBio = document.getElementById("instructorBio");
  const instructorAvatar = document.getElementById("instructorAvatar");
  const instructorNameMini = document.getElementById("instructorNameMini");
  const instructorBioMini = document.getElementById("instructorBioMini");

  if (!instructorName || !instructorBio) {
    console.error("Instructor elements not found in DOM");
    return;
  }

  const name = instructorData.name || instructorData.displayName || instructorData.fullName || "SkillUp Instructor";
  const bio = instructorData.bio || instructorData.biography || instructorData.about || "Professional instructor with industry experience";
  
  console.log(`Setting instructor UI: name="${name}", bio="${bio}"`);
  
  instructorName.textContent = name;
  instructorBio.textContent = bio;
  
  if (instructorNameMini) instructorNameMini.textContent = name;
  if (instructorBioMini) instructorBioMini.textContent = bio;
  
  // Set avatar
  if (instructorData.avatar || instructorData.photoURL || instructorData.profileImage) {
    const avatarUrl = instructorData.avatar || instructorData.photoURL || instructorData.profileImage;
    instructorAvatar.innerHTML = `<img src="${avatarUrl}" alt="${name}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
  } else {
    // Create colorful avatar based on name
    const colors = ['#4361ee', '#3a0ca3', '#7209b7', '#f72585', '#4cc9f0'];
    const color = colors[name.length % colors.length];
    instructorAvatar.style.background = `linear-gradient(45deg, ${color}, ${color}dd)`;
    instructorAvatar.textContent = name.charAt(0).toUpperCase();
    instructorAvatar.style.color = 'white';
    instructorAvatar.style.fontWeight = 'bold';
    instructorAvatar.style.fontSize = '28px';
    instructorAvatar.style.display = 'flex';
    instructorAvatar.style.alignItems = 'center';
    instructorAvatar.style.justifyContent = 'center';
  }
}

// Load assignments from Firestore
async function loadAssignments() {
  console.log("=== LOADING ASSIGNMENTS ===");
  
  try {
    const assignmentsRef = collection(db, "courses", courseId, "assignments");
    const assignmentsSnap = await getDocs(assignmentsRef);
    
    if (assignmentsSnap.empty) {
      console.log("No assignments found, using defaults");
      // Create default assignments if none exist
      courseAssignments = [
        {
          id: "assignment-1",
          title: "Basic Concepts Application",
          description: "Apply the basic concepts learned in the first 5 lectures to solve real-world problems.",
          points: 100,
          dueDate: "No due date",
          requirements: [
            "Complete all tasks described in the assignment PDF",
            "Submit your solution as a PDF document",
            "Include screenshots where applicable"
          ]
          }
      ];
    } else {
      // Load assignments
      courseAssignments = assignmentsSnap.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      console.log("Loaded assignments from Firestore:", courseAssignments);
    }
    
  } catch (error) {
    console.error("Error loading assignments:", error);
    // Use default assignments on error
    courseAssignments = [
      {
        id: "assignment-1",
        title: "Basic Concepts Application",
        description: "Apply the basic concepts learned in the first 5 lectures.",
        points: 100,
        dueDate: "No due date"
      }
    ];
  }
}

// Load resources from Firebase Storage - works with any notes filename
async function loadResources() {
  const resourcesGrid = document.getElementById("resourcesGrid");
  if (!resourcesGrid) return;
  
  resourcesGrid.innerHTML = "<div class='loading-text'>Loading course notes...</div>";

  try {
    // First, try to list all files in the course resources folder to find any PDF
    await findAndDisplayNotes();
    
  } catch (error) {
    console.error("Error loading resources:", error);
    showErrorState();
  }
}

// Find and display any PDF files in the resources folder
async function findAndDisplayNotes() {
  const resourcesGrid = document.getElementById("resourcesGrid");
  
  try {
    // List all files in the course resources folder
    const resourcesRef = ref(storage, `resources/course${courseId}`);
    const resourcesList = await listAll(resourcesRef);
    
    // Filter for PDF files (notes)
    const pdfFiles = resourcesList.items.filter(item => 
      item.name.toLowerCase().endsWith('.pdf')
    );
    
    if (pdfFiles.length > 0) {
      // Display all PDF files found
      displayNotesFiles(pdfFiles);
    } else {
      // No PDF files found, try alternative locations
      await checkAlternativeLocations();
    }
    
  } catch (error) {
    console.log(`No resources folder found for course${courseId}, trying alternative locations...`);
    await checkAlternativeLocations();
  }
}

// Display all PDF files found
async function displayNotesFiles(pdfFiles) {
  const resourcesGrid = document.getElementById("resourcesGrid");
  
  resourcesGrid.innerHTML = `
    <div class="resource-section">
      <div class="section-header">
        <i class="fas fa-file-pdf"></i>
        <h3>Course Notes & Materials</h3>
      </div>
    </div>
  `;
  
  const notesSection = resourcesGrid.querySelector('.resource-section');
  
  for (const fileRef of pdfFiles) {
    try {
      const url = await getDownloadURL(fileRef);
      const fileName = fileRef.name;
      const fileSize = await getFileSize(fileRef); // Optional: get file size
      
      const displayName = getDisplayName(fileName);
      
      const resourceItem = document.createElement('div');
      resourceItem.className = 'resource-item';
      resourceItem.innerHTML = `
        <div class="resource-icon">
          <i class="fas fa-file-pdf"></i>
        </div>
        <div class="resource-info">
          <h4>${displayName}</h4>
          <p>Course study material</p>
          <small>PDF  ${fileSize}</small>
        </div>
        <button class="btn-download" onclick="downloadResource('${url}', '${fileName}')">
          <i class="fas fa-download"></i> Download
        </button>
      `;
      
      notesSection.appendChild(resourceItem);
      
    } catch (error) {
      console.error(`Error loading file ${fileRef.name}:`, error);
    }
  }
  
  // If no PDFs were successfully loaded, show unavailable message
  if (notesSection.querySelectorAll('.resource-item').length === 0) {
    showUnavailableState();
  }
}

// Check alternative storage locations for notes
async function checkAlternativeLocations() {
  const resourcesGrid = document.getElementById("resourcesGrid");
  
  const alternativeLocations = [
    `resources/${courseId}`,           // resources/1/
    `course${courseId}/resources`,     // course1/resources/
    `${courseId}/resources`,           // 1/resources/
    `resources`,                       // resources/ (root)
    `course${courseId}`,               // course1/
    `${courseId}`                      // 1/
  ];
  
  for (const location of alternativeLocations) {
    try {
      console.log(`Checking location: ${location}`);
      const locationRef = ref(storage, location);
      const locationList = await listAll(locationRef);
      
      // Filter for PDF files
      const pdfFiles = locationList.items.filter(item => 
        item.name.toLowerCase().endsWith('.pdf')
      );
      
      if (pdfFiles.length > 0) {
        console.log(` Found ${pdfFiles.length} PDF files in: ${location}`);
        await displayNotesFiles(pdfFiles);
        return; // Exit if found
      }
      
    } catch (error) {
      console.log(` No access or no files in: ${location}`);
      continue;
    }
  }
  
  // If no PDFs found anywhere, show unavailable message
  showUnavailableState();
}

// Helper function to get display name from filename
function getDisplayName(fileName) {
  // Remove file extension
  let displayName = fileName.replace(/\.pdf$/i, '');
  
  // Replace underscores and hyphens with spaces
  displayName = displayName.replace(/[_-]/g, ' ');
  
  // Capitalize first letter of each word
  displayName = displayName.replace(/\b\w/g, l => l.toUpperCase());
  
  // Common name mappings
  const nameMap = {
    'notes': 'Course Notes',
    'lecture notes': 'Lecture Notes', 
    'study guide': 'Study Guide',
    'course material': 'Course Material',
    'cheat sheet': 'Cheat Sheet',
    'reference': 'Reference Guide'
  };
  
  return nameMap[displayName.toLowerCase()] || displayName;
}

// Helper function to get file size (optional)
async function getFileSize(fileRef) {
  try {
    const metadata = await getMetadata(fileRef);
    const sizeInMB = (metadata.size / (1024 * 1024)).toFixed(1);
    return `${sizeInMB} MB`;
  } catch (error) {
    return 'PDF Document';
  }
}

// Show unavailable state
function showUnavailableState() {
  const resourcesGrid = document.getElementById("resourcesGrid");
  resourcesGrid.innerHTML = `
    <div class="resource-section">
      <div class="section-header">
        <i class="fas fa-file-pdf"></i>
        <h3>Course Notes</h3>
      </div>
      <div class="resource-item">
        <div class="resource-info">
          <h4>No Notes Available</h4>
          <p>Course notes will be added by your instructor</p>
          <small>Check back later for updates</small>
        </div>
        <button class="btn-download" disabled>
          <i class="fas fa-download"></i> Not Available
        </button>
      </div>
    </div>
  `;
}

// Show error state
function showErrorState() {
  const resourcesGrid = document.getElementById("resourcesGrid");
  resourcesGrid.innerHTML = `
    <div class="resource-section">
      <div class="section-header">
        <i class="fas fa-file-pdf"></i>
        <h3>Course Notes</h3>
      </div>
      <div class="resource-item">
        <div class="resource-info">
          <h4>Error Loading Notes</h4>
          <p>Unable to load course notes at this time</p>
          <small>Please try again later</small>
        </div>
        <button class="btn-download" disabled>
          <i class="fas fa-download"></i> Unavailable
        </button>
      </div>
    </div>
  `;
}

// Load notes
async function loadNotes() {
  // Placeholder function - implement notes loading logic here
  console.log("Loading notes...");
}

// Load certificates
async function loadCertificates() {
  // Placeholder function - implement certificates loading logic here
  console.log("Loading certificates...");
}

// Check certificate eligibility
function checkCertificateEligibility() {
  // This would check if the user is eligible for a certificate
  // For now, we'll just check if progress is 100%
  if (userEnrollmentData?.progress === 100) {
    console.log("User is eligible for certificate");
    // Show notification only if not already shown
    const notificationKey = 'certificate-eligible';
    if (!shownNotifications.has(notificationKey)) {
      addNotification({
        title: "Certificate Eligible",
        message: "You are eligible for a certificate! Complete the final test to receive it.",
        type: "certificate_eligible",
        courseId: courseId,
        read: false
      });
      shownNotifications.add(notificationKey);
    }
  }
}

// Check if assignments should be unlocked based on lecture completion AND assignment passing
function checkAssignmentUnlock() {
  if (!userEnrollmentData || !allLectures.length) return;
  
  const completedLessons = userEnrollmentData.completedLessons || [];
  const passedAssignments = getPassedAssignmentsCount();
  const totalAssignments = courseAssignments.length;
  
  console.log(`Checking test unlock: ${completedLessons.length}/${allLectures.length} lectures, ${passedAssignments}/${totalAssignments} assignments passed`);
  
  // Check if all lectures are completed and all assignments are passed
  if (completedLessons.length >= allLectures.length && passedAssignments >= totalAssignments) {
    console.log("All requirements met, unlocking final test");
    unlockFinalTest();
  } else {
    // Update test section to show current progress
    updateTestSectionUI();
  }
}

// Unlock final test
function unlockFinalTest() {
  console.log("=== UNLOCKING FINAL TEST ===");
  
  // Check if test is already evaluated and passed
  if (testEvaluationData && testEvaluationData.status === 'evaluated' && testEvaluationData.finalGrade >= 70) {
    console.log("Test already passed");
    // Test already passed, show certificate option
    updateTestSectionUI();
    return;
  }
  
  // Check if test is submitted but not evaluated
  if (testEvaluationData && testEvaluationData.status === 'submitted') {
    console.log("Test submitted but not evaluated");
    // Test submitted but not evaluated yet
    updateTestSectionUI();
    return;
  }
  
  // Test not taken yet or failed - show take test option
  finalTestSection.classList.remove('locked');
  finalTestSection.classList.add('unlocked');
  
  const testIcon = finalTestSection.querySelector('.final-test-icon');
  const testTitle = finalTestSection.querySelector('.final-test-title');
  const testDescription = finalTestSection.querySelector('.final-test-description');
  const testButton = finalTestSection.querySelector('.btn-take-test');
  
  if (testIcon) testIcon.innerHTML = '<i class="fas fa-unlock"></i>';
  if (testTitle) testTitle.textContent = 'Final Test Available';
  if (testDescription) testDescription.textContent = 'All lectures and assignments completed! You can now take the final test.';
  if (testButton) {
    testButton.disabled = false;
    testButton.textContent = 'Take Final Test';
  }
  
  console.log("Final test unlocked");
  
  // Show notification - only if not already shown
  const notificationKey = 'final-test-unlocked';
  if (!shownNotifications.has(notificationKey)) {
    addNotification({
      title: "Final Test Unlocked",
      message: "Final test unlocked! Complete the test to get your certificate.",
      type: "test_unlocked",
      courseId: courseId,
      read: false
    });
    shownNotifications.add(notificationKey);
  }
}

// Update test section UI based on evaluation status
function updateTestSectionUI() {
  if (!finalTestSection) return;

  console.log("=== UPDATING TEST SECTION UI ===");
  console.log("Test evaluation data:", testEvaluationData);
  console.log("User enrollment data:", userEnrollmentData);

  // Handle different data structures for test evaluation
  const testStatus = testEvaluationData?.status || testEvaluationData?.testStatus;
  const finalGrade = testEvaluationData?.finalGrade || testEvaluationData?.grade;
  const passed = finalGrade >= 70;
  
  console.log(`Test status: ${testStatus}, Grade: ${finalGrade}, Passed: ${passed}`);
  
  // PRIORITY 1: Check if certificate is already awarded - this should always take precedence
  if (userEnrollmentData?.certificateAwarded) {
    console.log("Certificate already awarded");
    finalTestSection.classList.remove('locked');
    finalTestSection.classList.add('unlocked', 'passed');
    
    finalTestSection.innerHTML = `
      <div class="final-test-icon">
        <i class="fas fa-trophy"></i>
      </div>
      <h3 class="final-test-title">Course Completed!</h3>
      <p class="final-test-description">
        Congratulations! You have successfully completed this course and earned a certificate.
      </p>
      <div class="test-actions">
        <button class="btn-take-test" id="viewCertificateBtn">
          <i class="fas fa-award"></i> View Certificate
        </button>
        <button class="btn-take-test" id="viewTestResultsBtn" style="background: linear-gradient(45deg, #4bb71b, #28a745); margin-left: 10px;">
          <i class="fas fa-chart-bar"></i> View Test Results
        </button>
      </div>
    `;

    // Add event listeners for certificate and test results buttons
    document.getElementById('viewCertificateBtn')?.addEventListener('click', generateCertificate);
    document.getElementById('viewTestResultsBtn')?.addEventListener('click', showTestResults);
    return; // Exit early - don't check other conditions
  }

  // If test is evaluated and passed, show certificate option
  if ((testStatus === 'evaluated' || testStatus === 'completed') && passed) {
    console.log("Test passed, showing certificate option");
    finalTestSection.classList.remove('locked');
    finalTestSection.classList.add('unlocked', 'passed');
    
    finalTestSection.innerHTML = `
      <div class="final-test-icon">
        <i class="fas fa-trophy"></i>
      </div>
      <h3 class="final-test-title">Test Passed!</h3>
      <p class="final-test-description">
        Congratulations! You passed the test with a score of ${finalGrade}%. 
        ${testEvaluationData.feedback ? `Instructor feedback: ${testEvaluationData.feedback}` : ''}
      </p>
      <p>Attempt: ${currentTestAttempt} of ${maxTestAttempts}</p>
      <div class="test-actions">
        <button class="btn-take-test" id="viewCertificateBtn">
          <i class="fas fa-award"></i> View Certificate
        </button>
        <button class="btn-take-test" id="viewTestResultsBtn" style="background: linear-gradient(45deg, #4bb71b, #28a745); margin-left: 10px;">
          <i class="fas fa-chart-bar"></i> View Test Results
        </button>
        ${currentTestAttempt < maxTestAttempts ? `
          <button class="btn-take-test secondary" id="retakeTestBtn" style="background: var(--gray); margin-left: 10px;">
            <i class="fas fa-redo"></i> Retake Test
          </button>
        ` : ''}
      </div>
    `;

    // Add event listeners
    document.getElementById('viewCertificateBtn')?.addEventListener('click', generateCertificate);
    document.getElementById('viewTestResultsBtn')?.addEventListener('click', showTestResults);
    document.getElementById('retakeTestBtn')?.addEventListener('click', () => {
      if (currentTestAttempt < maxTestAttempts) {
        openTestWindow();
      } else {
        addNotification({
          title: "Maximum Attempts Reached",
          message: "Maximum test attempts reached.",
          type: "test_error",
          courseId: courseId,
          read: false
        });
      }
    });
  } 
  // If test is evaluated but failed
  else if ((testStatus === 'evaluated' || testStatus === 'completed') && !passed) {
    console.log("Test failed");
    finalTestSection.classList.remove('locked');
    finalTestSection.classList.add('unlocked', 'failed');
    
    finalTestSection.innerHTML = `
      <div class="final-test-icon">
        <i class="fas fa-redo"></i>
      </div>
      <h3 class="final-test-title">Test Failed</h3>
      <p class="final-test-description">
        Your score: ${finalGrade}% (Minimum passing: 70%). 
        ${testEvaluationData.feedback ? `Instructor feedback: ${testEvaluationData.feedback}` : ''}
        ${currentTestAttempt < maxTestAttempts ? `Attempts remaining: ${maxTestAttempts - currentTestAttempt}` : 'No attempts remaining'}
      </p>
      <p>Attempt: ${currentTestAttempt} of ${maxTestAttempts}</p>
      <div class="test-actions">
        <button class="btn-take-test" id="viewTestResultsBtn">
          <i class="fas fa-chart-bar"></i> View Test Results
        </button>
        ${currentTestAttempt < maxTestAttempts ? `
          <button class="btn-take-test" id="retakeTestBtn" style="margin-left: 10px;">
            <i class="fas fa-redo"></i> Retake Test
          </button>
        ` : ''}
      </div>
    `;

    // Add event listeners
    document.getElementById('viewTestResultsBtn')?.addEventListener('click', showTestResults);
    document.getElementById('retakeTestBtn')?.addEventListener('click', () => {
      if (currentTestAttempt < maxTestAttempts) {
        openTestWindow();
      } else {
        addNotification({
          title: "Maximum Attempts Reached",
          message: "Maximum test attempts reached.",
          type: "test_error",
          courseId: courseId,
          read: false
        });
      }
    });
  }
  // If test is submitted but not evaluated yet
  else if (testStatus === 'submitted' || userEnrollmentData?.testSubmitted) {
    console.log("Test submitted, awaiting evaluation");
    finalTestSection.classList.remove('locked');
    finalTestSection.classList.add('unlocked', 'submitted');
    
    finalTestSection.innerHTML = `
      <div class="final-test-icon">
        <i class="fas fa-clock"></i>
      </div>
      <h3 class="final-test-title">Test Under Review</h3>
      <p class="final-test-description">
        Your test has been submitted and is currently being evaluated by the instructor.
        You will be notified when the evaluation is complete.
      </p>
      <p>Attempt: ${currentTestAttempt} of ${maxTestAttempts}</p>
    `;
  }
  // Check if all requirements are met for test unlock
  else if (checkAllAssignmentsPassed() && 
           userEnrollmentData?.completedLessons?.length >= allLectures.length) {
    console.log("All requirements met, test available");
    // All requirements met, test is available
    finalTestSection.classList.remove('locked');
    finalTestSection.classList.add('unlocked');
    
    finalTestSection.innerHTML = `
      <div class="final-test-icon">
        <i class="fas fa-unlock"></i>
      </div>
      <h3 class="final-test-title">Final Test Available</h3>
      <p class="final-test-description">
        All lectures completed and assignments passed! You can now take the final test.
      </p>
      <p>Attempt: ${currentTestAttempt + 1} of ${maxTestAttempts}</p>
      <button class="btn-take-test" id="takeTestButton">
        Take Final Test
      </button>
    `;
    
    // Reattach event listener
    const takeTestBtn = document.getElementById('takeTestButton');
    if (takeTestBtn) {
      takeTestBtn.addEventListener('click', openTestWindow);
    }
  }
  // Test is locked - show requirements
  else {
    console.log("Test locked - requirements not met");
    finalTestSection.classList.remove('unlocked');
    finalTestSection.classList.add('locked');
    
    const completedLectures = userEnrollmentData?.completedLessons?.length || 0;
    const totalLectures = allLectures.length;
    const passedAssignments = getPassedAssignmentsCount();
    const totalAssignments = courseAssignments.length;
    
    finalTestSection.innerHTML = `
      <div class="final-test-icon">
        <i class="fas fa-lock"></i>
      </div>
      <h3 class="final-test-title">Final Test Locked</h3>
      <p class="final-test-description">
        Complete all requirements to unlock the final test:
      </p>
      <div style="text-align: left; margin: 15px 0;">
        <div style="display: flex; justify-content: space-between; margin: 5px 0;">
          <span>Complete all lectures:</span>
          <span>${completedLectures}/${totalLectures}</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin: 5px 0;">
          <span>Pass all assignments (70%):</span>
          <span>${passedAssignments}/${totalAssignments}</span>
        </div>
      </div>
      <button class="btn-take-test" disabled>Take Final Test</button>
    `;
  }
}

// Open test in a new window
function openTestWindow() {
  console.log("=== OPENING TEST WINDOW ===");
  
  // *** CRITICAL: Verify we have the correct courseId ***
  console.log("Current courseId:", courseId);
  console.log("User enrollment data:", userEnrollmentData);
  console.log("Teacher info:", {
    teacherId: userEnrollmentData?.teacherId,
    teacherName: userEnrollmentData?.teacherName
  });
  
  // Check if user has exceeded maximum attempts
  if (currentTestAttempt >= maxTestAttempts) {
    addNotification({
      title: "Test Attempts Exceeded",
      message: `Maximum test attempts (${maxTestAttempts}) reached.`,
      type: "test_error",
      courseId: courseId,
      read: false
    });
    return;
  }

  // Check if test is already passed
  if (userEnrollmentData?.testPassed) {
    addNotification({
      title: "Test Already Passed",
      message: "You have already passed the test!",
      type: "test_success",
      courseId: courseId,
      read: false
    });
    return;
  }

  console.log(`Opening test window - Attempt ${currentTestAttempt + 1} of ${maxTestAttempts}`);

  // *** CRITICAL FIX: Pass courseId in URL ***
  const testUrl = `test.html?courseId=${courseId}`;
  console.log("Opening test URL:", testUrl);
  
  // Open test.html in a new window with courseId parameter
  const testWindow = window.open(testUrl, 'TestWindow', 'width=1200,height=800,resizable=yes,scrollbars=yes');
  
if (testWindow) {
    // *** Pass complete course and teacher data to the test window ***
    testWindow.courseData = {
      courseId: courseId,
      courseName: courseData?.name || 'Unknown Course',
      teacherId: userEnrollmentData?.teacherId,
      teacherName: userEnrollmentData?.teacherName,
      userId: currentUser.uid,
      userName: currentUser.displayName || currentUser.email,
      attemptNumber: currentTestAttempt + 1,
      maxAttempts: maxTestAttempts
    };
    console.log("=== TEST WINDOW DATA ===");
    console.log("Course ID:", testWindow.courseData.courseId);
    console.log("Teacher ID:", testWindow.courseData.teacherId);
    console.log("Teacher Name:", testWindow.courseData.teacherName);
    console.log("Full data:", testWindow.courseData);
  } else {
    addNotification({
      title: "Popup Blocked",
      message: "Please allow popups for this site to take the test.",
      type: "test_error",
      courseId: courseId,
      read: false
    });
  }
}

// Set up message listener for test window communication
function setupTestWindowListener() {
  console.log("Setting up test window listener");
  
  window.addEventListener('message', async function(event) {
    // Check if the message is from our test window
    if (event.data.type === 'TEST_SUBMITTED') {
      console.log("Test submission message received:", event.data);
      
      // Update test status to "pending evaluation"
      await updateTestStatusAfterSubmission(event.data);
      
      // Show success message - only if not already shown
      const notificationKey = `test-submitted-${Date.now()}`;
      if (!shownNotifications.has(notificationKey)) {
        // Add notification to user's notifications
        await addNotification({
          title: "Test Submitted",
          message: "Your test has been submitted and is awaiting evaluation.",
          type: "test_submission",
          courseId: courseId,
          read: false
        });
        shownNotifications.add(notificationKey);
      }
      
      // Reload test evaluation data to update UI
      await loadTestEvaluationData();
    }
  });
}

// Update test status after submission
async function updateTestStatusAfterSubmission(testData) {
  console.log("=== UPDATING TEST STATUS AFTER SUBMISSION ===");
  
  if (!currentUser || !courseId) return;

  try {
    const userRef = doc(db, "users", currentUser.uid);
    
    // Update user's test status
    await updateDoc(userRef, {
      [`enrollments.${courseId}.testSubmitted`]: true,
      [`enrollments.${courseId}.testSubmittedAt`]: Timestamp.now(),
      [`enrollments.${courseId}.lastTestAttempt`]: currentTestAttempt + 1
    });
    
    // Update local data
    userEnrollmentData.testSubmitted = true;
    userEnrollmentData.testSubmittedAt = new Date();
    userEnrollmentData.lastTestAttempt = currentTestAttempt + 1;
    
    // Increment test attempt counter
    currentTestAttempt++;
    
    console.log(`Test status updated - Attempt: ${currentTestAttempt}`);
    
    // Update test section UI
    updateTestSectionUI();
    
  } catch (error) {
    console.error("Error updating test status:", error);
  }
}

// Load test evaluation data
async function loadTestEvaluationData() {
  console.log("=== LOADING TEST EVALUATION DATA ===");
  
  if (!currentUser || !courseId) return;

  try {
    const testSubmissionsQuery = query(
      collection(db, "testSubmissions"), 
      where("courseId", "==", courseId),
      where("studentId", "==", currentUser.uid),
      orderBy("submittedAt", "desc")
    );

    const testSubmissionsSnap = await getDocs(testSubmissionsQuery);
    
    if (!testSubmissionsSnap.empty) {
      // Get the latest test submission
      const latestSubmission = testSubmissionsSnap.docs[0].data();
      testEvaluationData = latestSubmission;
      
      console.log("Test evaluation data loaded:", testEvaluationData);
      
      // Update current test attempt based on submissions count
      currentTestAttempt = testSubmissionsSnap.docs.length;
      console.log(`Current test attempt: ${currentTestAttempt}`);
      
      // Update user enrollment with test evaluation if evaluated
      if ((testEvaluationData.status === "evaluated" || testEvaluationData.status === "completed") && 
          (testEvaluationData.finalGrade !== undefined || testEvaluationData.grade !== undefined)) {
        updateUserTestEvaluation(testEvaluationData);
      }
      
      // Update test section UI based on evaluation
      updateTestSectionUI();
    } else {
      console.log("No test submissions found");
      // No test submissions yet
      updateTestSectionUI();
    }
  } catch (error) {
    console.error("Error loading test evaluation data:", error);
    updateTestSectionUI();
  }
}

// Update user enrollment with test evaluation
async function updateUserTestEvaluation(testSubmissionData) {
  console.log("=== UPDATING USER TEST EVALUATION ===");
  
  if (!currentUser || !courseId) return;

  try {
    const userRef = doc(db, "users", currentUser.uid);
    
    // Handle different data structures
    const finalGrade = testSubmissionData.finalGrade || testSubmissionData.grade;
    const feedback = testSubmissionData.feedback || testSubmissionData.instructorFeedback || "No feedback provided.";
    const passed = finalGrade >= 70;
    
    console.log(`Test evaluation: Grade=${finalGrade}%, Passed=${passed}`);
    
    // Check if the test was already evaluated to prevent duplicate processing
    const wasAlreadyEvaluated = userEnrollmentData.testEvaluated;
    const wasAlreadyNotified = shownNotifications.has(`test-evaluated-${finalGrade}`);
    
    // Update Firestore
    await updateDoc(userRef, {
      [`enrollments.${courseId}.testEvaluated`]: true,
      [`enrollments.${courseId}.testGrade`]: finalGrade,
      [`enrollments.${courseId}.testFeedback`]: feedback,
      [`enrollments.${courseId}.testPassed`]: passed,
      [`enrollments.${courseId}.lastTestAttempt`]: currentTestAttempt
    });

    // Update local data
    userEnrollmentData.testEvaluated = true;
    userEnrollmentData.testGrade = finalGrade;
    userEnrollmentData.testFeedback = feedback;
    userEnrollmentData.testPassed = passed;
    userEnrollmentData.lastTestAttempt = currentTestAttempt;
    
    console.log("Test evaluation data updated in user enrollment");
    
    // Update progress display (test contributes 10% to progress)
    await updateProgressInFirestore();
    updateProgressDisplay();
    
    // Show notification only once
    if (!wasAlreadyEvaluated && !wasAlreadyNotified) {
      const notificationKey = `test-evaluated-${finalGrade}`;
      shownNotifications.add(notificationKey);
      
      if (passed) {
        await addNotification({
          title: "Test Passed",
          message: `Congratulations! You passed the final test with ${finalGrade}%`,
          type: "test_success",
          courseId: courseId,
          read: false
        });
        
        // Award certificate if all requirements are met
        if (userEnrollmentData.progress === 100) {
          await awardCertificate();
        }
      } else {
        await addNotification({
          title: "Test Evaluated",
          message: `Test evaluated. Your score: ${finalGrade}%. You can retake the test.`,
          type: "test_warning",
          courseId: courseId,
          read: false
        });
      }
    }
    
  } catch (error) {
    console.error("Error updating test evaluation:", error);
  }
}

// NEW: Show test results in modal
function showTestResults() {
  console.log("=== SHOWING TEST RESULTS ===");
  
  if (!testEvaluationData) {
    console.error("No test evaluation data");
    alert("No test results available yet.");
    return;
  }

  const finalGrade = testEvaluationData.grade || testEvaluationData.finalGrade;
  const passed = testEvaluationData.isPass || finalGrade >= 70;
  const feedback = testEvaluationData.feedback || 'No overall feedback provided.';
  const answers = testEvaluationData.answers || [];
  const evaluations = testEvaluationData.evaluations || [];
  
  console.log(`Showing test results: Grade=${finalGrade}%, Questions=${answers.length}`);
  
  let resultsHTML = `
    <div class="test-results-summary">
      <h3>Test Evaluation Summary</h3>
      <div class="test-results-score">${finalGrade}%</div>
      <div class="test-results-status ${passed ? 'passed' : 'failed'}">
        ${passed ? ' PASSED' : ' FAILED'}
      </div>
      <div class="test-results-details">
        <div class="test-detail-item">
          <div class="test-detail-label">Attempt</div>
          <div class="test-detail-value">${testEvaluationData.attemptNumber || currentTestAttempt} of ${testEvaluationData.maxAttempts || maxTestAttempts}</div>
        </div>
        <div class="test-detail-item">
          <div class="test-detail-label">Passing Grade</div>
          <div class="test-detail-value">70%</div>
        </div>
      </div>
    </div>
    
    <div class="test-results-feedback">
      <h4><i class="fas fa-comment-dots"></i> Overall Instructor Feedback</h4>
      <div class="test-feedback-content">${feedback}</div>
    </div>
  `;
  
  if (answers && answers.length > 0) {
    resultsHTML += `
      <div class="test-question-results">
        <h4><i class="fas fa-list-ol"></i> Question-by-Question Breakdown</h4>
    `;
    
    answers.forEach((question, index) => {
      const questionNumber = index + 1;
      const evaluation = evaluations[index] || {};
      const earned = evaluation.score || 0;
      const total = evaluation.maxScore || question.points || 0;
      const correct = earned === total;
      const studentAnswer = question.answer || 'No answer provided';
      const questionFeedback = evaluation.feedback || 'No specific feedback provided for this question.';
      
      resultsHTML += `
        <div class="test-question-result-item ${correct ? 'correct' : 'incorrect'}">
          <div class="test-question-result-header">
            <div class="test-question-result-text">
              <strong>Question ${questionNumber}:</strong> ${question.questionText || 'No question text'}
            </div>
            <div class="test-question-result-points">
              ${correct ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>'} 
              ${earned}/${total} pts
            </div>
          </div>
          <div class="test-question-result-answer">
            <div class="test-answer-label"><strong>Your Answer:</strong></div>
            <div class="test-answer-value">${studentAnswer}</div>
          </div>
          <div class="test-question-result-comment">
            <div class="test-comment-label"><i class="fas fa-comment"></i> Instructor Feedback:</div>
            <div class="test-comment-text">${questionFeedback}</div>
          </div>
        </div>
      `;
    });
    
    resultsHTML += `</div>`;
  }
  
  if (testResultsContent) {
    testResultsContent.innerHTML = resultsHTML;
    testResultsModal.classList.add('active');
    console.log("Test results modal opened");
  } else {
    console.error("Test results content element not found");
  }
}
// Load assignments for the assignments tab
async function loadAssignmentsForTab() {
  console.log("=== LOADING ASSIGNMENTS FOR TAB ===");
  
  if (!assignmentsContainer) return;
  
  assignmentsContainer.innerHTML = "<div class='loading-text'>Loading assignments...</div>";
  
  try {
    // Ensure we have assignments data
    if (courseAssignments.length === 0) {
      await loadAssignments();
    }
    
    // Ensure we have user enrollment data
    if (!userEnrollmentData) {
      await loadUserEnrollmentData();
    }
    
    if (courseAssignments.length === 0) {
      assignmentsContainer.innerHTML = "<p>No assignments available for this course yet.</p>";
      return;
    }
    
    console.log(`Displaying ${courseAssignments.length} assignments`);
    
    // Create assignments list - SIMPLIFIED without Q/A sections
    let assignmentsHTML = '';
    
    courseAssignments.forEach((assignment, index) => {
      const assignmentNumber = index + 1;
      
      // Check assignment status using real-time data
      const isCompleted = userEnrollmentData?.completedAssignments?.includes(assignment.id) || false;
      const isEvaluated = userEnrollmentData?.evaluatedAssignments?.includes(assignment.id) || false;
      const grade = userEnrollmentData?.assignmentGrades ? userEnrollmentData.assignmentGrades[assignment.id] : null;
      const feedback = userEnrollmentData?.assignmentFeedback ? userEnrollmentData.assignmentFeedback[assignment.id] : null;
      
      console.log(`Assignment ${assignment.id}: completed=${isCompleted}, evaluated=${isEvaluated}, grade=${grade}`);
      
      // Determine status class and text
      let statusClass = 'pending';
      let statusText = 'Not Started';
      let statusIcon = '';
      
      if (isEvaluated && grade !== null) {
        statusClass = 'evaluated';
        statusText = 'Evaluated';
        statusIcon = '';
      } else if (isCompleted) {
        statusClass = 'submitted';
        statusText = 'Submitted';
        statusIcon = '';
      }
      
      assignmentsHTML += `
        <div class="assignment-item ${statusClass}" data-assignment-id="${assignment.id}">
          <div class="assignment-header">
            <div class="assignment-status">${statusIcon}</div>
            <div class="assignment-info">
              <div class="assignment-title">
                Assignment ${assignmentNumber}: 
                <span class="assignment-status-badge status-${statusClass.replace('-', '')}">${statusText}</span>
                ${grade !== null ? `<span style="margin-left: 10px; color: var(--success); font-weight: bold;">${grade}%</span>` : ''}
              </div>
              <div class="assignment-details">${assignment.points || 100} points  Due: ${assignment.dueDate || "No due date"}</div>
            </div>
            <span class="expand-icon"></span>
          </div>
          <div class="assignment-content">
            <div class="assignment-description">${assignment.description || "No description available"}</div>
            
            ${!isCompleted && !isEvaluated ? `
              <div class="assignment-requirements">
                <h4><i class="fas fa-list-check"></i> Requirements</h4>
                <ul>
                  ${assignment.requirements ? assignment.requirements.map(req => `<li>${req}</li>`).join('') : '<li>Complete all requirements listed in the assignment</li>'}
                </ul>
              </div>
            ` : ''}
            
            ${isCompleted && !isEvaluated ? `
              <div class="evaluation-status">
                <h4><i class="fas fa-clock"></i> Evaluation Status</h4>
                <p class="evaluation-details">Your submission is pending evaluation by the instructor. You will be notified when it's evaluated.</p>
              </div>
            ` : ''}
            
            ${isEvaluated && grade !== null ? `
              <div class="evaluation-status">
                <h4><i class="fas fa-check-circle"></i> Evaluation Complete</h4>
                <div class="grade ${grade >= 70 ? 'passed' : 'failed'}">Grade: ${grade}/100</div>
                <div class="feedback">
                  <strong>Instructor Feedback:</strong>
                  <p>${feedback || 'No feedback provided.'}</p>
                </div>
              </div>
            ` : ''}
            
            <div class="assignment-actions">
              <button class="btn-view-assignment" data-assignment-id="${assignment.id}">
                <i class="fas fa-external-link-alt"></i> 
                ${isCompleted ? 'View Submission' : 'Open Assignment'}
              </button>
              
              ${isEvaluated && grade !== null && grade < 70 ? `
                <button class="btn-resubmit" data-assignment-id="${assignment.id}" style="background: linear-gradient(45deg, #ffc107, #ffb300); color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer;">
                  <i class="fas fa-redo"></i> Resubmit Assignment
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    });
    
    assignmentsContainer.innerHTML = assignmentsHTML;
    
    // Add event listeners for assignment items
    document.querySelectorAll('.assignment-header').forEach(header => {
      header.addEventListener('click', function() {
        const assignmentItem = this.closest('.assignment-item');
        assignmentItem.classList.toggle('expanded');
      });
    });
    
    // Add event listeners for view assignment buttons
    document.querySelectorAll('.btn-view-assignment').forEach(button => {
      button.addEventListener('click', function() {
        const assignmentId = this.getAttribute('data-assignment-id');
        const isCompleted = userEnrollmentData?.completedAssignments?.includes(assignmentId);
        
        console.log(`View assignment clicked: ${assignmentId}, completed: ${isCompleted}`);
        
        if (isCompleted) {
          // Show submission details in modal
          showAssignmentSubmission(assignmentId);
        } else {
          // Redirect to assignment.html for new submissions
          window.location.href = `assignment.html?courseId=${courseId}&assignmentId=${assignmentId}`;
        }
      });
    });
    
    // Add event listeners for resubmit buttons
    document.querySelectorAll('.btn-resubmit').forEach(button => {
      button.addEventListener('click', function() {
        const assignmentId = this.getAttribute('data-assignment-id');
        console.log(`Resubmit assignment clicked: ${assignmentId}`);
        window.location.href = `assignment.html?courseId=${courseId}&assignmentId=${assignmentId}&resubmit=true`;
      });
    });
    
  } catch (error) {
    console.error("Error loading assignments:", error);
    assignmentsContainer.innerHTML = "<p>Error loading assignments. Please try again.</p>";
  }
}

// Update assignments UI in the assignments tab
function updateAssignmentsUI() {
  console.log("=== UPDATING ASSIGNMENTS UI ===");
  
  // Only update if assignments tab is currently active
  if (document.getElementById('assignments').classList.contains('active')) {
    loadAssignmentsForTab();
  }
  
  // Always update the progress section
  updateAssignmentsProgress();
  updateProgressDisplay();
  checkAssignmentUnlock();
}

// NEW: Show assignment submission details
function showAssignmentSubmission(assignmentId) {
  console.log(`=== SHOWING ASSIGNMENT SUBMISSION: ${assignmentId} ===`);
  
  // Get assignment data
  const assignment = courseAssignments.find(a => a.id === assignmentId);
  if (!assignment) {
    console.error("Assignment not found");
    alert("Assignment data not found.");
    return;
  }
  
  // Get submission data from Firestore
  fetchSubmissionData(assignmentId);
}

// NEW: Fetch and display submission data from Firestore
async function fetchSubmissionData(assignmentId) {
  console.log(`Fetching submission data for assignment: ${assignmentId}`);
  
  try {
    // Query submissions collection
    const submissionsQuery = query(
      collection(db, "submissions"),
      where("courseId", "==", courseId),
      where("studentId", "==", currentUser.uid),
      where("assignmentId", "==", assignmentId),
      orderBy("submittedAt", "desc"),
      limit(1)
    );
    
    const submissionsSnap = await getDocs(submissionsQuery);
    
    if (submissionsSnap.empty) {
      alert("No submission found for this assignment.");
      return;
    }
    
    // Get the latest submission
    const submissionData = submissionsSnap.docs[0].data();
    const assignment = courseAssignments.find(a => a.id === assignmentId);
    
    const grade = submissionData.grade;
    const feedback = submissionData.feedback;
    const isEvaluated = submissionData.evaluated;
    const answers = submissionData.answers || [];
    const evaluations = submissionData.evaluations || [];
    
    console.log(`Submission data: grade=${grade}, isEvaluated=${isEvaluated}, answers=${answers.length}`);
    
    let submissionHTML = `
      <div class="submission-details">
        <h4><i class="fas fa-info-circle"></i> Assignment Details</h4>
        <div class="submission-details-grid">
          <div class="submission-detail-item">
            <div class="submission-detail-label">Assignment Title</div>
            <div class="submission-detail-value">${assignment.title || 'Untitled Assignment'}</div>
          </div>
          <div class="submission-detail-item">
            <div class="submission-detail-label">Points</div>
            <div class="submission-detail-value">${submissionData.totalPoints || 100}</div>
          </div>
          <div class="submission-detail-item">
            <div class="submission-detail-label">Due Date</div>
            <div class="submission-detail-value">${assignment.dueDate || 'No due date'}</div>
          </div>
          <div class="submission-detail-item">
            <div class="submission-detail-label">Status</div>
            <div class="submission-detail-value">${isEvaluated ? 'Evaluated' : 'Submitted'}</div>
          </div>
        </div>
      </div>
    `;
    
    if (isEvaluated && grade !== undefined) {
      const passed = submissionData.isPass || grade >= 70;
      submissionHTML += `
        <div class="submission-grade">
          <h4>Assignment Grade</h4>
          <div class="grade-display">${grade}%</div>
          <div class="grade-status ${passed ? 'passed' : 'failed'}">
            ${passed ? ' PASSED' : ' FAILED'}
          </div>
          <p>Minimum passing grade: 70%</p>
        </div>
        
        <div class="submission-feedback">
          <h4><i class="fas fa-comment"></i> Overall Instructor Feedback</h4>
          <div class="feedback-content">${feedback || 'No feedback provided.'}</div>
        </div>
      `;
    } else {
      submissionHTML += `
        <div class="submission-grade">
          <h4>Assignment Status</h4>
          <div class="grade-status" style="color: #ffc107;">SUBMITTED</div>
          <p>Your assignment has been submitted and is awaiting evaluation by the instructor.</p>
        </div>
      `;
    }
    
    // Add question-specific feedback using evaluations array
    if (answers && answers.length > 0 && isEvaluated) {
      submissionHTML += `
        <div class="question-feedback-list">
          <h4><i class="fas fa-list-check"></i> Question-by-Question Feedback</h4>
      `;
      
      answers.forEach((question, index) => {
        const questionNumber = index + 1;
        const evaluation = evaluations[index] || {};
        const earned = evaluation.score || 0;
        const total = evaluation.maxScore || question.points || 0;
        const correct = earned === total;
        const studentAnswer = question.answer || 'No answer provided';
        const questionFeedback = evaluation.feedback || 'No specific feedback for this question.';
        
        submissionHTML += `
          <div class="question-feedback-item ${correct ? 'correct' : 'incorrect'}">
            <div class="question-feedback-header">
              <div class="question-feedback-text">
                <strong>Question ${questionNumber}:</strong> ${question.questionText || 'No question text'}
              </div>
              <div class="question-feedback-points">
                ${correct ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>'} 
                ${earned}/${total} pts
              </div>
            </div>
            <div class="question-feedback-answer">
              <div class="answer-label"><strong>Your Answer:</strong></div>
              <div class="answer-value">${studentAnswer}</div>
            </div>
            <div class="question-feedback-comment">
              <div class="feedback-comment-label"><i class="fas fa-comment"></i> Instructor Feedback:</div>
              <div class="feedback-comment-text">${questionFeedback}</div>
            </div>
          </div>
        `;
      });
      
      submissionHTML += `</div>`;
    }
    
    if (assignmentSubmissionContent) {
      assignmentSubmissionContent.innerHTML = submissionHTML;
      assignmentSubmissionModal.classList.add('active');
      console.log("Assignment submission modal opened");
    }
    
  } catch (error) {
    console.error("Error fetching submission data:", error);
    alert("Error loading submission details. Please try again.");
  }
}

// Enhanced evaluation listener with duplicate prevention
function setupEvaluationListener() {
  console.log("=== SETTING UP EVALUATION LISTENER ===");
  
  if (!currentUser || !courseId) {
    console.error("Missing current user or course ID");
    return;
  }

  // Prevent multiple listeners
  if (window.evaluationListeners && window.evaluationListeners.user) {
    console.log('Evaluation listeners already set up, skipping...');
    return;
  }

  const userRef = doc(db, "users", currentUser.uid);
  
  // Initialize evaluationListeners object if it doesn't exist
  if (!window.evaluationListeners) {
    window.evaluationListeners = {};
  }
  
  // Listen for real-time updates to user data
  const userUnsubscribe = onSnapshot(userRef, (docSnap) => {
    if (docSnap.exists()) {
      const userData = docSnap.data();
      const enrollments = userData.enrollments || {};
      const courseEnrollment = enrollments[courseId];
      
      if (courseEnrollment) {
        console.log("User enrollment data updated from Firestore");
        // Update local data
        userEnrollmentData = { ...userEnrollmentData, ...courseEnrollment };
        
        // Update UI if assignments tab is active
        updateAssignmentsUI();
        
        // Update progress display
        updateProgressDisplay();
        
        // Update test section UI
        updateTestSectionUI();
      }
    }
  }, (error) => {
    console.error('Error updating course data:', error);
  });

  // Set up assignment-specific listeners
  setupAssignmentListeners();

  // Listen for test evaluation updates
  const testSubmissionsQuery = query(
    collection(db, "testSubmissions"), 
    where("courseId", "==", courseId),
    where("studentId", "==", currentUser.uid),
    orderBy("submittedAt", "desc"),
    limit(1)
  );

  const testSubmissionsUnsubscribe = onSnapshot(testSubmissionsQuery, 
    (querySnapshot) => {
      if (!querySnapshot.empty) {
        // Get the latest test submission
        const latestSubmission = querySnapshot.docs[0].data();
        testEvaluationData = latestSubmission;
        
        console.log("Test submission updated:", testEvaluationData);
        
        // Update test attempt count
        currentTestAttempt = querySnapshot.docs.length;
        
        // Update test section UI
        updateTestSectionUI();
        
        // Check if test has been evaluated
        if ((testEvaluationData.status === "evaluated" || testEvaluationData.status === "completed") && 
            (testEvaluationData.finalGrade !== null || testEvaluationData.grade !== null)) {
          updateUserTestEvaluation(testEvaluationData);
        }
      }
    },
    (error) => {
      console.error('Error loading test data:', error);
    }
  );

  // Store unsubscribe functions for cleanup
  window.evaluationListeners = {
    user: userUnsubscribe,
    testSubmissions: testSubmissionsUnsubscribe
  };

  console.log('Evaluation listeners set up successfully');
}

// Enhanced assignment listeners with duplicate prevention
function setupAssignmentListeners() {
  console.log("=== SETTING UP ASSIGNMENT LISTENERS ===");
  
  if (!currentUser || !courseId) return;

  // Prevent multiple listeners
  if (window.assignmentListeners && window.assignmentListeners.submissions) {
    console.log('Assignment listeners already set up, skipping...');
    return;
  }

  // Listen for assignment submissions AND evaluations in the submissions collection
  const submissionsQuery = query(
    collection(db, "submissions"),
    where("courseId", "==", courseId),
    where("studentId", "==", currentUser.uid)
  );

  const submissionsUnsubscribe = onSnapshot(submissionsQuery, (snapshot) => {
    let hasUpdates = false;
    
    snapshot.docChanges().forEach((change) => {
      if (change.type === "added" || change.type === "modified") {
        const submission = change.doc.data();
        const assignmentId = submission.assignmentId;
        
        console.log('Submission update detected:', assignmentId, submission);
        
        // Update local assignment status
        updateLocalAssignmentStatus(assignmentId, submission);
        
        // Check if this submission has been evaluated (has grade)
        if (submission.grade !== undefined && submission.grade !== null) {
          console.log('Evaluation found for assignment:', assignmentId, 'Grade:', submission.grade);
          updateLocalAssignmentEvaluation(assignmentId, submission);
          
          // Update user enrollment with evaluation
          updateUserEnrollmentWithEvaluation(assignmentId, submission);
        }
        
        hasUpdates = true;
      }
    });
    
    if (hasUpdates) {
      updateAssignmentsUI();
      updateProgressDisplay();
    }
  });

  // Store unsubscribe functions for cleanup
  if (!window.assignmentListeners) {
    window.assignmentListeners = {};
  }
  window.assignmentListeners.submissions = submissionsUnsubscribe;
  
  console.log("Assignment listeners set up successfully");
}

// FIXED: Update local assignment status when submitted
function updateLocalAssignmentStatus(assignmentId, submission) {
  // Initialize completedAssignments as an array if it doesn't exist
  if (!userEnrollmentData.completedAssignments || !Array.isArray(userEnrollmentData.completedAssignments)) {
    userEnrollmentData.completedAssignments = [];
  }
  
  if (!userEnrollmentData.completedAssignments.includes(assignmentId)) {
    userEnrollmentData.completedAssignments.push(assignmentId);
  }
  
  // Initialize assignmentProgress as an object if it doesn't exist
  if (!userEnrollmentData.assignmentProgress || typeof userEnrollmentData.assignmentProgress !== 'object') {
    userEnrollmentData.assignmentProgress = {};
  }
  userEnrollmentData.assignmentProgress[assignmentId] = 100; // 100% when submitted
  
  console.log(`Local assignment status updated for ${assignmentId}`);
}

// Enhanced updateLocalAssignmentEvaluation function
function updateLocalAssignmentEvaluation(assignmentId, evaluation) {
  // Initialize objects if they don't exist
  if (!userEnrollmentData.assignmentGrades || typeof userEnrollmentData.assignmentGrades !== 'object') {
    userEnrollmentData.assignmentGrades = {};
  }
  if (!userEnrollmentData.assignmentFeedback || typeof userEnrollmentData.assignmentFeedback !== 'object') {
    userEnrollmentData.assignmentFeedback = {};
  }
  if (!userEnrollmentData.evaluatedAssignments || !Array.isArray(userEnrollmentData.evaluatedAssignments)) {
    userEnrollmentData.evaluatedAssignments = [];
  }
  
  // Update grade and feedback
  userEnrollmentData.assignmentGrades[assignmentId] = evaluation.grade;
  userEnrollmentData.assignmentFeedback[assignmentId] = evaluation.feedback || evaluation.instructorFeedback || "No feedback provided.";
  
  // Add to evaluated assignments if not already there
  if (!userEnrollmentData.evaluatedAssignments.includes(assignmentId)) {
    userEnrollmentData.evaluatedAssignments.push(assignmentId);
  }
  
  console.log('Local evaluation updated for assignment:', assignmentId, 'Grade:', evaluation.grade);
}

// Enhanced function to update user enrollment with evaluation from submissions
async function updateUserEnrollmentWithEvaluation(assignmentId, submissionData) {
  console.log(`=== UPDATING USER ENROLLMENT WITH EVALUATION: ${assignmentId} ===`);
  
  if (!currentUser || !courseId || !assignmentId) {
    console.error("Missing required data for evaluation update");
    return;
  }

  try {
    const userRef = doc(db, "users", currentUser.uid);
    
    // Get current user data to avoid overwriting
    const userSnap = await getDoc(userRef);
    if (!userSnap.exists()) {
      console.error("User document not found");
      return;
    }
    
    const userData = userSnap.data();
    const enrollments = userData.enrollments || {};
    const courseEnrollment = enrollments[courseId] || {};
    
    // Check if this assignment was already evaluated to prevent duplicate processing
    const wasAlreadyEvaluated = courseEnrollment.evaluatedAssignments && 
                                courseEnrollment.evaluatedAssignments.includes(assignmentId);
    
    console.log(`Was already evaluated: ${wasAlreadyEvaluated}`);
    
    // Update assignment grades and feedback
    const assignmentGrades = { ...courseEnrollment.assignmentGrades };
    const assignmentFeedback = { ...courseEnrollment.assignmentFeedback };
    const evaluatedAssignments = [...(courseEnrollment.evaluatedAssignments || [])];
    
    assignmentGrades[assignmentId] = submissionData.grade;
    assignmentFeedback[assignmentId] = submissionData.feedback || submissionData.instructorFeedback || "No feedback provided.";
    
    if (!evaluatedAssignments.includes(assignmentId)) {
      evaluatedAssignments.push(assignmentId);
    }
    
    // Remove assignment submission notification
    let notifications = userData.notifications || [];
    notifications = notifications.filter(notification => 
      !(notification.assignmentId === assignmentId && notification.type === 'assignment_submission')
    );
    
    // Calculate new progress with equal distribution
    const totalLectures = allLectures.length;
    const completedLectures = courseEnrollment.completedLessons?.length || 0;
    const totalAssignments = courseAssignments.length;
    const hasFinalTest = 1;
    
    const totalComponents = totalLectures + totalAssignments + hasFinalTest;
    const valuePerComponent = 100 / totalComponents;
    
    // Calculate lecture progress
    const lectureProgress = completedLectures * valuePerComponent;
    
    // Calculate assignment progress - Only count passed assignments
    const passedAssignments = Object.values(assignmentGrades).filter(g => g >= 70).length;
    const assignmentProgress = passedAssignments * valuePerComponent;
    
    // Calculate test progress - only if test is evaluated and passed
    let testProgress = 0;
    if (courseEnrollment.testEvaluated && courseEnrollment.testGrade >= 70) {
      testProgress = hasFinalTest * valuePerComponent;
    }
    
    // Overall progress is the sum of all components
    const newProgress = Math.min(Math.round(lectureProgress + assignmentProgress + testProgress), 100);
    
    console.log(`Progress calculation (Equal Distribution):`);
    console.log(`- Total Components: ${totalComponents}, Value per: ${valuePerComponent.toFixed(2)}%`);
    console.log(`- Lectures: ${completedLectures}/${totalLectures} = ${lectureProgress.toFixed(1)}%`);
    console.log(`- Assignments: ${passedAssignments}/${totalAssignments} = ${assignmentProgress.toFixed(1)}%`);
    console.log(`- Test: ${testProgress.toFixed(1)}%`);
    console.log(`- Total: ${newProgress}%`);
    
    // Prepare update data
    const updateData = {
      [`enrollments.${courseId}.assignmentGrades`]: assignmentGrades,
      [`enrollments.${courseId}.assignmentFeedback`]: assignmentFeedback,
      [`enrollments.${courseId}.evaluatedAssignments`]: evaluatedAssignments,
      [`enrollments.${courseId}.progress`]: newProgress,
      [`enrollments.${courseId}.lastAccessed`]: new Date(),
      notifications: notifications
    };
    
    // Update Firestore
    await updateDoc(userRef, updateData);
    
    console.log("Firestore updated with evaluation data");
    
    // Update local data
    if (!userEnrollmentData.assignmentGrades || typeof userEnrollmentData.assignmentGrades !== 'object') userEnrollmentData.assignmentGrades = {};
    if (!userEnrollmentData.assignmentFeedback || typeof userEnrollmentData.assignmentFeedback !== 'object') userEnrollmentData.assignmentFeedback = {};
    if (!userEnrollmentData.evaluatedAssignments || !Array.isArray(userEnrollmentData.evaluatedAssignments)) userEnrollmentData.evaluatedAssignments = [];
    
    userEnrollmentData.assignmentGrades[assignmentId] = submissionData.grade;
    userEnrollmentData.assignmentFeedback[assignmentId] = submissionData.feedback || submissionData.instructorFeedback || "No feedback provided.";
    
    if (!userEnrollmentData.evaluatedAssignments.includes(assignmentId)) {
      userEnrollmentData.evaluatedAssignments.push(assignmentId);
    }
    
    userEnrollmentData.progress = newProgress;
    
    // Remove assignment submission notification from local data
    if (userEnrollmentData.notifications) {
      userEnrollmentData.notifications = userEnrollmentData.notifications.filter(notification => 
        !(notification.assignmentId === assignmentId && notification.type === 'assignment_submission')
      );
    }
    
    console.log('Updated user enrollment with evaluation for assignment:', assignmentId);
    
    // Force UI update
    updateAssignmentsUI();
    updateProgressDisplay();
    
    // Check if final test should be unlocked
    checkAssignmentUnlock();
    
    // Show notification only if assignment passed and it was not already evaluated
    if (!wasAlreadyEvaluated) {
      const notificationKey = `assignment-${assignmentId}-evaluated-${submissionData.grade}`;
      if (!shownNotifications.has(notificationKey)) {
        if (submissionData.grade >= 70) {
          await addNotification({
            title: "Assignment Passed",
            message: `Assignment passed! Grade: ${submissionData.grade}%`,
            type: "assignment_success",
            courseId: courseId,
            assignmentId: assignmentId,
            read: false
          });
        } else {
          await addNotification({
            title: "Assignment Evaluated",
            message: `Assignment evaluated. Grade: ${submissionData.grade}%. You may need to resubmit.`,
            type: "assignment_warning",
            courseId: courseId,
            assignmentId: assignmentId,
            read: false
          });
        }
        shownNotifications.add(notificationKey);
      }
    }
    
  } catch (error) {
    console.error('Error updating evaluation status:', error);
  }
}

// Add notification to user's notifications
async function addNotification(notificationData) {
  if (!currentUser) return;
  
  try {
    const userRef = doc(db, "users", currentUser.uid);
    const userSnap = await getDoc(userRef);
    
    const notifications = userSnap.exists() && userSnap.data().notifications 
      ? userSnap.data().notifications 
      : [];
    
    // Check if similar notification already exists (prevent duplicates)
    const notificationKey = `${notificationData.type}-${notificationData.courseId}-${notificationData.assignmentId || ''}-${notificationData.message}`;
    const exists = notifications.some(n => 
      n.type === notificationData.type && 
      n.courseId === notificationData.courseId &&
      n.message === notificationData.message &&
      (Date.now() - (n.timestamp?.toMillis() || 0)) < 5000 // Within 5 seconds
    );
    
    if (exists) {
      console.log("Duplicate notification prevented:", notificationKey);
      return;
    }
    
    const newNotification = {
      id: `notification-${Date.now()}-${Math.random()}`,
      ...notificationData,
      timestamp: Timestamp.now()
    };
    
    await updateDoc(userRef, {
      notifications: arrayUnion(newNotification)
    });
    
    console.log("Notification added:", newNotification.title);
    
    // Reload notifications
    loadNotifications(currentUser.uid);
  } catch (error) {
    console.error("Error adding notification:", error);
  }
}

// Load notifications
async function loadNotifications(userId) {
  try {
    const userRef = doc(db, "users", userId);
    const userSnap = await getDoc(userRef);

    notificationList.innerHTML = "";

    if (userSnap.exists() && userSnap.data().notifications) {
      const notifications = userSnap.data().notifications;
      
      notifications.sort((a, b) => {
        const timeA = a.timestamp ? a.timestamp.toDate().getTime() : 0;
        const timeB = b.timestamp ? b.timestamp.toDate().getTime() : 0;
        return timeB - timeA;
      });

      const notificationsToShow = notifications.slice(0, 5);

      if (notificationsToShow.length === 0) {
        notificationList.innerHTML = '<div class="notification-empty">No notifications</div>';
        const badge = document.getElementById('notificationBadge');
        if (badge) badge.style.display = 'none';
        return;
      }

      const unreadCount = notifications.filter(n => !n.read).length;
      const badge = document.getElementById('notificationBadge');
      if (badge) {
        badge.textContent = unreadCount;
        badge.style.display = unreadCount > 0 ? 'flex' : 'none';
      }

      notificationsToShow.forEach(notification => {
        const notificationItem = document.createElement("div");
        notificationItem.className = "notification-item";
        if (!notification.read) {
          notificationItem.classList.add('unread');
        }
        
        let timeDisplay = "Recently";
        if (notification.timestamp) {
          const now = new Date();
          const notificationTime = notification.timestamp.toDate();
          const diffMs = now - notificationTime;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);
          
          if (diffMins < 1) timeDisplay = "Just now";
          else if (diffMins < 60) timeDisplay = `${diffMins}m ago`;
          else if (diffHours < 24) timeDisplay = `${diffHours}h ago`;
          else timeDisplay = `${diffDays}d ago`;
        }
        
        notificationItem.innerHTML = `
          <div class="notification-title">${notification.title}</div>
          <div class="notification-message">${notification.message}</div>
          <div class="notification-time">${timeDisplay}</div>
        `;
        
        notificationItem.addEventListener('click', async () => {
          if (!notification.read) {
            notification.read = true;
            await updateDoc(userRef, {
              notifications: notifications.map(n => 
                n.id === notification.id ? {...n, read: true} : n
              )
            });
            notificationItem.classList.remove('unread');
            loadNotifications(userId);
          }
        });
        
        notificationList.appendChild(notificationItem);
      });
    } else {
      notificationList.innerHTML = '<div class="notification-empty">No notifications</div>';
      const badge = document.getElementById('notificationBadge');
      if (badge) badge.style.display = 'none';
    }
  } catch (error) {
    console.error("Error loading notifications:", error);
    notificationList.innerHTML = "<p class='error-msg'>Error loading notifications.</p>";
  }
}

// Clear all notifications
async function clearAllNotifications() {
  try {
    if (!currentUser) return;
    
    const userRef = doc(db, "users", currentUser.uid);
    
    // Delete all notifications completely
    await updateDoc(userRef, {
      notifications: []
    });
    
    console.log("All notifications cleared");
    
    // Reload notifications to update UI
    loadNotifications(currentUser.uid);
  } catch (error) {
    console.error("Error clearing notifications:", error);
  }
}

// Award certificate when course is completed
async function awardCertificate() {
  console.log("=== AWARDING CERTIFICATE ===");
  
  if (!currentUser || !courseId || !courseData) return;
  
  try {
    const userRef = doc(db, "users", currentUser.uid);
    
    // Create certificate data
    const certificateData = {
      courseId: courseId,
      courseName: courseData.name,
      studentName: currentUser.displayName || currentUser.email.split('@')[0],
      studentEmail: currentUser.email,
      completedAt: Timestamp.now(),
      certificateId: `CERT-${courseId}-${currentUser.uid}-${Date.now()}`,
      instructorName: document.getElementById('instructorName')?.textContent || 'SkillUp Instructor'
    };
    
    console.log("Certificate data:", certificateData);
    
    // Update user's certificates
    await updateDoc(userRef, {
      certificates: arrayUnion(certificateData),
      [`enrollments.${courseId}.certificateAwarded`]: true,
      [`enrollments.${courseId}.completedAt`]: Timestamp.now()
    });
    
    console.log("Certificate awarded successfully");
    
    // Update local data
    userEnrollmentData.certificateAwarded = true;
    
    // Update UI to show certificate button
    updateTestSectionUI();
    
    // Show notification only if not already shown
    const notificationKey = 'certificate-awarded';
    if (!shownNotifications.has(notificationKey)) {
      await addNotification({
        title: " Congratulations!",
        message: "You have completed the course and earned a certificate!",
        type: "certificate_success",
        courseId: courseId,
        read: false
      });
      shownNotifications.add(notificationKey);
    }
    
  } catch (error) {
    console.error("Error awarding certificate:", error);
  }
}

// UPDATED: Generate certificate with proper button display
async function generateCertificate() {
  console.log("=== GENERATING CERTIFICATE ===");
  
  try {
    const userName = currentUser.displayName || currentUser.email.split('@')[0];
    const courseName = courseData?.name || "Advanced Web Development";
    const instructorName = document.getElementById('instructorName')?.textContent || "Sarah Johnson";
    const providerName = "SkillUp Academy";
    const completionDate = new Date().toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    const certificateId = `CERT-${courseId}-${currentUser.uid}-${Date.now()}`;
    
    // Calculate grade if available
    const finalGrade = userEnrollmentData?.testGrade || testEvaluationData?.finalGrade || testEvaluationData?.grade;
    const gradeDisplay = finalGrade ? `${finalGrade}%` : "Completed";
    
    console.log(`Generating certificate for ${userName}, grade: ${gradeDisplay}`);
    
    const certificateHTML = `
      <div class="certificate-container" id="certificate-content">
        <!-- Certificate Seal -->
        <div class="certificate-seal">
          <div>
            <i class="fas fa-award" style="font-size: 22px; margin-bottom: 6px;"></i>
            <div style="margin-top: 4px; font-size: 11px;">VERIFIED</div>
            <div style="font-size: 9px; margin-top: 2px;">CERTIFICATE</div>
          </div>
        </div>

        <!-- Certificate Header -->
        <div class="certificate-header">
          <div class="certificate-logo">
            <i class="fas fa-graduation-cap"></i>
            SkillUp
          </div>
          <div class="certificate-subtitle">Online Learning Platform | skillup.com</div>
          <h1 class="certificate-title">Certificate of Completion</h1>
        </div>

        <!-- Certificate Body -->
        <div class="certificate-body">
          <p class="certificate-subtitle" style="font-size: 15px; margin-bottom: 10px;">This certificate is proudly presented to</p>
          <h2 class="certificate-student-name">${userName}</h2>
          <p class="certificate-text" style="font-size: 16px; margin: 12px 100px;">
            has successfully completed all requirements and demonstrated exceptional proficiency in
          </p>
          <h3 class="certificate-course-name">"${courseName}"</h3>
          
          <!-- Certificate Details -->
          <div class="certificate-details">
            <div class="detail-item">
              <div class="detail-label">Date Completed</div>
              <div class="detail-value">${completionDate}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Final Grade</div>
              <div class="detail-value">${gradeDisplay}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Certificate ID</div>
              <div class="detail-value" style="font-size: 13px;">${certificateId}</div>
            </div>
          </div>

    
        </div>

       
    </div>
      
      <!-- Certificate Actions - OUTSIDE certificate container -->
      <div class="certificate-actions" style="display: flex !important; visibility: visible !important; opacity: 1 !important; justify-content: center; gap: 15px; margin-top: 20px; padding: 20px;">
        <button class="certificate-download-btn" id="downloadCertificatePDFBtn" style="display: inline-flex !important; visibility: visible !important;">
          <i class="fas fa-file-pdf"></i> Download PDF
        </button>
        <button class="certificate-print-btn" id="shareCertificateBtn" style="display: inline-flex !important; visibility: visible !important; background: linear-gradient(135deg, #667eea, #764ba2);">
          <i class="fas fa-share-alt"></i> Share Link
        </button>
      </div>
    `;
    
    
    // Remove any existing certificate modal first
    const existingModal = document.getElementById('certificateModal');
    if (existingModal) {
      existingModal.remove();
    }
    
    // Create a new modal for the certificate
    const certificateModal = document.createElement('div');
    certificateModal.className = 'modal active certificate-modal';
    certificateModal.id = 'certificateModal';
    certificateModal.style.display = 'flex';
    certificateModal.innerHTML = `
      <div class="certificate-modal-content" style="max-width: 1000px; width: 95%;">
        <div class="modal-header">
          <h2 class="modal-title">Your Certificate of Completion</h2>
          <button class="close-modal" id="closeCertificateModal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div id="certificateModalContent" style="padding: 0;">
          ${certificateHTML}
        </div>
      </div>
    `;
    
    document.body.appendChild(certificateModal);
    
    console.log("Certificate modal created and displayed");
    
    // Add event listener for close button
    document.getElementById('closeCertificateModal').addEventListener('click', () => {
      certificateModal.remove();
    });
    
    // Add event listeners for new buttons - with delay to ensure DOM is ready
    setTimeout(() => {
      const downloadBtn = document.getElementById('downloadCertificatePDFBtn');
      const shareBtn = document.getElementById('shareCertificateBtn');
      
      if (downloadBtn) {
        downloadBtn.addEventListener('click', downloadCertificateAsPDF);
        console.log("Download PDF button event listener attached");
      } else {
        console.error("Download PDF button not found");
      }
      
      if (shareBtn) {
        shareBtn.addEventListener('click', shareCertificateLink);
        console.log("Share button event listener attached");
      } else {
        console.error("Share button not found");
      }
    }, 100);
    
    // Save certificate to user data
    await saveCertificate(certificateId, userName, courseName, instructorName, providerName, completionDate, finalGrade);
    
  } catch (error) {
    console.error("Error generating certificate:", error);
    alert("Error generating certificate. Please try again.");
  }
}

async function downloadCertificateAsPDF() {
  console.log("=== DOWNLOADING CERTIFICATE AS PDF ===");
  
  try {
    const certificateElement = document.getElementById('certificate-content');
    if (!certificateElement) {
      throw new Error('Certificate element not found');
    }

    // Show loading state
    const downloadBtn = document.getElementById('downloadCertificatePDFBtn');
    const originalText = downloadBtn.innerHTML;
    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
    downloadBtn.disabled = true;

    console.log("Generating PDF certificate...");

    // Get the computed dimensions
    const rect = certificateElement.getBoundingClientRect();
    const elementWidth = certificateElement.scrollWidth;
    const elementHeight = certificateElement.scrollHeight;

    console.log(`Certificate dimensions: ${elementWidth}x${elementHeight}`);

    // Wait for fonts and layout to settle
    await new Promise(resolve => setTimeout(resolve, 1000));

    // Use html2canvas with optimal settings for certificate
    const canvas = await html2canvas(certificateElement, {
      scale: 3, // Higher quality
      useCORS: true,
      allowTaint: false,
      backgroundColor: '#ffffff',
      logging: false,
      width: elementWidth,
      height: elementHeight,
      windowWidth: elementWidth,
      windowHeight: elementHeight,
      scrollX: 0,
      scrollY: -window.scrollY,
      x: 0,
      y: 0,
      foreignObjectRendering: false, // Better rendering for complex layouts
      imageTimeout: 0
    });

    console.log(`Canvas created: ${canvas.width}x${canvas.height}`);

    // Convert canvas to PDF in landscape orientation
    const { jsPDF } = window.jspdf;
    
    // Calculate PDF dimensions based on canvas aspect ratio
    const canvasAspectRatio = canvas.width / canvas.height;
    let pdfOrientation = canvasAspectRatio > 1.3 ? 'landscape' : 'portrait';
    
    const pdf = new jsPDF(pdfOrientation, 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    
    console.log(`PDF page size: ${pdfWidth}x${pdfHeight}mm`);
    
    // Calculate dimensions to fit certificate perfectly
    let imgWidth, imgHeight, imgX, imgY;
    
    if (canvasAspectRatio > (pdfWidth / pdfHeight)) {
      // Width is the limiting factor
      imgWidth = pdfWidth * 0.95; // 95% of page width
      imgHeight = imgWidth / canvasAspectRatio;
      imgX = (pdfWidth - imgWidth) / 2;
      imgY = (pdfHeight - imgHeight) / 2;
    } else {
      // Height is the limiting factor
      imgHeight = pdfHeight * 0.95; // 95% of page height
      imgWidth = imgHeight * canvasAspectRatio;
      imgX = (pdfWidth - imgWidth) / 2;
      imgY = (pdfHeight - imgHeight) / 2;
    }
    
    console.log(`Image placement: ${imgX}, ${imgY}, ${imgWidth}x${imgHeight}mm`);
    
    // Convert canvas to high-quality image
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    
    // Add image to PDF
    pdf.addImage(imgData, 'JPEG', imgX, imgY, imgWidth, imgHeight, undefined, 'FAST');
    
    // Generate filename
    const userName = currentUser.displayName || currentUser.email.split('@')[0];
    const courseName = courseData?.name || 'Course';
    const fileName = `Certificate_${courseName.replace(/\s+/g, '_')}_${userName.replace(/\s+/g, '_')}.pdf`;
    
    // Save the PDF
    pdf.save(fileName);

    console.log(` Certificate downloaded as PDF: ${fileName}`);

    // Restore button state
    downloadBtn.innerHTML = originalText;
    downloadBtn.disabled = false;

    // Show success message
    showNotification(' PDF downloaded successfully!', 'success');
    
  } catch (error) {
    console.error("Error downloading certificate as PDF:", error);
    
    const downloadBtn = document.getElementById('downloadCertificatePDFBtn');
    if (downloadBtn) {
      downloadBtn.innerHTML = '<i class="fas fa-file-pdf"></i> Download PDF';
      downloadBtn.disabled = false;
    }
    
    showNotification('Error downloading PDF. Please try again.', 'error');
  }
}

// FIXED: Share certificate link with better error handling
async function shareCertificateLink() {
  console.log("=== SHARING CERTIFICATE LINK ===");
  
  try {
    const certificateId = `CERT-${courseId}-${currentUser.uid}-${Date.now()}`;
    const shareUrl = `${window.location.origin}/certificate.html?id=${certificateId}`;
    const courseName = courseData?.name || 'the course';
    const userName = currentUser.displayName || currentUser.email.split('@')[0];
    
    // Show loading state
    const shareBtn = document.getElementById('shareCertificateBtn');
    const originalText = shareBtn.innerHTML;
    shareBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Preparing...';
    shareBtn.disabled = true;

    // Try to use the Web Share API if available
    if (navigator.share) {
      try {
        await navigator.share({
          title: 'My Course Certificate',
          text: `I completed "${courseName}" on SkillUp! Check out my certificate.`,
          url: shareUrl
        });
        console.log('Certificate shared successfully');
        showNotification('Certificate shared successfully!', 'success');
        
      } catch (error) {
        console.log('Error sharing:', error);
        if (error.name !== 'AbortError') {
          fallbackShare(shareUrl, courseName, userName);
        }
      }
    } else {
      fallbackShare(shareUrl, courseName, userName);
    }

    // Restore button state
    shareBtn.innerHTML = originalText;
    shareBtn.disabled = false;
    
  } catch (error) {
    console.error("Error sharing certificate:", error);
    
    // Restore button state on error
    const shareBtn = document.getElementById('shareCertificateBtn');
    if (shareBtn) {
      shareBtn.innerHTML = '<i class="fas fa-share-alt"></i> Share Link';
      shareBtn.disabled = false;
    }
    
    showNotification('Error sharing certificate. Please try again.', 'error');
  }
}

// Enhanced fallback share function
function fallbackShare(shareUrl, courseName, userName) {
  // Copy to clipboard
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(shareUrl).then(() => {
      showNotification('Certificate link copied to clipboard!', 'success');
      console.log("Certificate link copied to clipboard");
    }).catch((err) => {
      console.error('Failed to copy: ', err);
      prompt("Copy this certificate link to share:", shareUrl);
    });
  } else {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = shareUrl;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
      document.execCommand('copy');
      showNotification('Certificate link copied to clipboard!', 'success');
    } catch (err) {
      console.error('Fallback: Oops, unable to copy', err);
      prompt("Copy this certificate link to share:", shareUrl);
    }
    document.body.removeChild(textArea);
  }
}

// Save certificate to user data
async function saveCertificate(certificateId, userName, courseName, instructorName, providerName, completionDate, finalGrade) {
  console.log("=== SAVING CERTIFICATE TO USER DATA ===");
  
  if (!currentUser || !courseId) return;
  
  try {
    const userRef = doc(db, "users", currentUser.uid);
    
    const certificateData = {
      id: certificateId,
      courseId: courseId,
      courseName: courseName,
      studentName: userName,
      instructorName: instructorName,
      providerName: providerName,
      completionDate: completionDate,
      issueDate: new Date().toISOString(),
      finalGrade: finalGrade,
      certificateUrl: `certificates/${certificateId}.png`, // Placeholder for future file upload
      issuedAt: Timestamp.now()
    };
    
    await updateDoc(userRef, {
      certificates: arrayUnion(certificateData),
      [`enrollments.${courseId}.certificateAwarded`]: true,
      [`enrollments.${courseId}.certificateId`]: certificateId
    });

    console.log("Certificate saved to user data");

    // Update local data
    userEnrollmentData.certificateAwarded = true;
    userEnrollmentData.certificateId = certificateId;
    
  } catch (error) {
    // Don't show error to user as the certificate is still generated locally
    console.error("Error saving certificate:", error);
  }
}

// Download resource function
window.downloadResource = function(url, fileName) {
  console.log(`Downloading resource: ${url}`);
  
  if (url) {
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName || 'resource';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } else {
    addNotification({
      title: "Download Unavailable",
      message: "Download link not available",
      type: "resource_error",
      courseId: courseId,
      read: false
    });
  }
};

// Show notification function
function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  notification.className = `notification ${type === 'error' ? 'error' : ''}`;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// Clean up all event listeners
function cleanupAllListeners() {
  console.log("=== CLEANING UP LISTENERS ===");
  
  // Clean up evaluation listeners
  if (window.evaluationListeners) {
    Object.values(window.evaluationListeners).forEach(unsubscribe => {
      if (typeof unsubscribe === 'function') {
        unsubscribe();
      }
    });
    window.evaluationListeners = null;
  }
  
  // Clean up assignment listeners
  if (window.assignmentListeners) {
    Object.values(window.assignmentListeners).forEach(unsubscribe => {
      if (typeof unsubscribe === 'function') {
        unsubscribe();
      }
    });
    window.assignmentListeners = null;
  }
  
  // Reset processed evaluations
  processedEvaluations.clear();
  testEvaluationProcessed = false;
  
  console.log("Listeners cleaned up");
}

// Initialize the page when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
  console.log("=== DOM CONTENT LOADED ===");
  console.log("Initializing course page...");
  initCoursePage();
});

console.log("=== SCRIPT LOADED ===");
</script>
</body>
</html>