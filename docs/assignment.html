<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assignment - SkillUp</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #ffffff;
      --primary-dark: #f8f9fa;
      --primary-light: #e9ecef;
      --secondary: #dee2e6;
      --accent: #08d9d6;
      --light: #4361ee;
      --dark: #ffffff;
      --gray: #adb5bd;
      --gray-light: #343a40;
      --success: #00f5ff;
      --card-bg: linear-gradient(135deg, #ffffff, #f8f9fa);
      --sidebar-bg: linear-gradient(180deg, #4361ee, #3a0ca3);
      --bg-main: #1a1d29;
      --bg-secondary: #252937;
      --assignment-color: #ff9e00;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: var(--bg-main);
      color: var(--primary);
      overflow-x: hidden;
      transition: all 0.3s ease;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    .assignment-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }

    .assignment-header {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      text-align: center;
      border: 1px solid rgba(255, 158, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .assignment-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, rgba(255, 158, 0, 0.05), rgba(0, 245, 255, 0.05));
      animation: headerGlow 4s ease-in-out infinite alternate;
    }

    @keyframes headerGlow {
      0% { opacity: 0.3; }
      100% { opacity: 0.7; }
    }

    .assignment-title {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 15px;
      background: linear-gradient(45deg, var(--assignment-color), var(--success));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      position: relative;
      z-index: 1;
    }

    .assignment-subtitle {
      color: var(--gray);
      font-size: 18px;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }

    .assignment-deadline {
      background: rgba(255, 158, 0, 0.2);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 30px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      border: 1px solid rgba(255, 158, 0, 0.3);
      position: sticky;
      top: 20px;
      z-index: 100;
    }

    .assignment-deadline.warning {
      background: rgba(255, 193, 7, 0.2);
      color: #ffd166;
      border-color: rgba(255, 193, 7, 0.3);
      animation: pulse 1s infinite;
    }

    .assignment-deadline.critical {
      background: rgba(220, 53, 69, 0.3);
      color: #ff6b6b;
      animation: pulse 0.5s infinite;
      border-color: rgba(220, 53, 69, 0.5);
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    .assignment-instructions {
      background: rgba(255, 158, 0, 0.1);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid rgba(255, 158, 0, 0.3);
    }

    .assignment-instructions h3 {
      color: var(--primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .assignment-instructions ul {
      padding-left: 20px;
      margin-bottom: 15px;
    }

    .assignment-instructions li {
      margin-bottom: 10px;
      color: var(--gray);
    }

    .assignment-start-container {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      border: 1px solid rgba(255, 158, 0, 0.3);
      margin-top: 30px;
    }

    .assignment-start-container h2 {
      color: var(--primary);
      margin-bottom: 20px;
      font-size: 28px;
    }

    .assignment-start-container p {
      color: var(--gray);
      margin-bottom: 30px;
      font-size: 18px;
    }

    .assignment-questions-container {
      margin-bottom: 30px;
      display: none;
    }

    .assignment-question {
      background: var(--bg-secondary);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid rgba(255, 158, 0, 0.3);
      transition: all 0.3s ease;
    }

    .assignment-question:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(255, 158, 0, 0.2);
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .question-text {
      font-size: 20px;
      color: var(--primary);
      font-weight: 600;
      flex: 1;
    }

    .question-points {
      background: rgba(0, 245, 255, 0.1);
      color: var(--success);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 16px;
      font-weight: 600;
      white-space: nowrap;
      margin-left: 15px;
    }

    .question-description {
      color: var(--gray);
      margin-bottom: 20px;
      font-size: 16px;
      line-height: 1.5;
    }

    .question-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .option-item {
      padding: 15px;
      background: rgba(255, 158, 0, 0.05);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
      display: flex;
      align-items: center;
    }

    .option-item:hover {
      background: rgba(255, 158, 0, 0.1);
    }

    .option-item.selected {
      background: rgba(0, 245, 255, 0.1);
      border-color: var(--success);
    }

    .option-item input[type="radio"],
    .option-item input[type="checkbox"] {
      margin-right: 15px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .option-item label {
      cursor: pointer;
      flex: 1;
      font-size: 16px;
    }

    .text-answer {
      width: 100%;
      min-height: 150px;
      padding: 15px;
      background: var(--bg-main);
      border: 1px solid rgba(255, 158, 0, 0.3);
      border-radius: 10px;
      color: var(--primary);
      font-size: 16px;
      resize: vertical;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    .text-answer:focus {
      outline: none;
      border-color: var(--success);
      box-shadow: 0 0 0 2px rgba(0, 245, 255, 0.2);
    }

    .text-answer.code-answer {
      font-family: 'Courier New', monospace;
      min-height: 200px;
    }

    .answer-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 14px;
      color: var(--gray);
    }

    .code-formatting {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-format {
      background: rgba(255, 158, 0, 0.1);
      color: var(--primary);
      border: 1px solid rgba(255, 158, 0, 0.3);
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-format:hover {
      background: rgba(255, 158, 0, 0.2);
      transform: translateY(-1px);
    }

    .file-upload-area {
      border: 2px dashed rgba(255, 158, 0, 0.3);
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 15px;
    }

    .file-upload-area:hover {
      border-color: var(--success);
      background: rgba(255, 158, 0, 0.05);
    }

    .file-upload-area i {
      font-size: 48px;
      color: var(--success);
      margin-bottom: 15px;
    }

    .file-input {
      display: none;
    }

    .file-name {
      margin-top: 10px;
      color: var(--gray);
      font-size: 14px;
    }

    .assignment-navigation {
      display: none;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 158, 0, 0.3);
    }

    .assignment-progress {
      text-align: center;
      color: var(--gray);
      font-size: 16px;
      font-weight: 600;
    }

    .navigation-buttons {
      display: flex;
      gap: 15px;
    }

    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      min-width: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-secondary {
      background: transparent;
      color: var(--primary);
      border: 2px solid rgba(255, 158, 0, 0.3);
    }

    .btn-primary {
      background: linear-gradient(45deg, var(--assignment-color), var(--success));
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(255, 158, 0, 0.3);
    }

    .btn:disabled {
      background: var(--gray);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      opacity: 0.5;
    }

    .assignment-warning-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .assignment-warning-modal.active {
      display: flex;
    }

    .assignment-warning-modal-content {
      background: var(--bg-secondary);
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      padding: 30px;
      position: relative;
      border: 1px solid rgba(255, 158, 0, 0.3);
      text-align: center;
    }

    .assignment-warning-icon {
      font-size: 60px;
      color: #ffc107;
      margin: 20px 0;
      animation: pulse 2s infinite;
    }

    .assignment-warning-title {
      font-size: 24px;
      color: var(--primary);
      margin-bottom: 15px;
    }

    .assignment-warning-text {
      color: var(--primary);
      font-size: 18px;
      margin-bottom: 25px;
    }

    .assignment-warning-attempts {
      color: #ffc107;
      font-weight: bold;
      font-size: 20px;
      margin: 10px 0;
    }

    .assignment-warning-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }

    .success-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .success-modal.active {
      display: flex;
    }

    .success-modal-content {
      background: var(--bg-secondary);
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      padding: 30px;
      position: relative;
      border: 1px solid rgba(255, 158, 0, 0.3);
      text-align: center;
    }

    .success-animation {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
      text-align: center;
    }

    .checkmark {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: block;
      stroke-width: 2;
      stroke: #4bb71b;
      stroke-miterlimit: 10;
      margin: 20px auto;
      box-shadow: inset 0px 0px 0px #4bb71b;
      animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
    }

    .checkmark__circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 2;
      stroke-miterlimit: 10;
      stroke: #4bb71b;
      fill: none;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }

    .checkmark__check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }

    @keyframes stroke {
      100% {
        stroke-dashoffset: 0;
      }
    }

    @keyframes scale {
      0%, 100% {
        transform: none;
      }
      50% {
        transform: scale3d(1.1, 1.1, 1);
      }
    }

    @keyframes fill {
      100% {
        box-shadow: inset 0px 0px 0px 30px #4bb71b;
      }
    }

    .restriction-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(220, 53, 69, 0.2);
      color: #ff6b6b;
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 14px;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 100;
      border: 1px solid rgba(220, 53, 69, 0.3);
    }

    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: var(--gray);
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 158, 0, 0.2);
      border-top-color: var(--success);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Text Answer Section Styles */
    .text-answer-section {
      margin-top: 20px;
    }

    .text-answer-label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: var(--primary);
    }

    .text-answer-area {
      width: 100%;
      min-height: 300px;
      padding: 20px;
      background: var(--bg-main);
      border: 1px solid rgba(255, 158, 0, 0.3);
      border-radius: 10px;
      color: var(--primary);
      font-size: 16px;
      line-height: 1.6;
      resize: vertical;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    .text-answer-area:focus {
      outline: none;
      border-color: var(--success);
      box-shadow: 0 0 0 2px rgba(0, 245, 255, 0.2);
    }

    .text-answer-tools {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .text-answer-stats {
      display: flex;
      gap: 20px;
      font-size: 14px;
      color: var(--gray);
    }

    .text-answer-actions {
      display: flex;
      gap: 10px;
    }

    .btn-tool {
      background: rgba(255, 158, 0, 0.1);
      color: var(--primary);
      border: 1px solid rgba(255, 158, 0, 0.3);
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .btn-tool:hover {
      background: rgba(255, 158, 0, 0.2);
      transform: translateY(-1px);
    }

    .word-count-display, .char-count-display {
      font-weight: 600;
      color: var(--success);
    }

    /* New styles for submission success modal */
    .submission-success-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .submission-success-modal.active {
      display: flex;
    }

    .submission-success-modal-content {
      background: var(--bg-secondary);
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      padding: 30px;
      position: relative;
      border: 1px solid rgba(255, 158, 0, 0.3);
      text-align: center;
    }

    .submission-success-animation {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
      text-align: center;
    }

    .submission-success-message {
      color: var(--primary);
      font-size: 24px;
      margin: 20px 0;
      font-weight: 600;
    }

    .submission-success-details {
      color: var(--gray);
      margin-bottom: 30px;
      font-size: 16px;
      line-height: 1.5;
    }

    .submission-success-actions {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    @media (max-width: 768px) {
      .submission-success-actions {
        flex-direction: column;
      }
    }

    /* Rich Text Editor Styles */
    .rich-text-toolbar {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
      flex-wrap: wrap;
      padding: 10px;
      background: rgba(255, 158, 0, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(255, 158, 0, 0.2);
    }

    .rich-text-btn {
      background: transparent;
      border: 1px solid rgba(255, 158, 0, 0.3);
      color: var(--primary);
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
    }

    .rich-text-btn:hover {
      background: rgba(255, 158, 0, 0.2);
    }

    .rich-text-btn.active {
      background: rgba(255, 158, 0, 0.3);
      border-color: var(--success);
    }

    .rich-text-editor {
      min-height: 300px;
      padding: 20px;
      background: var(--bg-main);
      border: 1px solid rgba(255, 158, 0, 0.3);
      border-radius: 10px;
      color: var(--primary);
      font-size: 16px;
      line-height: 1.6;
      overflow-y: auto;
      transition: all 0.3s ease;
    }

    .rich-text-editor:focus {
      outline: none;
      border-color: var(--success);
      box-shadow: 0 0 0 2px rgba(0, 245, 255, 0.2);
    }

    .rich-text-editor[contenteditable="true"]:empty:before {
      content: "Type your answer here...";
      color: var(--gray);
    }

    @media (max-width: 768px) {
      .assignment-container {
        padding: 15px;
      }

      .assignment-header {
        padding: 20px;
      }

      .assignment-title {
        font-size: 28px;
      }

      .assignment-deadline {
        font-size: 20px;
        padding: 12px;
      }

      .assignment-question {
        padding: 20px;
      }

      .question-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .question-points {
        margin-left: 0;
      }

      .assignment-navigation {
        flex-direction: column;
        gap: 15px;
      }

      .navigation-buttons {
        flex-direction: column;
        width: 100%;
      }

      .navigation-buttons .btn {
        width: 100%;
      }

      .assignment-warning-actions {
        flex-direction: column;
      }

      .text-answer-tools {
        flex-direction: column;
        align-items: flex-start;
      }

      .text-answer-actions {
        width: 100%;
        justify-content: space-between;
      }

      .rich-text-toolbar {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="assignment-container">
    <div class="assignment-header">
      <h1 class="assignment-title" id="assignmentTitle">Assignment</h1>
      <p class="assignment-subtitle" id="assignmentSubtitle">Loading...</p>
      <div class="assignment-deadline" id="assignmentDeadline" style="display: none;">
        <i class="fas fa-clock"></i> Deadline: <span id="deadlineDisplay">Loading...</span>
      </div>
    </div>

    <div class="assignment-instructions">
      <h3><i class="fas fa-exclamation-circle"></i> Important Instructions</h3>
      <ul>
        <li>This assignment has a deadline. Make sure to submit before the due date.</li>
        <li>You can save your progress and return later before the deadline.</li>
        <li>Right-click, text selection, and developer tools are disabled during the assignment.</li>
        <li>Your assignment will be sent to your instructor for evaluation after submission.</li>
        <li>You need a score of at least 70% to pass the assignment.</li>
        <li>You have maximum 3 tab changes allowed. After that, assignment will be auto-submitted.</li>
      </ul>
      <p><strong>Note:</strong> You can submit this assignment only once.</p>
    </div>

    <div class="assignment-start-container" id="assignmentStartContainer">
      <h2>Ready to Begin?</h2>
      <p>Click the button below to start your assignment. Make sure you have a stable internet connection.</p>
      <button class="btn btn-primary" id="startAssignmentBtn">
        <i class="fas fa-play"></i> Start Assignment
      </button>
    </div>

    <div class="assignment-questions-container" id="assignmentQuestionsContainer"></div>

    <div class="assignment-navigation" id="assignmentNavigation">
      <div class="assignment-progress" id="assignmentProgress">Question 1 of 5</div>
      <div class="navigation-buttons">
        <button class="btn btn-secondary" id="prevQuestion" disabled>
          <i class="fas fa-arrow-left"></i> Previous
        </button>
        <button class="btn btn-primary" id="nextQuestion">
          Next <i class="fas fa-arrow-right"></i>
        </button>
        <button class="btn btn-primary" id="saveAssignment" style="display: none;">
          <i class="fas fa-save"></i> Save Progress
        </button>
        <button class="btn btn-primary" id="submitAssignment" style="display: none;">
          <i class="fas fa-paper-plane"></i> Submit Assignment
        </button>
      </div>
    </div>
  </div>

  <div class="assignment-warning-modal" id="assignmentWarningModal">
    <div class="assignment-warning-modal-content">
      <div class="assignment-warning-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <h2 class="assignment-warning-title">Warning: Assignment Restrictions</h2>
      <p class="assignment-warning-text" id="assignmentWarningMessage">
        You are not allowed to leave the assignment environment.
      </p>
      <div class="assignment-warning-attempts" id="remainingAttempts">
        You have 3 attempts remaining
      </div>
      <div class="assignment-warning-actions">
        <button class="btn btn-secondary" id="assignmentWarningStay">Stay on Assignment</button>
      </div>
    </div>
  </div>

  <div class="success-modal" id="successModal">
    <div class="success-modal-content">
      <div class="success-animation">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
          <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
          <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
        <h3 id="successMessage">Assignment Submitted Successfully!</h3>
        <p>Your assignment has been sent to your instructor for evaluation.</p>
        <button class="btn btn-primary" id="closeSuccessModal">Return to Course</button>
      </div>
    </div>
  </div>

  <!-- New submission success modal -->
  <div class="submission-success-modal" id="submissionSuccessModal">
    <div class="submission-success-modal-content">
      <div class="submission-success-animation">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
          <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
          <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
        <h3 class="submission-success-message">Assignment Submitted Successfully!</h3>
        <p class="submission-success-details">Your assignment has been sent to your instructor for evaluation. You will be redirected to the course details page in <span id="countdown">5</span> seconds.</p>
        <div class="submission-success-actions">
          <button class="btn btn-primary" id="goToCourseBtn">
            <i class="fas fa-book"></i> Go to Course Details
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="restriction-indicator" id="restrictionIndicator">
    <i class="fas fa-shield-alt"></i> Assignment Mode Active
  </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, collection, getDocs, setDoc, Timestamp, updateDoc, arrayUnion
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBffElX8sXMQdYXOXLjepqd7KYic20D4K8",
      authDomain: "growup-93f5d.firebaseapp.com",
      projectId: "growup-93f5d",
      storageBucket: "growup-93f5d.firebasestorage.app",
      messagingSenderId: "775742235468",
      appId: "1:775742235468:web:bd46cb802185c89f2aa5e9",
      measurementId: "G-FWBKTSQDS9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get("courseId") || "course1";
    const assignmentId = urlParams.get("assignmentId") || "assignment1";

    let currentUser = null;
    let courseData = null;
    let assignmentData = null;
    let assignmentQuestions = [];
    let userAssignmentAnswers = [];
    let currentQuestionIndex = 0;
    let assignmentStarted = false;
    let deadlineTimer = null;
    let timeUntilDeadline = 0;
    
    // Tab change tracking
    let tabChangeCount = 0;
    const MAX_TAB_CHANGES = 3;

    const elements = {
      assignmentTitle: document.getElementById('assignmentTitle'),
      assignmentSubtitle: document.getElementById('assignmentSubtitle'),
      assignmentDeadline: document.getElementById('assignmentDeadline'),
      deadlineDisplay: document.getElementById('deadlineDisplay'),
      assignmentQuestionsContainer: document.getElementById('assignmentQuestionsContainer'),
      assignmentProgress: document.getElementById('assignmentProgress'),
      prevQuestionButton: document.getElementById('prevQuestion'),
      nextQuestionButton: document.getElementById('nextQuestion'),
      saveAssignmentButton: document.getElementById('saveAssignment'),
      submitAssignmentButton: document.getElementById('submitAssignment'),
      assignmentWarningModal: document.getElementById('assignmentWarningModal'),
      assignmentWarningMessage: document.getElementById('assignmentWarningMessage'),
      assignmentWarningStay: document.getElementById('assignmentWarningStay'),
      successModal: document.getElementById('successModal'),
      successMessage: document.getElementById('successMessage'),
      closeSuccessModal: document.getElementById('closeSuccessModal'),
      restrictionIndicator: document.getElementById('restrictionIndicator'),
      assignmentStartContainer: document.getElementById('assignmentStartContainer'),
      startAssignmentBtn: document.getElementById('startAssignmentBtn'),
      assignmentNavigation: document.getElementById('assignmentNavigation'),
      submissionSuccessModal: document.getElementById('submissionSuccessModal'),
      goToCourseBtn: document.getElementById('goToCourseBtn'),
      remainingAttempts: document.getElementById('remainingAttempts')
    };

    function showLoading(message = "Loading assignment...") {
      elements.assignmentQuestionsContainer.innerHTML = `
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>${message}</p>
        </div>
      `;
    }

    async function initAssignmentPage() {
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          currentUser = user;
          await loadCourseData();
          await loadAssignmentData();
          await loadAssignmentQuestions();
          await loadUserAssignmentProgress();
        } else {
          window.location.href = "signin.html";
        }
      });

      elements.prevQuestionButton.addEventListener('click', showPreviousQuestion);
      elements.nextQuestionButton.addEventListener('click', showNextQuestion);
      elements.saveAssignmentButton.addEventListener('click', saveAssignmentProgress);
      elements.submitAssignmentButton.addEventListener('click', submitAssignment);
      elements.assignmentWarningStay.addEventListener('click', () => elements.assignmentWarningModal.classList.remove('active'));
      elements.startAssignmentBtn.addEventListener('click', startAssignmentWithUserGesture);
      elements.closeSuccessModal.addEventListener('click', () => {
        if (window.opener) {
          window.opener.postMessage({ type: 'ASSIGNMENT_SUBMITTED', courseId, assignmentId }, '*');
        }
        window.close();
      });
      elements.goToCourseBtn.addEventListener('click', redirectToCourseDetails);
    }

    async function loadCourseData() {
      try {
        const docRef = doc(db, "courses", courseId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          courseData = { id: docSnap.id, ...docSnap.data() };
        } else {
          elements.assignmentSubtitle.textContent = "Course not found";
          console.error("Course not found");
        }
      } catch (err) {
        console.error("Error loading course:", err);
        elements.assignmentSubtitle.textContent = "Error loading course";
      }
    }

    async function loadAssignmentData() {
      try {
        const docRef = doc(db, "courses", courseId, "assignments", assignmentId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          assignmentData = { id: docSnap.id, ...docSnap.data() };
          elements.assignmentTitle.textContent = assignmentData.title || 'Assignment';
          elements.assignmentSubtitle.textContent = assignmentData.description || 'Assignment';
          
          // Set up deadline timer
          if (assignmentData.deadline) {
            const deadline = assignmentData.deadline.toDate();
            timeUntilDeadline = Math.floor((deadline - new Date()) / 1000);
            
            if (timeUntilDeadline > 0) {
              elements.assignmentDeadline.style.display = 'block';
              startDeadlineTimer();
            } else {
              elements.assignmentDeadline.style.display = 'block';
              elements.assignmentDeadline.classList.add('critical');
              elements.deadlineDisplay.textContent = 'DEADLINE PASSED';
            }
          }
        } else {
          elements.assignmentSubtitle.textContent = "Assignment not found";
          console.error("Assignment not found");
        }
      } catch (err) {
        console.error("Error loading assignment:", err);
        elements.assignmentSubtitle.textContent = "Error loading assignment";
      }
    }

    async function loadAssignmentQuestions() {
      showLoading("Loading assignment questions...");
      
      try {
        const assignmentQuestionsRef = collection(db, "courses", courseId, "assignments", assignmentId, "questions");
        const assignmentQuestionsSnap = await getDocs(assignmentQuestionsRef);
        
        if (!assignmentQuestionsSnap.empty) {
          assignmentQuestions = assignmentQuestionsSnap.docs.map(doc => {
            const data = doc.data();
            return {
              id: doc.id,
              question: data.question || "",
              description: data.description || "",
              type: data.type || "text_answer",
              options: data.options || [],
              correctAnswer: data.correctAnswer,
              points: data.points || 10
            };
          });
          
          assignmentQuestions.sort((a, b) => {
            const aNum = parseInt(a.id.replace(/\D/g, '')) || 0;
            const bNum = parseInt(b.id.replace(/\D/g, '')) || 0;
            return aNum - bNum;
          });
          
          console.log("Loaded assignment questions from Firebase:", assignmentQuestions);
          elements.assignmentQuestionsContainer.innerHTML = "";
        } else {
          throw new Error("No assignment questions found");
        }
      } catch (error) {
        console.error("Error loading assignment questions:", error);
        alert("Failed to load assignment questions. Please contact your instructor.");
        elements.assignmentQuestionsContainer.innerHTML = `
          <div class="loading-container">
            <p style="color: #ff6b6b;">Failed to load assignment questions</p>
          </div>
        `;
      }
    }

    async function loadUserAssignmentProgress() {
      if (!currentUser || !courseId || !assignmentId) return;

      try {
        const userRef = doc(db, "users", currentUser.uid);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists() && userSnap.data().enrollments) {
          const enrollmentData = userSnap.data().enrollments[courseId];
          if (enrollmentData) {
            // Get teacher info from enrollment data
            if (enrollmentData.teacherId) {
              courseData = {
                ...courseData,
                teacherId: enrollmentData.teacherId,
                teacherName: enrollmentData.teacherName || "Unknown Teacher"
              };
              console.log("Loaded teacher info:", courseData.teacherId, courseData.teacherName);
            }
            
            if (enrollmentData.assignments && enrollmentData.assignments[assignmentId]) {
              userAssignmentAnswers = enrollmentData.assignments[assignmentId].answers || [];
            }
          }
        }
      } catch (error) {
        console.error("Error loading user assignment progress:", error);
      }
    }

    function startAssignmentWithUserGesture() {
      if (assignmentQuestions.length === 0) {
        alert("No assignment questions available. Please contact your instructor.");
        return;
      }

      elements.assignmentStartContainer.style.display = 'none';
      elements.assignmentQuestionsContainer.style.display = 'block';
      elements.assignmentNavigation.style.display = 'flex';
      
      setupAssignmentRestrictions();
      startAssignment();
    }

    function setupAssignmentRestrictions() {
      document.addEventListener('visibilitychange', handleVisibilityChange);
      window.addEventListener('beforeunload', handleBeforeUnload);
      document.addEventListener('contextmenu', handleContextMenu);
      document.addEventListener('keydown', handleKeyDown);
      window.addEventListener('blur', handleBlur);
      
      document.body.style.userSelect = 'none';
      
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(err => {
          console.log("Fullscreen not supported:", err);
        });
      }
      
      elements.restrictionIndicator.style.display = 'flex';
      updateRestrictionIndicator();
    }

    function handleVisibilityChange() {
      if (document.hidden && assignmentStarted) {
        tabChangeCount++;
        updateRestrictionIndicator();
        handleLeaveAttempt();
        
        if (tabChangeCount >= MAX_TAB_CHANGES) {
          showNotification(`You have exceeded the maximum allowed tab changes (${MAX_TAB_CHANGES}). Submitting assignment automatically.`, 'warning');
          setTimeout(() => {
            submitAssignment();
          }, 2000);
        }
      }
    }

    function handleBeforeUnload(e) {
      if (assignmentStarted) {
        e.preventDefault();
        e.returnValue = 'Assignment in progress. Leaving may cause loss of unsaved progress.';
        return e.returnValue;
      }
    }

    function handleContextMenu(e) {
      if (assignmentStarted) {
        e.preventDefault();
        showNotification('Right-click is disabled during the assignment', 'warning');
      }
    }

    function handleKeyDown(e) {
      if (assignmentStarted) {
        if (e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j')) ||
            (e.ctrlKey && (e.key === 'U' || e.key === 'u'))) {
          e.preventDefault();
          handleLeaveAttempt();
        }
      }
    }

    function handleBlur() {
      if (assignmentStarted) {
        handleLeaveAttempt();
      }
    }

    function updateRestrictionIndicator() {
      const remaining = MAX_TAB_CHANGES - tabChangeCount;
      elements.restrictionIndicator.innerHTML = `
        <i class="fas fa-shield-alt"></i> Assignment Mode Active - ${remaining} tab ${remaining === 1 ? 'change' : 'changes'} remaining
      `;
    }

    function removeAssignmentRestrictions() {
      assignmentStarted = false;
      
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      window.removeEventListener('beforeunload', handleBeforeUnload);
      document.removeEventListener('contextmenu', handleContextMenu);
      document.removeEventListener('keydown', handleKeyDown);
      window.removeEventListener('blur', handleBlur);
      
      document.body.style.userSelect = '';
      
      if (document.fullscreenElement) {
        document.exitFullscreen().catch(err => {
          console.log("Error exiting fullscreen:", err);
        });
      }
      
      elements.restrictionIndicator.style.display = 'none';
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'warning' ? 'rgba(220, 53, 69, 0.9)' : 'rgba(255, 158, 0, 0.9)'};
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        z-index: 1001;
        font-weight: 500;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      `;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function handleLeaveAttempt() {
      const remainingAttempts = MAX_TAB_CHANGES - tabChangeCount;
      elements.assignmentWarningMessage.textContent = `Warning! Leaving the assignment may cause loss of unsaved progress.`;
      elements.remainingAttempts.textContent = `You have ${remainingAttempts} ${remainingAttempts === 1 ? 'attempt' : 'attempts'} remaining before automatic submission.`;
      elements.assignmentWarningModal.classList.add('active');
    }

    function startAssignment() {
      assignmentStarted = true;
      tabChangeCount = 0; // Reset counter
      updateRestrictionIndicator();
      showQuestion(0);
    }

    function startDeadlineTimer() {
      deadlineTimer = setInterval(() => {
        timeUntilDeadline--;
        
        elements.deadlineDisplay.textContent = formatTime(timeUntilDeadline);
        
        if (timeUntilDeadline <= 3600) {
          elements.assignmentDeadline.classList.add('critical');
          elements.assignmentDeadline.classList.remove('warning');
        } else if (timeUntilDeadline <= 86400) {
          elements.assignmentDeadline.classList.add('warning');
          elements.assignmentDeadline.classList.remove('critical');
        } else {
          elements.assignmentDeadline.classList.remove('warning', 'critical');
        }
        
        if (timeUntilDeadline <= 0) {
          clearInterval(deadlineTimer);
          autoSubmitAssignment();
        }
      }, 1000);
    }

    function formatTime(seconds) {
      if (seconds < 0) return "DEADLINE PASSED";
      
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const remainingSeconds = seconds % 60;
      
      if (days > 0) {
        return `${days}d ${hours}h ${minutes}m`;
      } else if (hours > 0) {
        return `${hours}h ${minutes}m ${remainingSeconds}s`;
      } else {
        return `${minutes}m ${remainingSeconds}s`;
      }
    }

    function showQuestion(index) {
      if (index < 0 || index >= assignmentQuestions.length) return;
      
      currentQuestionIndex = index;
      const question = assignmentQuestions[index];
      
      let questionHTML = `
        <div class="assignment-question" data-question-id="${question.id}">
          <div class="question-header">
            <div class="question-text">${index + 1}. ${question.question}</div>
            <div class="question-points">${question.points || 10} point(s)</div>
          </div>
      `;
      
      if (question.description) {
        questionHTML += `<div class="question-description">${question.description}</div>`;
      }
      
      if (question.type === 'single_choice' || question.type === 'mcq' || question.type === 'options') {
        questionHTML += `<div class="question-options">`;
        
        question.options.forEach((option, optionIndex) => {
          const isChecked = userAssignmentAnswers[index] && userAssignmentAnswers[index].answer === optionIndex;
          questionHTML += `
            <div class="option-item ${isChecked ? 'selected' : ''}" data-option-index="${optionIndex}">
              <input 
                type="radio" 
                id="option-${question.id}-${optionIndex}" 
                name="question-${question.id}" 
                value="${optionIndex}"
                ${isChecked ? 'checked' : ''}
              >
              <label for="option-${question.id}-${optionIndex}">${option}</label>
            </div>
          `;
        });
        
        questionHTML += `</div>`;
      } else if (question.type === 'multiple_choice') {
        questionHTML += `<div class="question-options">`;
        
        question.options.forEach((option, optionIndex) => {
          const isChecked = userAssignmentAnswers[index] && 
                           Array.isArray(userAssignmentAnswers[index].answer) && 
                           userAssignmentAnswers[index].answer.includes(optionIndex);
          questionHTML += `
            <div class="option-item ${isChecked ? 'selected' : ''}" data-option-index="${optionIndex}">
              <input 
                type="checkbox" 
                id="option-${question.id}-${optionIndex}" 
                name="question-${question.id}" 
                value="${optionIndex}"
                ${isChecked ? 'checked' : ''}
              >
              <label for="option-${question.id}-${optionIndex}">${option}</label>
            </div>
          `;
        });
        
        questionHTML += `</div>`;
      } else if (question.type === 'text_answer' || question.type === 'paragraph') {
        const answerText = userAssignmentAnswers[index] ? userAssignmentAnswers[index].answer : '';
        questionHTML += `
          <div class="text-answer-section">
            <label class="text-answer-label">Your Answer:</label>
            <textarea 
              class="text-answer-area" 
              id="answer-${question.id}" 
              placeholder="Type your detailed answer here..."
            >${answerText}</textarea>
            <div class="text-answer-tools">
              <div class="text-answer-stats">
                <span>Words: <span class="word-count-display" id="word-count-${question.id}">${answerText ? answerText.split(/\s+/).filter(w => w.length > 0).length : 0}</span></span>
                <span>Characters: <span class="char-count-display" id="char-count-${question.id}">${answerText.length}</span></span>
              </div>
              <div class="text-answer-actions">
                <button class="btn-tool" id="clear-answer-${question.id}">
                  <i class="fas fa-eraser"></i> Clear
                </button>
                <button class="btn-tool" id="spellcheck-${question.id}">
                  <i class="fas fa-spell-check"></i> Spell Check
                </button>
              </div>
            </div>
          </div>
        `;
      } else if (question.type === 'rich_text') {
        const answerText = userAssignmentAnswers[index] ? userAssignmentAnswers[index].answer : '';
        questionHTML += `
          <div class="text-answer-section">
            <label class="text-answer-label">Your Answer:</label>
            <div class="rich-text-toolbar" id="toolbar-${question.id}">
              <button class="rich-text-btn" data-command="bold" title="Bold"><i class="fas fa-bold"></i></button>
              <button class="rich-text-btn" data-command="italic" title="Italic"><i class="fas fa-italic"></i></button>
              <button class="rich-text-btn" data-command="underline" title="Underline"><i class="fas fa-underline"></i></button>
              <button class="rich-text-btn" data-command="insertUnorderedList" title="Bullet List"><i class="fas fa-list-ul"></i></button>
              <button class="rich-text-btn" data-command="insertOrderedList" title="Numbered List"><i class="fas fa-list-ol"></i></button>
              <button class="rich-text-btn" data-command="formatBlock" data-value="h3" title="Heading"><i class="fas fa-heading"></i></button>
              <button class="rich-text-btn" data-command="formatBlock" data-value="blockquote" title="Quote"><i class="fas fa-quote-right"></i></button>
              <button class="rich-text-btn" data-command="insertHorizontalRule" title="Horizontal Line"><i class="fas fa-minus"></i></button>
              <button class="rich-text-btn" id="clear-format-${question.id}" title="Clear Formatting"><i class="fas fa-remove-format"></i></button>
            </div>
            <div 
              class="rich-text-editor" 
              id="answer-${question.id}" 
              contenteditable="true"
            >${answerText}</div>
            <div class="text-answer-tools">
              <div class="text-answer-stats">
                <span>Words: <span class="word-count-display" id="word-count-${question.id}">${answerText ? answerText.replace(/<[^>]*>/g, '').split(/\s+/).filter(w => w.length > 0).length : 0}</span></span>
                <span>Characters: <span class="char-count-display" id="char-count-${question.id}">${answerText ? answerText.replace(/<[^>]*>/g, '').length : 0}</span></span>
              </div>
            </div>
          </div>
        `;
      } else if (question.type === 'code') {
        const answerText = userAssignmentAnswers[index] ? userAssignmentAnswers[index].answer : '';
        questionHTML += `
          <textarea 
            class="text-answer code-answer" 
            id="answer-${question.id}" 
            placeholder="Write your code here..."
            spellcheck="false"
          >${answerText}</textarea>
          <div class="code-formatting">
            <button class="btn-format" data-target="answer-${question.id}">
              <i class="fas fa-code"></i> Format Code
            </button>
          </div>
        `;
      } else if (question.type === 'file_upload') {
        const fileName = userAssignmentAnswers[index] ? userAssignmentAnswers[index].fileName : '';
        questionHTML += `
          <div class="file-upload-area" id="file-upload-${question.id}">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click to upload or drag and drop</p>
            <p class="file-name" id="file-name-${question.id}">${fileName || 'No file selected'}</p>
            <input type="file" class="file-input" id="file-input-${question.id}">
          </div>
        `;
      }
      
      questionHTML += `</div>`;
      
      elements.assignmentQuestionsContainer.innerHTML = questionHTML;
      elements.assignmentProgress.textContent = `Question ${index + 1} of ${assignmentQuestions.length}`;
      
      elements.prevQuestionButton.disabled = index === 0;
      elements.nextQuestionButton.style.display = index < assignmentQuestions.length - 1 ? 'flex' : 'none';
      elements.saveAssignmentButton.style.display = 'flex';
      elements.submitAssignmentButton.style.display = index === assignmentQuestions.length - 1 ? 'flex' : 'none';
      
      addQuestionEventListeners(question, index);
    }

    function addQuestionEventListeners(question, questionIndex) {
      // Multiple choice event listeners
      document.querySelectorAll('.option-item').forEach(item => {
        item.addEventListener('click', function() {
          const input = this.querySelector('input');
          if (input.type === 'radio') {
            document.querySelectorAll(`input[name="${input.name}"]`).forEach(radio => {
              radio.checked = false;
              radio.closest('.option-item').classList.remove('selected');
            });
            input.checked = true;
            this.classList.add('selected');
          } else if (input.type === 'checkbox') {
            input.checked = !input.checked;
            this.classList.toggle('selected', input.checked);
          }
          saveAnswer(questionIndex);
        });
      });
      
      // Text answer event listeners
      const textAnswer = document.getElementById(`answer-${question.id}`);
      if (textAnswer && (question.type === 'text_answer' || question.type === 'paragraph')) {
        let timeoutId;
        textAnswer.addEventListener('input', function() {
          if (timeoutId) clearTimeout(timeoutId);
          
          const text = this.value;
          const wordCount = text.split(/\s+/).filter(w => w.length > 0).length;
          const charCount = text.length;
          
          const wordCountEl = document.getElementById(`word-count-${question.id}`);
          const charCountEl = document.getElementById(`char-count-${question.id}`);
          
          if (wordCountEl) wordCountEl.textContent = wordCount;
          if (charCountEl) charCountEl.textContent = charCount;
          
          timeoutId = setTimeout(() => saveAnswer(questionIndex), 1000);
        });
        
        // Clear button - with confirmation
        const clearBtn = document.getElementById(`clear-answer-${question.id}`);
        if (clearBtn) {
          clearBtn.addEventListener('click', function() {
            // Show confirmation dialog
            const confirmation = confirm('Are you sure you want to clear your answer? This action cannot be undone.');
            if (confirmation) {
              textAnswer.value = '';
              document.getElementById(`word-count-${question.id}`).textContent = '0';
              document.getElementById(`char-count-${question.id}`).textContent = '0';
              saveAnswer(questionIndex);
              showNotification('Answer cleared successfully', 'info');
            }
          });
        }
        
        // Spell check button
        const spellCheckBtn = document.getElementById(`spellcheck-${question.id}`);
        if (spellCheckBtn) {
          spellCheckBtn.addEventListener('click', function() {
            textAnswer.focus();
            document.execCommand('styleWithCSS', false, true);
            document.execCommand('spellCheck', false, null);
            showNotification('Spell check activated', 'info');
          });
        }
      }
      
      // Rich text editor event listeners
      if (question.type === 'rich_text') {
        const editor = document.getElementById(`answer-${question.id}`);
        const toolbar = document.getElementById(`toolbar-${question.id}`);
        
        // Toolbar buttons
        toolbar.querySelectorAll('.rich-text-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const command = this.dataset.command;
            const value = this.dataset.value;
            
            if (command === 'formatBlock') {
              document.execCommand(command, false, value);
            } else if (command) {
              document.execCommand(command, false, null);
            }
            
            editor.focus();
            updateRichTextStats(question.id);
            saveAnswer(questionIndex);
          });
        });
        
        // Clear formatting button
        const clearFormatBtn = document.getElementById(`clear-format-${question.id}`);
        if (clearFormatBtn) {
          clearFormatBtn.addEventListener('click', function() {
            document.execCommand('removeFormat', false, null);
            document.execCommand('unlink', false, null);
            editor.focus();
            updateRichTextStats(question.id);
            saveAnswer(questionIndex);
          });
        }
        
        // Editor content changes
        let timeoutId;
        editor.addEventListener('input', function() {
          if (timeoutId) clearTimeout(timeoutId);
          timeoutId = setTimeout(() => {
            updateRichTextStats(question.id);
            saveAnswer(questionIndex);
          }, 1000);
        });
        
        // Initial stats update
        updateRichTextStats(question.id);
      }
      
      // Code formatting
      const formatButton = document.querySelector('.btn-format');
      if (formatButton) {
        formatButton.addEventListener('click', function() {
          const targetId = this.getAttribute('data-target');
          const textarea = document.getElementById(targetId);
          if (textarea) formatCode(textarea);
        });
      }
      
      // File upload
      const fileUploadArea = document.getElementById(`file-upload-${question.id}`);
      const fileInput = document.getElementById(`file-input-${question.id}`);
      const fileName = document.getElementById(`file-name-${question.id}`);
      
      if (fileUploadArea && fileInput && fileName) {
        fileUploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', () => {
          if (fileInput.files.length > 0) {
            fileName.textContent = fileInput.files[0].name;
            saveFileAnswer(questionIndex, fileInput.files[0]);
          }
        });
      }
    }

    function updateRichTextStats(questionId) {
      const editor = document.getElementById(`answer-${questionId}`);
      if (!editor) return;
      
      const text = editor.innerText || editor.textContent;
      const wordCount = text.split(/\s+/).filter(w => w.length > 0).length;
      const charCount = text.length;
      
      const wordCountEl = document.getElementById(`word-count-${questionId}`);
      const charCountEl = document.getElementById(`char-count-${questionId}`);
      
      if (wordCountEl) wordCountEl.textContent = wordCount;
      if (charCountEl) charCountEl.textContent = charCount;
    }

    function formatCode(textarea) {
      const code = textarea.value;
      const lines = code.split('\n');
      let formattedCode = '';
      let indentLevel = 0;
      
      for (let line of lines) {
        line = line.trim();
        if (line.length === 0) {
          formattedCode += '\n';
          continue;
        }
        
        if (line.includes('}') && !line.includes('{')) {
          indentLevel = Math.max(0, indentLevel - 1);
        }
        
        formattedCode += '  '.repeat(indentLevel) + line + '\n';
        
        if (line.includes('{') && !line.includes('}')) {
          indentLevel++;
        }
      }
      
      textarea.value = formattedCode.trim();
    }

    function saveAnswer(questionIndex) {
      const question = assignmentQuestions[questionIndex];
      
      if (!userAssignmentAnswers[questionIndex]) {
        userAssignmentAnswers[questionIndex] = { questionId: question.id };
      }
      
      if (question.type === 'single_choice' || question.type === 'mcq' || question.type === 'options') {
        const selected = document.querySelector(`input[name="question-${question.id}"]:checked`);
        if (selected) {
          userAssignmentAnswers[questionIndex].answer = parseInt(selected.value);
        }
      } else if (question.type === 'multiple_choice') {
        const selected = document.querySelectorAll(`input[name="question-${question.id}"]:checked`);
        userAssignmentAnswers[questionIndex].answer = Array.from(selected).map(opt => parseInt(opt.value));
      } else if (question.type === 'text_answer' || question.type === 'paragraph') {
        const textarea = document.getElementById(`answer-${question.id}`);
        userAssignmentAnswers[questionIndex].answer = textarea ? textarea.value : '';
      } else if (question.type === 'rich_text') {
        const editor = document.getElementById(`answer-${question.id}`);
        userAssignmentAnswers[questionIndex].answer = editor ? editor.innerHTML : '';
      } else if (question.type === 'code') {
        const textarea = document.getElementById(`answer-${question.id}`);
        userAssignmentAnswers[questionIndex].answer = textarea ? textarea.value : '';
      }
    }

    function saveFileAnswer(questionIndex, file) {
      const question = assignmentQuestions[questionIndex];
      
      if (!userAssignmentAnswers[questionIndex]) {
        userAssignmentAnswers[questionIndex] = { questionId: question.id };
      }
      
      userAssignmentAnswers[questionIndex].fileName = file.name;
      userAssignmentAnswers[questionIndex].fileSize = file.size;
      userAssignmentAnswers[questionIndex].fileType = file.type;
    }

    function showPreviousQuestion() {
      if (currentQuestionIndex > 0) {
        saveAnswer(currentQuestionIndex);
        showQuestion(currentQuestionIndex - 1);
      }
    }

    function showNextQuestion() {
      if (currentQuestionIndex < assignmentQuestions.length - 1) {
        saveAnswer(currentQuestionIndex);
        showQuestion(currentQuestionIndex + 1);
      }
    }

    async function saveAssignmentProgress() {
      try {
        saveAnswer(currentQuestionIndex);
        
        const userRef = doc(db, "users", currentUser.uid);
        await updateDoc(userRef, {
          [`enrollments.${courseId}.assignments.${assignmentId}.answers`]: userAssignmentAnswers,
          [`enrollments.${courseId}.assignments.${assignmentId}.lastSaved`]: Timestamp.now()
        });
        
        showNotification('Progress saved successfully!', 'info');
      } catch (error) {
        console.error("Error saving assignment progress:", error);
        showNotification('Error saving progress. Please try again.', 'warning');
      }
    }

    function autoSubmitAssignment() {
      elements.successMessage.textContent = 'Assignment automatically submitted!';
      submitAssignment();
    }

    async function updateAssignmentSubmission() {
      if (!currentUser || !courseId || !assignmentId) return;
      
      try {
        const userRef = doc(db, "users", currentUser.uid);
        await updateDoc(userRef, {
          [`enrollments.${courseId}.assignments.${assignmentId}.submitted`]: true,
          [`enrollments.${courseId}.assignments.${assignmentId}.submittedAt`]: Timestamp.now()
        });
      } catch (error) {
        console.error("Error updating assignment submission:", error);
      }
    }

    async function submitAssignment() {
      try {
        if (deadlineTimer) {
          clearInterval(deadlineTimer);
          deadlineTimer = null;
        }
        
        removeAssignmentRestrictions();
        saveAnswer(currentQuestionIndex);
        
        await saveAssignmentSubmission();
        await updateAssignmentSubmission();
        
        // Show submission success modal with checkmark animation
        elements.submissionSuccessModal.classList.add('active');
        
        // Set up redirect countdown
        let countdown = 5;
        const countdownElement = document.getElementById('countdown');
        countdownElement.textContent = countdown;
        
        const countdownInterval = setInterval(() => {
          countdown--;
          countdownElement.textContent = countdown;
          
          if (countdown <= 0) {
            clearInterval(countdownInterval);
            redirectToCourseDetails();
          }
        }, 1000);
        
      } catch (error) {
        console.error("Error submitting assignment:", error);
        alert('Error submitting assignment. Please try again.');
      }
    }

    function redirectToCourseDetails() {
      // Get the course ID from your assignment page
      const courseId = urlParams.get("courseId") || "course1";
      
      // Redirect to course details page with the correct parameter
      window.location.href = `coursedetails.html?id=${courseId}`;
    }

    async function saveAssignmentSubmission() {
      try {
        const teacherId = courseData?.teacherId || "default-teacher";
        const teacherName = courseData?.teacherName || "Unknown Teacher";
        
        // Transform answers to match your desired format
        const formattedAnswers = userAssignmentAnswers.map((answer, index) => {
          if (!answer) return null;
          
          const question = assignmentQuestions[index];
          
          // Create the answer object in your specified format
          const formattedAnswer = {
            answer: answer.answer !== undefined ? answer.answer : "",
            points: question.points || 20,
            questionId: answer.questionId || question.id || `question${index + 1}`,
            questionText: question.question || "",
            questionType: question.type || "text_answer"
          };
          
          return formattedAnswer;
        }).filter(a => a !== null);
        
        // Create submission data in your exact format
        const assignmentSubmissionData = {
          answers: formattedAnswers,
          assignmentId: assignmentId || "",
          assignmentTitle: assignmentData?.title || "Assignment-1",
          courseId: courseId || "",
          courseName: courseData?.name || "HTML Basics",
          deadline: assignmentData?.deadline || null,
          evaluated: false,
          feedback: "",
          teacherId: teacherId,
          teacherName: teacherName, // Add teacher name here
          score: 0,
          status: "pending_evaluation",
          studentEmail: currentUser.email || "",
          studentId: currentUser.uid || "",
          studentName: currentUser.displayName || currentUser.email || "Unknown Student",
          submittedAt: Timestamp.now(),
          totalPoints: assignmentQuestions.reduce((sum, q) => sum + (q.points || 20), 0)
        };
        
        // Use a unique submission ID instead of just teacherId to avoid overwriting
        const submissionId = `${teacherId}_${assignmentId}_${currentUser.uid}_${Date.now()}`;
        
        // Save to the "Submissions" collection
        const assignmentSubmissionRef = doc(db, "submissions", submissionId);
        await setDoc(assignmentSubmissionRef, assignmentSubmissionData);
        
        console.log("Assignment submitted successfully with teacher:", teacherName);
        
        // Also save to teacher's personal submissions collection
        try {
          const teacherSubmissionRef = doc(db, "teachers", teacherId, "submissions", `${assignmentId}_${currentUser.uid}`);
          await setDoc(teacherSubmissionRef, assignmentSubmissionData);
          
          console.log("Submission saved to teacher's personal collection");
        } catch (teacherError) {
          console.error("Error saving to teacher's collection:", teacherError);
          // Continue even if this fails
        }
        
        // Send notification to teacher
        try {
          const teacherRef = doc(db, "teachers", teacherId);
          const teacherSnap = await getDoc(teacherRef);
          
          if (teacherSnap.exists()) {
            const notificationData = {
              id: `${assignmentId}_${currentUser.uid}`,
              type: "assignment_submission",
              title: "New Assignment Submission",
              message: `${currentUser.displayName || currentUser.email} submitted the assignment "${assignmentData?.title || 'an assignment'}" for ${courseData?.name || 'a course'}`,
              courseId: courseId,
              assignmentId: assignmentId,
              studentId: currentUser.uid,
              studentName: currentUser.displayName || currentUser.email,
              submissionId: submissionId,
              timestamp: Timestamp.now(),
              read: false
            };
            
            await updateDoc(teacherRef, {
              notifications: arrayUnion(notificationData)
            });
            
            console.log("Notification sent to teacher:", teacherName);
          } else {
            console.warn("Teacher document not found:", teacherId);
          }
        } catch (notifError) {
          console.error("Error sending notification to teacher:", notifError);
          // Don't throw - submission was successful even if notification failed
        }
        
      } catch (error) {
        console.error("Error saving assignment submission:", error);
        throw error;
      }
    }

    initAssignmentPage();
  </script>
</body>
</html>